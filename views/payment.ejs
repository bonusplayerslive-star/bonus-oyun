// Path: views\payment.ejs
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL Satın Al - Güvenli Ödeme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0f0f0f; color: #fff; padding-top: 50px; font-family: 'Courier New', monospace; }
        .neon-border { border: 1px solid #39FF14; box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); background: rgba(0,0,0,0.8); border-radius: 20px; }
        .text-neon { color: #39FF14; text-shadow: 0 0 5px #39FF14; }
        
        .package-card {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 15px;
            transition: 0.3s;
            cursor: pointer;
        }
        .package-card:hover {
            border-color: #39FF14;
            transform: translateY(-10px);
            background: rgba(57, 255, 20, 0.05);
        }
        .price-tag { font-size: 2rem; font-weight: bold; color: #fff; }
        .bpl-amount { color: #39FF14; font-size: 1.5rem; }
        
        .bep20-badge {
            background: #ff0000;
            color: #fff;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        /* TxID Giriş Alanı Tasarımı */
        .tx-input-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px dashed #39FF14;
        }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="text-center mb-5">
        <div class="bep20-badge">SADECE USDT (BEP20)</div>
        <h1 class="text-neon fw-bold">BPL MARKETİ</h1>
        <p class="text-muted">Paketinizi seçin, ödemeyi yapın ve işlem numaranızı (TxID) girin.</p>
    </div>

    <div class="row mb-5">
        <div class="col-md-3 mb-4">
            <div class="package-card p-4 text-center h-100" onclick="selectPackage(1, 100)">
                <div class="bpl-amount">100 BPL</div>
                <div class="price-tag">1$</div>
                <small class="text-muted">Standart Paket</small>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="package-card p-4 text-center h-100 border-info" onclick="selectPackage(4, 500)">
                <div class="bpl-amount">500 BPL</div>
                <div class="price-tag">4$</div>
                <small class="text-info">%20 İndirimli</small>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="package-card p-4 text-center h-100 border-warning" onclick="selectPackage(7, 1000)">
                <div class="bpl-amount">1000 BPL</div>
                <div class="price-tag">7$</div>
                <small class="text-warning">%30 İndirimli</small>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="package-card p-4 text-center h-100 border-danger" onclick="selectPackage(33, 5000)">
                <div class="bpl-amount">5000 BPL</div>
                <div class="price-tag">33$</div>
                <small class="text-danger">%34 Fırsat!</small>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="neon-border p-4">
                <h4 class="text-neon mb-4 text-center">ÖDEME BİLDİRİMİ</h4>
                
                <div class="alert alert-dark border-secondary small mb-4">
                    <strong>1. Adım:</strong> Aşağıdaki adrese seçtiğiniz paketin tutarı kadar USDT (BEP20) gönderin.<br>
                    <strong>2. Adım:</strong> Transfer başarılı olduktan sonra "TxID" kodunu buraya yapıştırın.
                </div>

                <div class="mb-4 text-center">
                    <label class="text-muted small d-block">Şirket USDT (BEP20) Cüzdan Adresi:</label>
                    <code class="h5 text-white bg-dark p-2 d-block rounded mt-2">0x9f63e92E8B316b7119b4586998966dF4446Dc754</code>
                </div>

                <div class="tx-input-group">
                    <div class="mb-3">
                        <label class="form-label">Seçilen Paket:</label>
                        <input type="text" id="displayPackage" class="form-control bg-dark text-warning fw-bold" readonly value="Lütfen yukarıdan paket seçin">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">İşlem Numarası (TxID):</label>
                        <input type="text" id="txidInput" class="form-control bg-dark text-white border-success" placeholder="0x...">
                        <small class="text-muted">BSCScan üzerindeki Transaction Hash kodudur.</small>
                    </div>
                    <button onclick="submitPayment()" class="btn btn-neon w-100 py-3">ÖDEMEYİ DOĞRULA VE BPL AL</button>
                </div>
                
                <div class="text-center mt-3">
                    <a href="/wallet?id=<%= user.id %>" class="text-muted small text-decoration-none">← Cüzdana Geri Dön</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedUSD = 0;
    let selectedBPL = 0;

    function selectPackage(usd, bpl) {
        selectedUSD = usd;
        selectedBPL = bpl;
        document.getElementById('displayPackage').value = `${bpl} BPL - (${usd} USDT)`;
        // Görsel geri bildirim
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function submitPayment() {
        const txid = document.getElementById('txidInput').value.trim();
        
        if (selectedUSD === 0) return alert("Lütfen önce bir paket seçin!");
        if (txid.length < 10) return alert("Lütfen geçerli bir TxID (Transaction Hash) girin!");

        // API'ye gönderim
        fetch('/verify-payment', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `userId=<%= user.id %>&txid=${txid}&usd=${selectedUSD}&bpl=${selectedBPL}`
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                alert("Tebrikler! Ödemeniz alındı ve BPL hesabınıza yüklendi.");
                window.location.href = '/wallet?id=<%= user.id %>';
            } else {
                alert("Hata: " + data.msg);
            }
        })
        .catch(err => alert("Bir sistem hatası oluştu!"));
    }
</script>

</body>
</html>