// Path: views\market.ejs
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL Market - Karakter Mağazası</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #ffffff; font-family: 'Segoe UI', sans-serif; }
        .navbar-bpl { border-bottom: 2px solid #39FF14; background: rgba(0, 0, 0, 0.9); padding: 10px 20px; }
        .neon-text { color: #39FF14; text-shadow: 0 0 10px #39FF14; }
        .neon-border { border: 1px solid #39FF14; box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); transition: 0.3s; }
        .neon-border:hover { box-shadow: 0 0 25px rgba(57, 255, 20, 0.5); transform: translateY(-5px); }
        .card { background: #111; border-radius: 15px; overflow: hidden; border: none; }
        .animal-img { width: 100%; height: 220px; object-fit: cover; border-bottom: 1px solid #333; }
        .price-tag { font-size: 1.4rem; font-weight: bold; color: #ffc107; margin: 10px 0; }
        .btn-buy { background: transparent; border: 2px solid #39FF14; color: #39FF14; font-weight: bold; transition: 0.3s; }
        .btn-buy:hover { background: #39FF14; color: #000; }
        .section-title { border-left: 5px solid #39FF14; padding-left: 15px; margin: 40px 0 25px 0; text-transform: uppercase; }
        
        /* Güç Göstergeleri */
        .stat-bar { height: 6px; background: #222; border-radius: 3px; margin-bottom: 8px; }
        .stat-fill { height: 100%; border-radius: 3px; }
        .stat-label { font-size: 0.75rem; color: #aaa; text-align: left; margin-bottom: 2px; }
    </style>
</head>
<body>

<nav class="navbar navbar-bpl sticky-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center" href="/profil?id=<%= user.id %>">
            <img src="/caracter/page/logo.JPEG" alt="BPL Logo" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 5px;">
            <span class="neon-text fw-bold h4 mb-0">BPL MARKET</span>
        </a>
        <div class="d-flex align-items-center">
            <span class="h5 me-4 mb-0">Bakiyeniz: <strong class="text-warning" id="balanceDisplay"><%= user.bpl %> BPL</strong></span>
            <a href="/profil?id=<%= user.id %>" class="btn btn-outline-light btn-sm px-4">Profile Dön</a>
        </div>
    </div>
</nav>

<div class="container pb-5">
    
    <h3 class="section-title neon-text">Efsanevi Hayvanlar (5000 BPL)</h3>
    <div class="row g-4">
        <% 
        // Klasördeki büyük harf dosya isimlerine göre düzenlendi
        const efsanevi = [
            {ad: 'Aslan', dosya: 'Lion.jpg', fiyat: 5000, hp: 150, atk: 90},
            {ad: 'Gergedan', dosya: 'Rhino.jpg', fiyat: 5000, hp: 200, atk: 60},
            {ad: 'Goril', dosya: 'Gorilla.jpg', fiyat: 5000, hp: 160, atk: 85},
            {ad: 'Kaplan', dosya: 'Tiger.jpg', fiyat: 5000, hp: 140, atk: 95}
        ]; 
        %>
        <% efsanevi.forEach(animal => { %>
            <div class="col-md-3">
                <div class="card neon-border h-100">
                    <img src="/caracter/profile/<%= animal.dosya %>" class="animal-img" alt="<%= animal.ad %>" onerror="this.src='/caracter/page/welcome.jpg'">
                    <div class="card-body text-center">
                        <h4 class="card-title text-white"><%= animal.ad %></h4>
                        
                        <div class="stats-box my-3">
                            <div class="stat-label">SALDIRI: <%= animal.atk %></div>
                            <div class="stat-bar"><div class="stat-fill" style="width: <%= (animal.atk/100)*100 %>%; background: #ff4444;"></div></div>
                            <div class="stat-label">HP (CAN): <%= animal.hp %></div>
                            <div class="stat-bar"><div class="stat-fill" style="width: <%= (animal.hp/200)*100 %>%; background: #00C851;"></div></div>
                        </div>

                        <div class="price-tag"><%= animal.fiyat %> BPL</div>
                        <button onclick="buyAnimal('<%= animal.ad %>', <%= animal.fiyat %>)" class="btn btn-buy w-100">SATIN AL</button>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>

    <h3 class="section-title text-info" style="border-left-color: #0dcaf0;">Vahşi Hayvanlar (1000 BPL)</h3>
    <div class="row g-4">
        <% 
        // Vahşi hayvanlar klasördeki dosya isimlerine göre (Bear, Crocodile, vb.) güncellendi
        const vahsi = [
            {ad: 'Ayı', dosya: 'Bear.jpg', fiyat: 1000, hp: 110, atk: 45},
            {ad: 'Gökdoğan', dosya: 'Peregrinefalcon.jpg', fiyat: 1000, hp: 80, atk: 65},
            {ad: 'Kartal', dosya: 'Eagle.jpg', fiyat: 1000, hp: 85, atk: 60},
            {ad: 'Timsah', dosya: 'Crocodile.jpg', fiyat: 1000, hp: 120, atk: 50},
            {ad: 'Yılan', dosya: 'Snake.jpg', fiyat: 1000, hp: 70, atk: 75},
            {ad: 'Kurt', dosya: 'Kurd.jpg', fiyat: 1000, hp: 90, atk: 55}
        ]; 
        %>
        <% vahsi.forEach(animal => { %>
            <div class="col-md-4">
                <div class="card border-secondary h-100" style="background: #0a0a0a;">
                    <img src="/caracter/profile/<%= animal.dosya %>" class="animal-img" alt="<%= animal.ad %>" onerror="this.src='/caracter/page/welcome.jpg'">
                    <div class="card-body text-center">
                        <h4 class="card-title text-white text-uppercase"><%= animal.ad %></h4>
                        
                        <div class="stats-box my-3">
                            <div class="stat-label">GÜÇ DENGESİ</div>
                            <div class="stat-bar"><div class="stat-fill" style="width: <%= (animal.atk/100)*100 %>%; background: #33b5e5;"></div></div>
                        </div>

                        <div class="price-tag text-info" style="font-size: 1.1rem;"><%= animal.fiyat %> BPL</div>
                        <button onclick="buyAnimal('<%= animal.ad %>', <%= animal.fiyat %>)" class="btn btn-outline-info w-100">SATIN AL</button>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>
</div>

<script>
    function buyAnimal(animalName, price) {
        const userId = '<%= user.id %>';
        if(!confirm(animalName + ' karakterini ' + price + ' BPL karşılığında satın alıyor musunuz?')) return;

        fetch('/buy-animal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            // URLSearchParams kullanarak daha güvenli veri gönderimi
            body: new URLSearchParams({
                userId: userId,
                animalName: animalName,
                price: price
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                alert('Tebrikler! ' + animalName + ' envanterine eklendi.');
                document.getElementById('balanceDisplay').innerText = data.newBalance + ' BPL';
            } else {
                alert('Hata: ' + (data.msg || 'Bakiye yetersiz!'));
            }
        })
        .catch(err => alert('Sunucu hatası!'));
    }
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io(); // Her sayfada bu bağlantıyı başlatır
    
    // Aktif sayısını her sayfada güncel tutmak için:
    socket.on('update-active-count', (count) => {
        const playerEl = document.getElementById('active-players');
        if(playerEl) playerEl.innerText = count + " OYUNCU";
    });
</script>


</body>

</html>
