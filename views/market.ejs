<script>
    let userBpl = <%= user.bpl %>;
    const inventoryCount = <%= user.inventory.length %>;

    async function buyAnimal(itemName, price) {
        // Ön Kontrol: Envanter Limiti
        if (inventoryCount >= 3) {
            return Swal.fire({
                title: 'KAPASİTE DOLU!',
                text: 'Envanterinde en fazla 3 varlık barındırabilirsin.',
                icon: 'warning',
                background: '#0a0a0a', color: '#fff'
            });
        }

        // Ön Kontrol: Bakiye
        if (userBpl < price) {
            return Swal.fire('YETERSİZ BAKİYE', 'Bu işlem için yeterli BPL yok!', 'error');
        }

        const result = await Swal.fire({
            title: 'SATIN ALMA ONAYI',
            text: `${itemName.toUpperCase()} için ${price} BPL ödeme yapılacak.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#39FF14',
            confirmButtonText: 'ONAYLIYORUM',
            background: '#111', color: '#fff'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch('/api/buy-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemName, price })
                });

                const data = await response.json();
                if (data.success) {
                    Swal.fire({ title: 'BAŞARILI', text: 'Varlık envanterine eklendi.', icon: 'success' })
                        .then(() => location.href = '/profil');
                } else {
                    Swal.fire('HATA', data.error, 'error');
                }
            } catch (err) {
                Swal.fire('HATA', 'Sunucu bağlantısı sağlanamadı.', 'error');
            }
        }
    }
</script>
