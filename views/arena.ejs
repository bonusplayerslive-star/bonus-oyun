<%- include('header') %>

<style>
    /* Arena Atmosferi */
    body {
        background: radial-gradient(circle, #1a1a2e 0%, #0f0f1a 100%) !important;
        color: #fff;
        overflow-x: hidden;
    }

    .arena-main-container {
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    /* BaÅŸlÄ±k Efekti */
    .arena-title {
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 5px;
        text-shadow: 0 0 15px #ffc107;
        font-weight: 900;
        margin-bottom: 40px;
    }

    /* Bahis KartlarÄ± */
    .bet-card {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        cursor: pointer;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin: 10px;
    }

    .bet-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 0 30px var(--glow-color);
        border-color: var(--glow-color);
    }

    /* Renk KodlarÄ± */
    .bet-green { --glow-color: #00ff88; color: #00ff88; }
    .bet-blue { --glow-color: #00d4ff; color: #00d4ff; }
    .bet-gold { --glow-color: #ffcc00; color: #ffcc00; }
    .bet-red { --glow-color: #ff4444; color: #ff4444; }

    /* Video AlanÄ± */
    #battle-area {
        position: relative;
        max-width: 850px;
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        border: 4px solid #ffc107;
        background: #000;
        display: none; 
    }

    .video-overlay-glow {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        box-shadow: inset 0 0 50px rgba(255, 193, 7, 0.4);
        pointer-events: none;
        z-index: 5;
    }

    /* SayaÃ§ Efekti */
    .countdown-number {
        font-size: 120px;
        font-weight: 900;
        background: linear-gradient(to bottom, #fff, #ffc107);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 20px rgba(255,193,7,0.6));
    }

    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        20% { transform: translate(-3px, 0px) rotate(-1deg); }
        40% { transform: translate(3px, 2px) rotate(1deg); }
        60% { transform: translate(-1px, -1px) rotate(1deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
</style>

<div class="arena-main-container">
    <div id="bet-screen" class="w-100 text-center">
        <% if (user.selectedAnimal === 'none' || !user.selectedAnimal) { %>
            <div class="alert alert-warning d-inline-block p-4" style="border-radius: 15px; background: rgba(255,193,7,0.1); border: 1px solid #ffc107;">
                <h4 class="text-warning">Karakter SeÃ§ilmedi!</h4>
                <p>Arenaya girmeden Ã¶nce bir dÃ¶vÃ¼ÅŸÃ§Ã¼ seÃ§melisin.</p>
                <a href="/profil" class="btn btn-warning fw-bold px-4">PROFÄ°LE GÄ°T</a>
            </div>
        <% } else { %>
            <h1 class="arena-title text-warning">ARENA BAHÄ°SÄ°</h1>
            <div class="row justify-content-center px-3">
                <div class="col-6 col-md-2" onclick="startSearch(25, 50)">
                    <div class="bet-card bet-green">
                        <h5 class="fw-bold">BAÅžLANGIÃ‡</h5>
                        <hr style="border-color: inherit;">
                        <h3 class="fw-bold">25 âž” 50</h3>
                        <small>BPL TOKEN</small>
                    </div>
                </div>
                <div class="col-6 col-md-2" onclick="startSearch(35, 100)">
                    <div class="bet-card bet-blue">
                        <h5 class="fw-bold">AMATÃ–R</h5>
                        <hr style="border-color: inherit;">
                        <h3 class="fw-bold">35 âž” 100</h3>
                        <small>BPL TOKEN</small>
                    </div>
                </div>
                <div class="col-6 col-md-2" onclick="startSearch(75, 200)">
                    <div class="bet-card bet-gold">
                        <h5 class="fw-bold">PROFESYONEL</h5>
                        <hr style="border-color: inherit;">
                        <h3 class="fw-bold">75 âž” 200</h3>
                        <small>BPL TOKEN</small>
                    </div>
                </div>
                <div class="col-6 col-md-2" onclick="startSearch(120, 450)">
                    <div class="bet-card bet-red">
                        <h5 class="fw-bold">EFSANE</h5>
                        <hr style="border-color: inherit;">
                        <h3 class="fw-bold">120 âž” 450</h3>
                        <small>BPL TOKEN</small>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <div id="wait-screen" class="text-center" style="display: none;">
        <div class="countdown-number" id="timer">10</div>
        <h2 class="text-white mt-3 fw-bold">RAKÄ°P ARANIYOR...</h2>
        <div class="spinner-border text-warning mt-3" style="width: 3rem; height: 3rem;" role="status"></div>
    </div>

    <div id="battle-area">
        <div class="video-overlay-glow"></div>
        <div id="battle-content"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();

    function startSearch(bet, prize) {
        const currentBpl = parseInt("<%= user.bpl %>");
        if (currentBpl < bet) {
            Swal.fire({
                icon: 'error',
                title: 'Yetersiz Bakiye',
                text: 'En az ' + bet + ' BPL gerekiyor!',
                background: '#1a1a2e',
                color: '#fff'
            });
            return;
        }

        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        
        socket.emit('arena-join-queue', { bet: bet, prize: prize });

        let count = 10;
        const countdown = setInterval(() => {
            count--;
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.innerText = count;
            if(count <= 0) clearInterval(countdown);
        }, 1000);
    }

    socket.on('arena-match-found', (data) => {
        console.log("MaÃ§ Verisi:", data);
        
        // Ekran sarsÄ±ntÄ±sÄ± efekti
        document.body.style.animation = "shake 0.5s ease-in-out";
        
        const waitScreen = document.getElementById('wait-screen');
        const battleArea = document.getElementById('battle-area');
        const battleContent = document.getElementById('battle-content');

        waitScreen.style.display = 'none';
        battleArea.style.display = 'block';

        // 1. DÃœZELTME: [object Object] hatasÄ±nÄ± engellemek iÃ§in rakip ismini temizle
        const opponentNick = (typeof data.opponent === 'object') ? (data.opponent.nickname || "Rakip") : data.opponent;

        // 2. DÃœZELTME: KlasÃ¶r ve Dosya Ä°simleri (GitHub'daki gibi BÃ¼yÃ¼k Harf hassasiyeti)
        let animalName = (typeof data.winnerAnimal === 'object') ? data.winnerAnimal.name : data.winnerAnimal;
        
        // EÄŸer veritabanÄ±nda 'peregrinefalcon' kÃ¼Ã§Ã¼kse ama klasÃ¶rÃ¼n 'Peregrinefalcon' ise burayÄ± eÅŸle:
        if (animalName === 'peregrinefalcon') animalName = 'Peregrinefalcon';
        if (animalName === 'falcon') animalName = 'Falcon';
        if (animalName === 'kurd' || animalName === 'kurt') animalName = 'Kurd';
        if (animalName === 'lion') animalName = 'Lion';
        
        const finalAnimal = (animalName && animalName !== 'none') ? animalName : 'Lion';

        battleContent.innerHTML = `
            <div style="position: relative; z-index: 10; padding: 20px;">
                <h2 style="color: #ffc107; font-weight: 900; text-shadow: 0 0 15px rgba(255,193,7,0.5);">ðŸ”¥ SAVAÅž BAÅžLADI ðŸ”¥</h2>
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-danger p-2" style="font-size:1rem;">RAKÄ°P: ${opponentNick}</span>
                    <span class="badge bg-success p-2" style="font-size:1rem;">Ã–DÃœL: ${data.prize} BPL</span>
                </div>
                <video id="battle-video" autoplay playsinline style="width:100%; border-radius:10px; border: 2px solid gold;">
                    <source src="/caracter/move/${finalAnimal}/${finalAnimal}.mp4" type="video/mp4">
                    TarayÄ±cÄ±nÄ±z video desteÄŸi sunmuyor.
                </video>
                <div id="result-overlay" style="display:none; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top:15px;">
                    <h1 class="text-warning fw-bold">KAZANAN</h1>
                    <h2 class="text-white" style="text-shadow: 0 0 10px #00ff00;">${data.winnerNick}</h2>
                </div>
            </div>
        `;

        const video = document.getElementById('battle-video');
        
        // Video Bulunamazsa VarsayÄ±lan Video (Hata Ã–nleyici)
        video.onerror = function() {
            console.error("Video bulunamadÄ±, Lion yÃ¼kleniyor...");
            video.src = "/caracter/move/Lion/Lion.mp4";
        };

        video.onended = () => {
            document.getElementById('result-overlay').style.display = 'block';
            setTimeout(() => {
                window.location.reload();
            }, 4000);
        };
    });

    const currentRoom = "arena";
</script>
