// Path: views\arena.ejs
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL ARENA | ÖLÜMCÜL KARŞILAŞMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="http://localhost:3001/socket.io/socket.io.js"></script>
    
    <style>
        :root { --neon-green: #39FF14; --neon-red: #ff003c; --neon-yellow: #ffc107; }
        body { background: #000; color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; height: 100vh; margin:0; }

        /* Savaş Sinematiği Overlay */
        #video-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            z-index: 9999; flex-direction: column; align-items: center; justify-content: center;
        }
        .battle-view {
            width: 90%; max-width: 950px; border: 2px solid var(--neon-green);
            position: relative; box-shadow: 0 0 50px rgba(57, 255, 20, 0.2);
        }
        video { width: 100%; display: block; filter: contrast(1.1) brightness(1.1); }

        /* Karakter Panelleri */
        .player-header { display: flex; justify-content: space-between; width: 90%; max-width: 950px; margin-bottom: 20px; }
        .char-card { text-align: center; width: 150px; }
        .char-card img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--neon-green); margin-bottom: 5px; object-fit: cover; }
        .vs-label { font-size: 2.5rem; color: var(--neon-red); text-shadow: 0 0 15px var(--neon-red); align-self: center; }

        /* Bahis Kartları */
        .bet-card { 
            background: rgba(20,20,20,0.8); border: 1px solid #333; transition: 0.3s; cursor: pointer;
            padding: 20px; border-radius: 10px; text-align: center;
        }
        .bet-card:hover { border-color: var(--neon-green); transform: translateY(-5px); }
        .bet-card.active { border-color: var(--neon-green); box-shadow: 0 0 20px rgba(57, 255, 20, 0.3); background: #111; }

        .win-banner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-size: 4rem; font-weight: 900; z-index: 10001; text-align: center;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 100%;
        }
        .banner-active { transform: translate(-50%, -50%) scale(1); }
        
        #timer { font-size: 5rem; color: var(--neon-red); text-shadow: 0 0 20px var(--neon-red); }
        .status-text { margin-top: 15px; color: var(--neon-green); letter-spacing: 2px; height: 30px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="video-overlay">
        <div class="player-header">
            <div class="char-card">
                <img src="/caracter/profile/<%= user.selectedAnimal %>.png">
                <div class="text-white small"><%= user.nickname %></div>
                <div class="text-success small">SENSİN</div>
            </div>
            <div class="vs-label">VS</div>
            <div class="char-card">
                <img id="opp-img" src="/img/searching.png">
                <div id="opp-name" class="text-white small">ARANIYOR...</div>
                <div id="opp-type" class="text-danger small">HEDEF</div>
            </div>
        </div>

        <div class="battle-view">
            <div id="result-banner" class="win-banner"></div>
            <video id="battle-video" playsinline muted></video>
        </div>
        <div id="battle-status" class="status-text text-uppercase">SİSTEM BAĞLANTISI...</div>
    </div>

    <div class="container py-5">
        <div id="lobby-ui" class="text-center">
            <h1 class="mb-5" style="color:var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">BPL STRATEJİK ARENA</h1>
            
            <div id="bet-selection">
                <h4 class="mb-4 text-white-50">SALDIRI MODU VE BAHİS SEÇİN</h4>
                <div class="row g-4 justify-content-center">
                    <div class="col-md-3" onclick="setMultiplier(1, this)">
                        <div class="bet-card active">
                            <h3 class="text-success">NORMAL</h3>
                            <p class="mb-0 small">Giriş: 25 BPL</p>
                        </div>
                    </div>
                    <div class="col-md-3" onclick="setMultiplier(2, this)">
                        <div class="bet-card">
                            <h3 class="text-warning">2X GÜÇ</h3>
                            <p class="mb-0 small">Giriş: 55 BPL</p>
                        </div>
                    </div>
                    <div class="col-md-3" onclick="setMultiplier(4, this)">
                        <div class="bet-card">
                            <h3 class="text-danger">4X ÖFKE</h3>
                            <p class="mb-0 small">Giriş: 75 BPL</p>
                        </div>
                    </div>
                    <div class="col-md-3" onclick="setMultiplier(6, this)">
                        <div class="bet-card">
                            <h3 style="color: #ff00ff;">6X KATLİAM</h3>
                            <p class="mb-0 small">Giriş: 85 BPL</p>
                        </div>
                    </div>
                </div>
                <button onclick="startSearch()" class="btn btn-danger btn-lg mt-5 px-5 py-3 fw-bold">SALDIRIYI BAŞLAT</button>
            </div>

            <div id="matching-ui" style="display:none;">
                <div id="timer">13</div>
                <h3 class="text-neon mt-3">RAKİP ARANIYOR...</h3>
                <p class="text-muted small">Online oyuncu bulunamazsa bot atanacaktır.</p>
                <div class="spinner-border text-success mt-3" role="status"></div>
            </div>
        </div>
    </div>

    <script>
       // arena.ejs içindeki socket bağlantısını şu şekilde güncelleyin:
const arenaSocket = io(window.location.hostname.includes('localhost') 
    ? "http://localhost:3001" 
    : "https://bonus-oyun.onrender.com"); // Buraya kendi Render URL'ini tam olarak yaz
        const videoElement = document.getElementById('battle-video');
        const statusMsg = document.getElementById('battle-status');
        const resultBanner = document.getElementById('result-banner');
        
        const myId = "<%= user._id %>";
        const myNick = "<%= user.nickname %>";
        const myAnimal = "<%= user.selectedAnimal %>";

        let selectedMultiplier = 1;
        let timerInt;
        let isMatchFound = false;

        function setMultiplier(val, el) {
            selectedMultiplier = val;
            document.querySelectorAll('.bet-card').forEach(c => c.classList.remove('active'));
            el.querySelector('.bet-card').classList.add('active');
        }

        // --- ARAMAYI BAŞLAT ---
        function startSearch() {
            document.getElementById('bet-selection').style.display = 'none';
            document.getElementById('matching-ui').style.display = 'block';
            
            isMatchFound = false;

            // 1. Sunucuya "Ben hazırım, rakip bul" de
            arenaSocket.emit('find-match', { 
                myNick: myNick, 
                myAnimal: myAnimal 
            });

            // 2. 13 saniyelik geri sayımı başlat
            runTimer();
        }

        function runTimer() {
            let count = 13;
            timerInt = setInterval(() => {
                if (isMatchFound) { 
                    clearInterval(timerInt);
                    return; 
                }
                
                count--;
                document.getElementById('timer').innerText = count;
                
                if(count <= 0) {
                    clearInterval(timerInt);
                    // 13 saniye doldu, kimse gelmedi -> BOT SAVAŞINI TETİKLE
                    triggerBotBattle();
                }
            }, 1000);
        }

        function triggerBotBattle() {
            arenaSocket.emit('start-bot-battle', { 
                multiplier: selectedMultiplier, 
                userId: myId 
            });
        }

        // --- PVP EŞLEŞME BULUNDUĞUNDA ---
        arenaSocket.on('pvp-found', (data) => {
            isMatchFound = true;
            clearInterval(timerInt);
            
            // Rakibi belirle (Ben olmayan kişi)
            const opponent = data.players.find(p => p.nick !== myNick);
            
            document.getElementById('matching-ui').querySelector('h3').innerText = "RAKİP BULUNDU! DÜELLO BAŞLIYOR...";
            
            setTimeout(() => {
                document.getElementById('matching-ui').style.display = 'none';
                document.getElementById('opp-name').innerText = opponent.nick;
                document.getElementById('opp-img').src = `/caracter/profile/${opponent.animal}.png`;
                document.getElementById('opp-type').innerText = "GERÇEK OYUNCU";
                
                // PVP Sonucu (Şimdilik test için rastgele, server'dan gelmeli)
                const pvpResult = Math.random() > 0.5;
                runBattleSequence(myAnimal, opponent.animal, pvpResult, 50);
            }, 2000);
        });

        // --- BOT SAVAŞI SONUCU ---
        arenaSocket.on('battle-result', (data) => {
            isMatchFound = true;
            clearInterval(timerInt);
            document.getElementById('matching-ui').style.display = 'none';
            
            document.getElementById('opp-name').innerText = data.opponentName;
            document.getElementById('opp-img').src = `/caracter/profile/${data.opponentAnimal}.png`;
            document.getElementById('opp-type').innerText = "ELITE BOT";

            runBattleSequence(myAnimal, data.opponentAnimal, data.isWin, data.prize);
        });

        // --- VİDEO AKIŞI ---
        async function runBattleSequence(player, enemy, isWin, prize) {
            document.getElementById('video-overlay').style.display = 'flex';

            // 1. Oyuncu Saldırısı
            await playVideoAsync(player, player + "1", "SALDIRI BAŞLADI!");
            
            // 2. Rakip Karşı Atak
            await playVideoAsync(enemy, enemy + "1", "RAKİP KARŞI HAMLE YAPIYOR!");

            // 3. Final Kararı
            const winner = isWin ? player : enemy;
            const finalStatus = isWin ? `ZAFER! (+${prize} BPL)` : "BOZGUN! (-25 BPL)";
            
            resultBanner.innerText = isWin ? "VICTORY" : "DEFEAT";
            resultBanner.style.color = isWin ? "var(--neon-green)" : "var(--neon-red)";
            
            await playVideoAsync(winner, winner, finalStatus);
            
            resultBanner.classList.add('banner-active');
            
            setTimeout(() => { window.location.href = "/profil"; }, 5000);
        }

        function playVideoAsync(animal, file, text) {
            return new Promise((resolve) => {
                statusMsg.innerText = text;
                videoElement.src = `/caracter/move/${animal}/${file}.mp4`;
                videoElement.onended = resolve;
                videoElement.onerror = () => setTimeout(resolve, 1000);
                videoElement.load();
                videoElement.play().catch(resolve);
            });
        }

        arenaSocket.on('error-msg', (msg) => {
            Swal.fire('Hata', msg, 'error').then(() => { window.location.href = "/profil"; });
        });

app.get('/arena', isLoggedIn, async (req, res) => {
    const opponentNick = req.query.opponent || null;
    const customRoom = req.query.room || null;
    
    res.render('arena', { 
        user: req.user, 
        opponentNick: opponentNick, 
        customRoom: customRoom 
    });
});

function startSearch() {
    const urlParams = new URLSearchParams(window.location.search);
    const customRoom = urlParams.get('room');
    const targetOpponent = urlParams.get('opponent');

    document.getElementById('bet-selection').style.display = 'none';
    document.getElementById('matching-ui').style.display = 'block';

    if (customRoom && targetOpponent) {
        // ÖZEL DAVETLE GELDİ: Doğrudan odaya bağlan
        arenaSocket.emit('join-private-match', {
            roomId: customRoom,
            myNick: myNick,
            myAnimal: myAnimal
        });
    } else {
        // RASTGELE EŞLEŞME: Havuza gir
        arenaSocket.emit('find-match', { 
            myNick: myNick, 
            myAnimal: myAnimal 
        });
        runTimer(); // 13 saniye sayacı
    }
}


    </script>
</body>

</html>
