<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL | ÖLÜM ARENASI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon: #00ffcc; --neon-red: #ff004c; --bg: #050a0f; }
        body { background: var(--bg); color: white; font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; }
        
        .arena-stage {
            height: 70vh;
            background: url('/caracter/page/arena_bg.jpg') center bottom no-repeat;
            background-size: cover;
            position: relative;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding-bottom: 50px;
            border-bottom: 3px solid var(--neon);
        }

        /* Karakterler */
        .fighter { width: 180px; transition: 0.3s; position: relative; }
        .fighter img { width: 100%; filter: drop-shadow(0 0 15px var(--neon)); }
        .fighter.enemy img { filter: drop-shadow(0 0 15px var(--neon-red)); transform: scaleX(-1); }
        
        /* HP Barları (Senin Modelindeki Can Verileri) */
        .hp-container {
            position: absolute; top: -40px; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); height: 10px; border: 1px solid #333;
        }
        .hp-fill { height: 100%; background: var(--neon); transition: 0.5s; width: 100%; }
        .hp-fill.enemy { background: var(--neon-red); }

        /* Savaş Günlüğü */
        #battle-log {
            height: 20vh; background: rgba(0,0,0,0.9); padding: 10px;
            overflow-y: auto; font-family: 'Orbitron'; font-size: 0.8rem; border-top: 1px solid #222;
        }
        .log-entry { margin-bottom: 5px; border-left: 3px solid var(--neon); padding-left: 10px; }

        /* Aksiyon Butonları */
        .action-panel { height: 10vh; display: flex; align-items: center; justify-content: center; gap: 20px; background: #000; }
        .btn-action { 
            background: transparent; border: 2px solid var(--neon); color: var(--neon);
            padding: 10px 25px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
        }
        .btn-action:disabled { border-color: #444; color: #444; }
        
        /* Animasyonlar */
        .attack-anim { animation: lunge 0.4s ease-in-out; }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(50px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between p-2 bg-black border-bottom border-secondary">
        <div class="text-info"><i class="fas fa-user"></i> <%= user.nickname %></div>
        <div class="text-warning"><i class="fas fa-bolt"></i> STAMINA: <span id="stamina-val"><%= user.inventory.find(a => a.name === user.selectedAnimal).stamina %></span></div>
    </div>

    <div class="arena-stage">
        <div class="fighter" id="player-sprite">
            <div class="hp-container"><div class="hp-fill" id="player-hp-bar"></div></div>
            <img src="/caracter/profile/<%= user.selectedAnimal %>.jpg" alt="Hero">
            <div class="text-center mt-2 small text-uppercase fw-bold"><%= user.selectedAnimal %></div>
        </div>

        <div class="vs-text" style="font-family:'Orbitron'; font-size: 2rem; color: #555;">VS</div>

        <div class="fighter enemy" id="enemy-sprite">
            <div class="hp-container"><div class="hp-fill enemy" id="enemy-hp-bar"></div></div>
            <img src="/caracter/profile/Bear.jpg" id="enemy-img" alt="Enemy">
            <div class="text-center mt-2 small text-uppercase fw-bold text-danger" id="enemy-name">DÜŞMAN</div>
        </div>
    </div>

    <div id="battle-log">
        <div class="log-entry text-warning">Sistem: Arena hazır. Hamle bekleniyor...</div>
    </div>

    <div class="action-panel">
        <button class="btn-action" onclick="attack()" id="atk-btn">SALDIRI</button>
        <button class="btn-action" style="border-color: #ff9900; color: #ff9900;" onclick="defend()">SAVUNMA</button>
        <button class="btn-action" style="border-color: #ff4444; color: #ff4444;" onclick="location.href='/profil'">KAÇ!</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Senin modelindeki statları buraya çekiyoruz (Ezmiyoruz, kullanıyoruz!)
        let playerStats = {
            hp: <%= user.inventory.find(a => a.name === user.selectedAnimal).hp %>,
            maxHp: <%= user.inventory.find(a => a.name === user.selectedAnimal).maxHp %>,
            atk: <%= user.inventory.find(a => a.name === user.selectedAnimal).atk %>,
            def: <%= user.inventory.find(a => a.name === user.selectedAnimal).def %>,
            stamina: <%= user.inventory.find(a => a.name === user.selectedAnimal).stamina %>
        };

        let enemyStats = {
            hp: 100,
            maxHp: 100,
            atk: 15,
            def: 10,
            name: "Vahşi Ayı"
        };

        const logBox = document.getElementById('battle-log');

        function addLog(msg, color = "white") {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.color = color;
            div.innerHTML = `> ${msg}`;
            logBox.prepend(div);
        }

        async function attack() {
            if(playerStats.stamina < 10) {
                return Swal.fire("Yorgun!", "Saldırı için stamina yetersiz.", "warning");
            }

            document.getElementById('atk-btn').disabled = true;
            
            // 1. Oyuncu Saldırısı (Modelindeki ATK ve Düşman DEF hesaplaması)
            document.getElementById('player-sprite').classList.add('attack-anim');
            let damage = Math.max(5, playerStats.atk - enemyStats.def);
            enemyStats.hp -= damage;
            updateUI();
            addLog(`${playerStats.atk} güçle vurdun! Düşman ${damage} hasar aldı.`, "#00ffcc");

            setTimeout(async () => {
                document.getElementById('player-sprite').classList.remove('attack-anim');
                
                if(enemyStats.hp <= 0) return win();

                // 2. Düşman Karşı Saldırısı
                addLog("Düşman karşı atağa geçiyor...", "#ff4444");
                let enemyDmg = Math.max(3, enemyStats.atk - playerStats.def);
                playerStats.hp -= enemyDmg;
                updateUI();
                
                if(playerStats.hp <= 0) return lose();
                
                document.getElementById('atk-btn').disabled = false;
            }, 600);
        }

        function updateUI() {
            document.getElementById('player-hp-bar').style.width = (playerStats.hp / playerStats.maxHp * 100) + "%";
            document.getElementById('enemy-hp-bar').style.width = (enemyStats.hp / enemyStats.maxHp * 100) + "%";
        }

        function win() {
            Swal.fire({
                title: 'ZAFER!',
                text: 'Düşmanı alt ettin, 500 BPL kazandın!',
                icon: 'success',
                background: '#050a0f', color: '#fff'
            }).then(() => {
                // Burada backend'e galibiyeti bildirip BPL ve Wins artıracağız
                location.href = '/profil';
            });
        }

        function lose() {
            Swal.fire({ title: 'YENİLGİ', text: 'Karakterin bayıldı...', icon: 'error' })
            .then(() => location.href = '/profil');
        }
    </script>
</body>
</html>
