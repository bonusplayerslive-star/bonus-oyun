<%- include('header') %>
<style>
    body { background: #000; color: #fff; font-family: 'Orbitron'; overflow: hidden; }
    #battle-area { position: fixed; inset: 0; background: #000; display: none; z-index: 100; }
    #battle-video { width: 100%; height: 100%; object-fit: cover; }
    .bet-card { background: rgba(255,255,255,0.05); border: 1px solid #00ff88; padding: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
    .bet-card.active { background: #00ff88; color: #000; transform: scale(1.05); }
    .status-bar { position: absolute; top: 5%; width: 100%; text-align: center; font-size: 2rem; z-index: 110; text-shadow: 0 0 10px #000; }
</style>

<div class="container text-center mt-5">
    <div id="bet-screen">
        <h2 class="mb-4">BAHİS BELİRLE</h2>
        <div class="row g-3">
            <div class="col-6"><div class="bet-card" onclick="selectBet(25)">25 BPL</div></div>
            <div class="col-6"><div class="bet-card" onclick="selectBet(100)">100 BPL</div></div>
        </div>
        <button id="start-btn" class="btn btn-success mt-4 px-5 py-3" onclick="startQueue()" disabled>SAVAŞI BAŞLAT</button>
    </div>

    <div id="wait-screen" style="display:none">
        <h1 style="font-size: 5rem;" id="timer">13</h1>
        <p>RAKİP ARANIYOR...</p>
    </div>
</div>

<div id="battle-area">
    <div class="status-bar" id="battle-status">HAZIRLAN...</div>
    <video id="battle-video" playsinline muted></video>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let selectedBet = null;

    function selectBet(amount) {
        selectedBet = amount;
        document.querySelectorAll('.bet-card').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('start-btn').disabled = false;
    }

    function startQueue() {
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        socket.emit('arena-join-queue', { nickname: "<%= user.nickname %>", bet: selectedBet });
    }

    socket.on('arena-start-battle', (data) => {
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('battle-area').style.display = 'block';
        const video = document.getElementById('battle-video');
        const status = document.getElementById('battle-status');

        status.innerText = `SALDIRI: ${data.opponentNick}`;
        video.src = `/moves/${data.opponentAnimal}.mp4`;
        video.play();

        video.onended = () => {
            status.innerText = `KAZANAN: ${data.winnerNick}`;
            video.src = `/moves/${data.winnerAnimal}_victory.mp4`;
            video.play();
            setTimeout(() => window.location.href = '/chat', 5000);
        };
    });
</script>
