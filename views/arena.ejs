<%- include('header') %>

<style>
    /* --- GENEL MOBİL VE CİHAZ UYUMLU ATMOSFER --- */
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, #0a0a0a 0%, #000 100%) !important;
        overflow-x: hidden;
        color: #fff;
        font-family: 'Orbitron', sans-serif;
    }

    .arena-main-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        position: relative;
        padding: 10px;
    }

    /* --- BAHİS EKRANI --- */
    #bet-screen {
        z-index: 10;
        width: 100%;
        max-width: 1100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding-top: 20px;
    }

    h1.arena-title {
        font-size: clamp(1.2rem, 4vw, 2.5rem);
        letter-spacing: 3px;
        margin-bottom: 20px;
        text-transform: uppercase;
    }

    .bet-grid {
        display: flex;
        flex-wrap: wrap; 
        justify-content: center;
        gap: 12px;
        width: 100%;
        margin-bottom: 25px;
    }

    .bet-card {
        flex: 1 1 140px;
        max-width: 240px;
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(0, 255, 136, 0.1);
        border-radius: 15px;
        padding: 15px 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        backdrop-filter: blur(10px);
    }

    .bet-card:hover, .bet-card.active {
        transform: translateY(-5px);
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
    }

    .multiplier {
        font-size: 1.8rem;
        font-weight: 900;
        margin-bottom: 5px;
        display: block;
        text-shadow: 0 0 10px rgba(0,255,136,0.4);
    }

    .bet-details h3 { 
        font-size: 0.75rem; 
        color: #ccc; 
        margin-bottom: 3px;
        text-transform: uppercase;
    }
    
    .bet-details .prize { 
        font-size: 1.05rem; 
        color: #00ff88; 
        font-weight: bold; 
    }

    /* BAŞLA BUTONU */
    .start-btn {
        background: #00ff88;
        color: #000;
        border: none;
        padding: 12px 60px;
        font-size: clamp(1rem, 3.5vw, 1.5rem);
        font-weight: 900;
        border-radius: 40px;
        cursor: pointer;
        transition: 0.3s;
        opacity: 0.2;
        pointer-events: none;
        text-transform: uppercase;
        width: 90%;
        max-width: 350px;
        margin-bottom: 20px;
    }

    .start-btn.ready { 
        opacity: 1; 
        pointer-events: auto; 
        box-shadow: 0 0 25px rgba(0, 255, 136, 0.4); 
    }

    /* --- VİDEO ALANI --- */
    #battle-area {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: #000;
        display: none;
        z-index: 9999;
    }

    #battle-video { width: 100%; height: 100%; object-fit: cover; }

    .video-overlay {
        position: absolute;
        top: 10%; width: 100%;
        text-align: center;
        z-index: 10001;
    }

    #battle-status {
        font-size: clamp(1.2rem, 5vw, 2.2rem);
        font-weight: 900;
        color: #00ff88;
        text-transform: uppercase;
        background: rgba(0,0,0,0.5);
        padding: 10px 20px;
        border-radius: 10px;
        display: inline-block;
    }

    #wait-screen { 
        display: none; 
        text-align: center; 
        margin-top: 20%;
    }
    
    .countdown-number { 
        font-size: 80px; 
        color: #00ff88; 
        font-weight: 900; 
    }

    @media (max-width: 480px) {
        .bet-card { flex: 1 1 45%; }
    }
</style>

<div class="arena-main-container">
    <div id="bet-screen">
        <% if (user.selectedAnimal === 'none' || !user.selectedAnimal) { %>
            <div class="text-center p-4 border border-success rounded bg-dark">
                <h2 class="text-success mb-3">DÖVÜŞÇÜ SEÇİLMEDİ!</h2>
                <a href="/profil" class="btn btn-outline-success btn-lg fw-bold">PROFİLE GİT</a>
            </div>
        <% } else { %>
            <h1 class="arena-title text-white fw-bold">ARENA <span style="color: #00ff88;">DÜELLOSU</span></h1>
            
            <div class="bet-grid">
                <div class="bet-card" onclick="selectBet(this, 25, 50)">
                    <span class="multiplier" style="color: #ffffff;">X</span>
                    <div class="bet-details">
                        <h3>Giriş: 25 BPL</h3>
                        <span class="prize">Ödül: 50 BPL</span>
                    </div>
                </div>

                <div class="bet-card" onclick="selectBet(this, 35, 100)">
                    <span class="multiplier" style="color: #00ff88;">2X</span>
                    <div class="bet-details">
                        <h3>Giriş: 35 BPL</h3>
                        <span class="prize">Ödül: 100 BPL</span>
                    </div>
                </div>

                <div class="bet-card" onclick="selectBet(this, 50, 150)">
                    <span class="multiplier" style="color: #00d4ff;">6X</span>
                    <div class="bet-details">
                        <h3>Giriş: 50 BPL</h3>
                        <span class="prize" style="color: #00d4ff;">Ödül: 150 BPL</span>
                    </div>
                </div>

                <div class="bet-card" onclick="selectBet(this, 100, 250)">
                    <span class="multiplier" style="color: #ff0055;">10X</span>
                    <div class="bet-details">
                        <h3>Giriş: 100 BPL</h3>
                        <span class="prize" style="color: #ff0055;">Ödül: 250 BPL</span>
                    </div>
                </div>
            </div>

            <button id="start-btn" class="start-btn" onclick="confirmStart()">BAŞLA</button>
        <% } %>
    </div>

    <div id="wait-screen">
        <div class="countdown-number" id="timer">10</div>
        <h2 class="text-white mt-4">RAKİP ARANIYOR...</h2>
    </div>

    <div id="battle-area">
        <div class="video-overlay">
            <div id="battle-status">HAZIRLAN...</div>
        </div>
        <video id="battle-video" playsinline muted autoplay>
            <source id="video-src" src="" type="video/mp4">
        </video>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    let selectedData = null;

    function selectBet(element, bet, prize) {
        document.querySelectorAll('.bet-card').forEach(card => card.classList.remove('active'));
        element.classList.add('active');
        selectedData = { bet, prize };
        document.getElementById('start-btn').classList.add('ready');
    }

    function confirmStart() {
        if (!selectedData) return;
        
        // Cüzdan kontrolü (BPL yetiyor mu?) - İsteğe bağlı, server da kontrol etmeli
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        
        socket.emit('arena-join-queue', { 
            bet: selectedData.bet, 
            prize: selectedData.prize 
        });

        let count = 10;
        const timer = setInterval(() => {
            count--;
            document.getElementById('timer').innerText = count;
            if(count <= 0) clearInterval(timer);
        }, 1000);
    }

    socket.on('arena-match-found', (data) => {
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('battle-area').style.display = 'block';
        
        const statusText = document.getElementById('battle-status');
        statusText.innerText = "SAVAŞ BAŞLADI!";

        // 1. HAMLE VİDEOSU (Rakip saldırıyor gibi)
        // DİKKAT: Klasör adın 'caracter' mi 'character' mi kontrol et.
        const moveUrl = `/caracter/move/${data.opponentAnimal}/${data.opponentAnimal}1.mp4`;
        
        playSequence(moveUrl, () => {
            // 2. ZAFER VİDEOSU (Kazananın videosu)
            const winUrl = `/caracter/move/${data.winnerAnimal}/${data.winnerAnimal}.mp4`;
            statusText.innerText = `KAZANAN: ${data.winnerNick}`;
            
            playSequence(winUrl, () => {
                setTimeout(() => { window.location.href = '/profil'; }, 3000);
            });
        });
    });

    function playSequence(url, callback) {
        const video = document.getElementById('battle-video');
        const videoSrc = document.getElementById('video-src');
        videoSrc.src = url;
        video.load();
        video.play().catch(e => {
            console.error("Video oynatılamadı:", e);
            callback(); // Hata olsa bile devam et
        });
        video.onended = callback;
    }
</script>
