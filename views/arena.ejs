<%- include('header') %>

<style>
    /* Tasarımın aynen korunuyor, sadece birkaç küçük ekleme yapıldı */
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #0a0a0a 0%, #000 100%) !important;
        overflow-x: hidden; color: #fff; font-family: 'Orbitron', sans-serif;
    }

    .arena-main-container {
        min-height: 100vh; display: flex; flex-direction: column;
        justify-content: flex-start; align-items: center; padding: 10px;
    }

    #bet-screen {
        z-index: 10; width: 100%; max-width: 1100px;
        display: flex; flex-direction: column; align-items: center; text-align: center; padding-top: 20px;
    }

    .bet-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; width: 100%; margin-bottom: 25px; }

    .bet-card {
        flex: 1 1 140px; max-width: 240px; background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(0, 255, 136, 0.1); border-radius: 15px; padding: 15px 10px;
        transition: all 0.3s ease; cursor: pointer; backdrop-filter: blur(10px);
    }

    .bet-card.active { border-color: #00ff88; background: rgba(0, 255, 136, 0.1); box-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }

    .multiplier { font-size: 1.8rem; font-weight: 900; display: block; }
    .prize { color: #00ff88; font-weight: bold; }

    .start-btn {
        background: #00ff88; color: #000; border: none; padding: 12px 60px;
        font-size: 1.5rem; font-weight: 900; border-radius: 40px; cursor: pointer;
        opacity: 0.2; pointer-events: none; text-transform: uppercase; width: 90%; max-width: 350px;
    }

    .start-btn.ready { opacity: 1; pointer-events: auto; }

    #wait-screen { display: none; text-align: center; margin-top: 20%; }
    .countdown-number { font-size: 80px; color: #00ff88; font-weight: 900; }

    #battle-area { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; display: none; z-index: 9999; }
    #battle-video { width: 100%; height: 100%; object-fit: cover; }
    .video-overlay { position: absolute; top: 10%; width: 100%; text-align: center; z-index: 10001; }
    #battle-status { font-size: 1.5rem; color: #00ff88; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 10px; display: inline-block; }
</style>

<div class="arena-main-container">
    <div id="bet-screen">
        <% if (!user.selectedAnimal || user.selectedAnimal === 'none') { %>
            <div class="text-center p-4">
                <h2 class="text-danger">DÖVÜŞÇÜ SEÇİLMEDİ!</h2>
                <a href="/profil" class="btn btn-success mt-3">PROFİLE GİT</a>
            </div>
        <% } else { %>
            <h1 class="arena-title">ARENA <span style="color: #00ff88;">DÜELLOSU</span></h1>
            <div class="bet-grid">
                <div class="bet-card" onclick="selectBet(this, 25, 50)">
                    <span class="multiplier" style="color: #fff;">X</span>
                    <div class="bet-details"><h3>Giriş: 25 BPL</h3><span class="prize">Ödül: 50 BPL</span></div>
                </div>
                <div class="bet-card" onclick="selectBet(this, 35, 100)">
                    <span class="multiplier" style="color: #00ff88;">2X</span>
                    <div class="bet-details"><h3>Giriş: 35 BPL</h3><span class="prize">Ödül: 100 BPL</span></div>
                </div>
                <div class="bet-card" onclick="selectBet(this, 50, 150)">
                    <span class="multiplier" style="color: #00d4ff;">6X</span>
                    <div class="bet-details"><h3>Giriş: 50 BPL</h3><span class="prize">Ödül: 150 BPL</span></div>
                </div>
                <div class="bet-card" onclick="selectBet(this, 100, 250)">
                    <span class="multiplier" style="color: #ff0055;">10X</span>
                    <div class="bet-details"><h3>Giriş: 100 BPL</h3><span class="prize">Ödül: 250 BPL</span></div>
                </div>
            </div>
            <button id="start-btn" class="start-btn" onclick="confirmStart()">BAŞLA</button>
        <% } %>
    </div>

    <div id="wait-screen">
        <div class="countdown-number" id="timer">13</div>
        <h2 class="text-white mt-4">RAKİP ARANIYOR...</h2>
        <p class="text-muted small">Gerçek bir komutan bulunamazsa yapay zeka atanacaktır.</p>
    </div>

    <div id="battle-area">
        <div class="video-overlay">
            <div id="battle-status">HAZIRLAN...</div>
        </div>
        <video id="battle-video" playsinline muted autoplay></video>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    let selectedData = null;
    const urlParams = new URLSearchParams(window.location.search);
    const roomID = urlParams.get('room'); // Chat'ten gelenler için

    // Eğer chat veya meeting'den bir oda ile geldiyse otomatik bekleme
    if (roomID) {
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('battle-area').style.display = 'block';
        document.getElementById('battle-status').innerText = "RAKİP BEKLENİYOR...";
    }

    function selectBet(element, bet, prize) {
        document.querySelectorAll('.bet-card').forEach(c => c.classList.remove('active'));
        element.classList.add('active');
        selectedData = { bet, prize };
        document.getElementById('start-btn').classList.add('ready');
    }

    function confirmStart() {
        if (!selectedData) return;
        
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';

        // Backend'e 13 sn kuralı ile istek at
        socket.emit('arena-join-queue', { 
            bet: selectedData.bet, 
            prize: selectedData.prize 
        });

        let count = 13; // İstediğin 13 saniye
        const timer = setInterval(() => {
            count--;
            document.getElementById('timer').innerText = count;
            if (count <= 0) clearInterval(timer);
        }, 1000);
    }

    // Savaşın Kalbi: Server'dan gelen emir
    socket.on('arena-match-found', (data) => {
        // Ekranları değiştir
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('battle-area').style.display = 'block';
        
        const video = document.getElementById('battle-video');
        const status = document.getElementById('battle-status');
        
        status.innerText = "DÜELLO BAŞLADI!";

        // 1. Sahne: Rakibin Hamlesi
        video.src = `/caracter/move/${data.opponentAnimal}/${data.opponentAnimal}1.mp4`;
        video.play();

        video.onended = () => {
            // 2. Sahne: Kazananın Zaferi (Statlara göre server belirledi)
            status.innerHTML = `KAZANAN: <span style="color: gold;">${data.winnerNick}</span>`;
            video.src = `/caracter/move/${data.winnerAnimal}/${data.winnerAnimal}.mp4`;
            video.play();
            
            video.onended = () => {
                setTimeout(() => { window.location.href = '/profil'; }, 3000);
            };
        };
    });

    socket.on('error', (msg) => {
        Swal.fire('Sistem Hatası', msg, 'error').then(() => {
            window.location.href = '/arena';
        });
    });
</script>
