<%- include('header') %>
<div class="container text-center">
    <div class="arena-container">
        <div id="bet-screen">
            <% if (user.selectedAnimal === 'none' || !user.selectedAnimal) { %>
                <div class="alert alert-danger">
                    Önce profilinden bir karakter seçmelisin!
                    <a href="/profil" class="btn btn-sm btn-warning">Profile Git</a>
                </div>
            <% } else { %>
                <h2 class="text-warning mb-4 font-orbitron">ARENA BAHİSİNİ SEÇ</h2>
                <div class="row justify-content-center gap-2">
                    <button onclick="startSearch(25, 50)" class="btn btn-outline-success bet-btn col-5 col-md-2">25 → 50 BPL</button>
                    <button onclick="startSearch(35, 100)" class="btn btn-outline-info bet-btn col-5 col-md-2">35 → 100 BPL</button>
                    <button onclick="startSearch(75, 200)" class="btn btn-outline-warning bet-btn col-5 col-md-2">75 → 200 BPL</button>
                    <button onclick="startSearch(120, 450)" class="btn btn-outline-danger bet-btn col-5 col-md-2">120 → 450 BPL</button>
                </div>
                <p class="text-muted mt-3 small">*Bakiyeniz yetersizse işlem gerçekleşmez.</p>
            <% } %>
        </div>

        <div id="wait-screen" style="display: none;">
            <h1 id="timer" class="display-1 text-danger font-orbitron">10</h1>
            <h3 class="text-white">RAKİP ARANIYOR...</h3>
            <div class="spinner-grow text-warning" role="status"></div>
        </div>

        <div id="battle-screen" style="display: none;">
            <h2 id="battle-title" class="text-warning text-uppercase mb-3 font-orbitron">SAVAŞ BAŞLADI!</h2>
            <video id="arena-video" playsinline style="width:100%; max-width:800px; border:3px solid gold; border-radius:15px;"></video>
            <h1 id="victory-text" class="display-3 mt-3 font-orbitron" style="display: none; text-shadow: 0 0 20px gold;"></h1>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const arenaVideo = document.getElementById('arena-video');

    function startSearch(bet, prize) {
        // Bakiye kontrolü (Client-side ön kontrol)
        const currentBpl = parseInt("<%= user.bpl %>");
        if (currentBpl < bet) {
            Swal.fire('Yetersiz BPL', 'Bu bahis için yeterli bakiyeniz yok!', 'error');
            return;
        }

        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        
        socket.emit('arena-join-queue', { bet: bet, prize: prize });

        let count = 10;
        const countdown = setInterval(() => {
            count--;
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.innerText = count;
            if(count <= 0) clearInterval(countdown);
        }, 1000);
    }

    socket.on('arena-match-found', (data) => {
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';
        
        // Veri güvenliği kontrolü
        const opponentAnimal = data.opponentAnimal || 'Tiger'; 
        const winnerAnimal = data.winnerAnimal || 'Lion';
        const isWinner = (data.winnerNick === myNick);

        // 1. HAMLE: Rakip saldırır
        arenaVideo.src = `/caracter/move/${opponentAnimal}/${opponentAnimal}1.mp4`;
        arenaVideo.style.display = 'block';
        arenaVideo.play();

        arenaVideo.onended = () => {
            // 2. HAMLE: Kazanan son vuruşu yapar ve zafer videosu döner
            setTimeout(() => {
                arenaVideo.src = `/caracter/move/${winnerAnimal}/${winnerAnimal}.mp4`;
                arenaVideo.play();
                
                arenaVideo.onended = () => {
                    const vicText = document.getElementById('victory-text');
                    vicText.style.display = 'block';
                    
                    if(isWinner) {
                        vicText.innerText = "ZAFER SENİN!";
                        vicText.style.color = "#39FF14";
                        Swal.fire('TEBRİKLER!', `${data.prize} BPL kazandın!`, 'success');
                    } else {
                        vicText.innerText = "MAĞLUP OLDUN";
                        vicText.style.color = "#FF3131";
                    }
                    
                    setTimeout(() => { window.location.href = '/profil'; }, 5000);
                };
            }, 800);
        };
    });

    socket.on('error', (msg) => {
        Swal.fire('Hata', msg, 'error').then(() => location.reload());
    });
</script>
