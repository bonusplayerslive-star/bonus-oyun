
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>BPL - Arena Meydanı</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: #00ff00; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }
        
        /* Video Katmanı Tasarımı */
        #video-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column;
        }

        /* Bölünmüş Ekran (Saldırı Anı) */
        .split-container {
            display: flex; width: 100%; height: 100%;
        }
        .video-half {
            width: 50%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; border: 1px solid #222;
        }
        .video-half video { width: 90%; border: 2px solid #00ff00; box-shadow: 0 0 15px #00ff00; }
        .video-label { color: #fff; margin-bottom: 10px; font-size: 1.2rem; text-shadow: 0 0 5px #00ff00; }

        /* Kazanan Ekranı (Final) */
        .winner-container {
            display: none; width: 100%; height: 100%; justify-content: center; align-items: center;
        }
        .winner-container video { max-width: 90%; max-height: 90%; border: 4px solid gold; box-shadow: 0 0 30px gold; }

        .arena-container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        .fighters { display: flex; width: 100%; justify-content: space-around; align-items: center; }
        .fighter-box { text-align: center; width: 300px; }
        .fighter-img { width: 250px; height: 250px; object-fit: cover; border: 2px solid #00ff00; background: #111; }
        
        .hp-bar-bg { width: 100%; height: 25px; background: #222; border: 1px solid #00ff00; margin-top: 10px; position: relative; }
        .hp-bar-fill { height: 100%; background: linear-gradient(to right, #006600, #00ff00); width: 100%; transition: 0.5s; }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; color: white; font-weight: bold; line-height: 25px; }

        .controls { border-top: 2px solid #00ff00; width: 100%; padding: 30px; text-align: center; background: #050505; }
        .btn-attack { background: #880000; color: #fff; font-size: 24px; padding: 15px 60px; border: 2px solid #ff0000; cursor: pointer; transition: 0.3s; }
        .btn-attack:hover:not(:disabled) { background: #ff0000; box-shadow: 0 0 15px #ff0000; }
        .btn-attack:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="video-overlay">
        <div id="split-screen" class="split-container">
            <div class="video-half">
                <div class="video-label">SENİN HAMLEN</div>
                <video id="my-attack-vid" muted playsinline></video>
            </div>
            <div class="video-half">
                <div class="video-label">RAKİBİN HAMLESİ</div>
                <video id="opp-attack-vid" muted playsinline></video>
            </div>
        </div>
        <div id="winner-screen" class="winner-container">
            <video id="winner-vid" muted playsinline></video>
        </div>
    </div>

    <div class="arena-container">
        <h1 id="status-text" style="color: #ffcc00;">RAKİP BEKLENİYOR...</h1>

        <div class="fighters">
            <div class="fighter-box">
                <img src="" id="my-img" class="fighter-img">
                <h2 id="my-nick"><%= user.nickname %></h2>
                <div class="hp-bar-bg">
                    <div id="my-hp-fill" class="hp-bar-fill"></div>
                    <div class="hp-text">HP: <span id="my-hp-val">100</span></div>
                </div>
            </div>

            <div style="font-size: 5rem; color: #ff0000; text-shadow: 0 0 10px #ff0000;">VS</div>

            <div class="fighter-box">
                <img src="/images/searching.jpg" id="opp-img" class="fighter-img">
                <h2 id="opp-nick">Savaşçı...</h2>
                <div class="hp-bar-bg">
                    <div id="opp-hp-fill" class="hp-bar-fill"></div>
                    <div class="hp-text">HP: <span id="opp-hp-val">100</span></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="attack-btn" class="btn-attack" style="display:none;">SALDIR!</button>
        </div>
    </div>

    <script>
        const socket = io();
        const userId = "<%= user._id %>";
        let matchData = null;
        let opponent = null;
        
        // Klasör ve dosya isimleriyle tam eşleşme (Büyük/Küçük harf duyarlı)
        const animalMap = {
            "Gökdoğan": "Peregrinefalcon",
            "SNAKE": "Snake", "Snake": "Snake", "Yılan": "Snake",
            "KURD": "Kurd", "Kurd": "Kurd", "Kurt": "Kurd",
            "LION": "Lion", "Lion": "Lion", "Aslan": "Lion",
            "Ayı": "Bear", "Bear": "Bear",
            "Kaplan": "Tiger", "Tiger": "Tiger",
            "Timsah": "Crocodile", "Crocodile": "Crocodile",
            "Kartal": "Eagle", "Eagle": "Eagle",
            "Goril": "Gorilla", "Gorilla": "Gorilla",
            "Gergedan": "Rhino", "Rhino": "Rhino"
        };

        const urlParams = new URLSearchParams(window.location.search);
        const myAnimalTr = urlParams.get('animal') || "Gökdoğan";
        const myAnimalEn = animalMap[myAnimalTr] || myAnimalTr;

        // Profil resmi ayarı
        document.getElementById('my-img').src = `/caracter/profile/${myAnimalEn}.jpg`;

        socket.emit('join-arena', { userId, selectedAnimal: myAnimalTr });
        
        // Arama başlatma
        setTimeout(() => { socket.emit('start-search'); }, 2000);

        socket.on('match-found', (data) => {
            matchData = data;
            opponent = data.opponent;
            
            document.getElementById('status-text').innerText = "RAKİP BULUNDU!";
            document.getElementById('opp-nick').innerText = opponent.nickname;
            
            const oppEn = animalMap[opponent.animal] || opponent.animal;
            document.getElementById('opp-img').src = `/caracter/profile/${oppEn}.jpg`;
            document.getElementById('attack-btn').style.display = 'inline-block';
        });

        document.getElementById('attack-btn').onclick = function() {
            this.style.display = 'none';
            startCinematicBattle();
        };

        async function startCinematicBattle() {
            const overlay = document.getElementById('video-overlay');
            const splitScreen = document.getElementById('split-screen');
            const winnerScreen = document.getElementById('winner-screen');
            const status = document.getElementById('status-text');

            const myVid = document.getElementById('my-attack-vid');
            const oppVid = document.getElementById('opp-attack-vid');
            const winVid = document.getElementById('winner-vid');

            const oppEn = animalMap[opponent.animal] || opponent.animal;
            const isMeWinner = (matchData.winnerId === userId);
            const winnerEn = isMeWinner ? myAnimalEn : oppEn;

            overlay.style.display = 'flex';
            status.innerText = "SAVAŞ BAŞLADI!";

            // --- 1. SAHNE: HAMLELER (Karakter1.mp4) ---
            try {
                myVid.src = `/caracter/move/${myAnimalEn}/${myAnimalEn}1.mp4`;
                oppVid.src = `/caracter/move/${oppEn}/${oppEn}1.mp4`;

                await Promise.all([
                    myVid.play().catch(e => console.log("Video 1 oynatma hatası")),
                    oppVid.play().catch(e => console.log("Video 2 oynatma hatası"))
                ]);

                // Videoların bitmesini veya max 4.5 saniye bekle (Donma koruması)
                await Promise.race([
                    Promise.all([
                        new Promise(res => myVid.onended = res),
                        new Promise(res => oppVid.onended = res)
                    ]),
                    new Promise(res => setTimeout(res, 4500))
                ]);
            } catch (err) {
                console.error("Hamle aşaması hatası:", err);
            }

            // --- 2. SAHNE: FİNAL (Karakter.mp4) ---
            splitScreen.style.display = 'none';
            winnerScreen.style.display = 'flex';
            status.innerText = isMeWinner ? "TEBRİKLER! KAZANDIN" : "MAĞLUP OLDUN!";
            
            if(isMeWinner) {
                socket.emit('claim-victory', { userId: userId });
            }

            try {
                winVid.src = `/caracter/move/${winnerEn}/${winnerEn}.mp4`;
                await winVid.play();

                // Video bitince veya max 4 saniye sonra yönlendir
                await Promise.race([
                    new Promise(res => winVid.onended = res),
                    new Promise(res => setTimeout(res, 4000))
                ]);
            } catch (err) {
                console.error("Final aşaması hatası:", err);
            }

            // Profile yönlendirme
            window.location.href = `/profil?id=${userId}`;
        }
    </script>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io(); // Her sayfada bu bağlantıyı başlatır
    
    // Aktif sayısını her sayfada güncel tutmak için:
    socket.on('update-active-count', (count) => {
        const playerEl = document.getElementById('active-players');
        if(playerEl) playerEl.innerText = count + " OYUNCU";
    });
</script>



</body>
</html>

