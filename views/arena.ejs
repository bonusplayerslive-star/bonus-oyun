<%- include('header') %>
<style>
    .arena-container { min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); border-radius: 20px; padding: 20px; margin-top: 20px; border: 2px solid var(--gold); }
    #video-player { width: 100%; max-width: 800px; border-radius: 15px; border: 3px solid var(--neon-green); display: none; box-shadow: 0 0 30px rgba(57, 255, 20, 0.4); }
    .bet-btn { font-family: 'Orbitron'; transition: 0.3s; margin: 5px; }
    .bet-btn:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--gold); }
    #status-text { font-family: 'Orbitron'; font-size: 1.5rem; text-shadow: 0 0 10px red; }
</style>

<div class="container text-center">
    <div class="arena-container">
        <div id="bet-screen">
            <h2 class="font-orbitron text-warning mb-4">ARENA BAHİSİNİ SEÇ</h2>
            <div class="row justify-content-center">
                <button onclick="startSearch(25, 50)" class="btn btn-outline-success bet-btn col-5 col-md-2">25 → 50 BPL</button>
                <button onclick="startSearch(35, 100)" class="btn btn-outline-info bet-btn col-5 col-md-2">35 → 100 BPL</button>
                <button onclick="startSearch(75, 200)" class="btn btn-outline-warning bet-btn col-5 col-md-2">75 → 200 BPL</button>
                <button onclick="startSearch(120, 450)" class="btn btn-outline-danger bet-btn col-5 col-md-2">120 → 450 BPL</button>
            </div>
            <p class="text-muted mt-3 small">*Bakiyeniz yetersizse tüm bakiyeniz (en az 25) bahis sayılır.</p>
        </div>

        <div id="wait-screen" style="display: none;">
            <h1 id="timer" class="display-1 font-orbitron text-danger">13</h1>
            <h3 class="font-orbitron">RAKİP ARANIYOR...</h3>
            <div class="spinner-grow text-warning" role="status"></div>
        </div>

        <div id="battle-screen" style="display: none;">
            <h2 id="battle-title" class="font-orbitron text-uppercase mb-3">SAVAŞ BAŞLADI!</h2>
            <video id="arena-video" playsinline></video>
            <h1 id="victory-text" class="display-3 font-orbitron mt-3" style="display: none;">VICTORY</h1>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myAnimal = "<%= user.selectedAnimal %>";
    let arenaVideo = document.getElementById('arena-video');

    function startSearch(bet, prize) {
        document.getElementById('bet-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        
        socket.emit('arena-join-queue', { bet: bet, prize: prize, animal: myAnimal });

        let count = 13;
        let countdown = setInterval(() => {
            count--;
            document.getElementById('timer').innerText = count;
            if(count <= 0) clearInterval(countdown);
        }, 1000);
    }

    socket.on('arena-match-found', (data) => {
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';
        arenaVideo.style.display = 'block';

        // 1. Rakip Hamlesi Videosu
        arenaVideo.src = `/videos/${data.opponentAnimal}1.mp4`;
        arenaVideo.play();

        arenaVideo.onended = () => {
            // 2. Kazananın Final Videosu
            setTimeout(() => {
                arenaVideo.src = `/videos/${data.winnerAnimal}.mp4`;
                arenaVideo.play();
                
                arenaVideo.onended = () => {
                    const vicText = document.getElementById('victory-text');
                    vicText.style.display = 'block';
                    if(data.winner === "<%= user.nickname %>") {
                        vicText.innerText = "VICTORY + " + data.prize + " BPL";
                        vicText.className = "display-3 font-orbitron mt-3 text-success pulse";
                    } else {
                        vicText.innerText = "DEFEAT";
                        vicText.className = "display-3 font-orbitron mt-3 text-danger";
                    }
                    
                    // 3 Saniye sonra Chat'e at
                    setTimeout(() => { window.location.href = '/chat'; }, 3000);
                };
            }, 500);
        };
    });
</script>
