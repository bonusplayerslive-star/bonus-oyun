<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL ELITE | Arena</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --neon: #39FF14; --gold: #FFFF00; }
        body { 
            background: #000; color: white; font-family: sans-serif; 
            min-height: 100vh; min-height: -webkit-fill-available; /* iOS Fix */
        }
        .arena-card { 
            background: rgba(20,20,20,0.9); border: 1px solid var(--neon);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
        }
        .btn-attack {
            background: transparent; border: 2px solid var(--neon); color: var(--neon);
            font-weight: bold; width: 100%; padding: 12px; border-radius: 10px;
            cursor: pointer; -webkit-tap-highlight-color: transparent; /* iOS Fix */
            transition: 0.3s;
        }
        .btn-attack:active { background: var(--neon); color: #000; transform: scale(0.98); }
        .opponent-name { color: var(--gold); font-weight: bold; font-size: 1.2rem; }
        .stat-badge { font-size: 0.8rem; background: #222; padding: 3px 8px; border-radius: 5px; color: #ccc; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4" style="color: var(--neon); letter-spacing: 2px;">SAVAŞ ARENASI</h2>
    
    <div class="text-center mb-4">
        <span class="text-white-50">Senin Karakterin:</span>
        <strong class="text-white"><%= user.inventory[0] || 'Karakter Yok' %></strong>
    </div>

    <% opponents.forEach(opp => { %>
        <div class="arena-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="opponent-name"><%= opp.nickname %></div>
                    <div class="mt-1">
                        <span class="stat-badge">BPL: <%= opp.bpl %></span>
                        <span class="stat-badge">Ref: <%= opp.reference || 'Yok' %></span>
                    </div>
                </div>
                <div style="width: 120px;">
                    <button class="btn-attack" onclick="startBattle('<%= opp._id %>')">SALDIR</button>
                </div>
            </div>
        </div>
    <% }) %>

    <a href="/profil" class="d-block text-center mt-4 text-danger text-decoration-none">← ARENADAN AYRIL</a>
</div>

<script>
    async function startBattle(oppId) {
        const animal = "<%= user.inventory[0] %>";
        if(!animal) return alert("Savaşmak için önce bir hayvanın olmalı!");

        // iPhone'da butonun takılmaması için görsel geri bildirim
        event.target.innerText = "SAVAŞILIYOR...";
        event.target.disabled = true;

        try {
            const response = await fetch('/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    attackerId: "<%= user._id %>",
                    defenderId: oppId,
                    animalName: animal
                })
            });

            const result = await response.json();
            
            if(result.status === 'success') {
                alert(`SAVAŞ SONUCU:\n${result.battleMsg}\n\nKazanılan: ${result.reward} BPL`);
                location.reload(); // Bakiyeyi güncellemek için
            } else {
                alert("Hata: " + result.msg);
                location.reload();
            }
        } catch (err) {
            alert("Bağlantı sorunu yaşandı.");
            location.reload();
        }
    }
</script>

</body>
</html>
