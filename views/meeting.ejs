<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL | Elite Beşgen Masa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --neon-green: #39FF14; --neon-yellow: #FFFF00; --dark-bg: #0d0d0d; }
        body { background: var(--dark-bg); color: var(--neon-green); font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; overflow-x: hidden; }
        
        /* Ana Düzen (Layout) */
        .layout { display: flex; flex-direction: row; height: 100vh; width: 100vw; }
        
        /* Sol Taraf: Arena/Masa Bölgesi */
        .arena { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); }
        
        /* Ölçeklenebilir Beşgen Kap */
        .pentagon-container { position: relative; width: 550px; height: 550px; transform: scale(1); transition: 0.3s; }
        
        .table-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 220px; background: #000; border: 3px solid var(--neon-green);
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            display: flex; justify-content: center; align-items: center; box-shadow: 0 0 25px rgba(57, 255, 20, 0.2);
        }

        .cam-slot {
            position: absolute; width: 140px; height: 100px;
            background: #111; border: 2px solid var(--neon-green); border-radius: 8px; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cam-slot video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .tag { width: 100%; background: rgba(57, 255, 20, 0.2); color: var(--neon-green); font-size: 0.7rem; text-align: center; padding: 2px 0; border-top: 1px solid var(--neon-green); }

        /* KESİN KÖŞE KOORDİNATLARI */
        #slot-1 { top: 0%; left: 50%; transform: translate(-50%, -50%); border-color: var(--neon-yellow); }
        #slot-2 { top: 35%; right: 0%; transform: translate(15%, -50%); }
        #slot-3 { bottom: 5%; right: 10%; }
        #slot-4 { bottom: 5%; left: 10%; }
        #slot-5 { top: 35%; left: 0%; transform: translate(-15%, -50%); }

        /* Sağ Taraf: Kontrol Paneli */
        .side { width: 340px; background: #050505; border-left: 2px solid var(--neon-green); padding: 20px; display: flex; flex-direction: column; }
        .panel-header { border-bottom: 1px solid var(--neon-yellow); padding-bottom: 10px; margin-bottom: 15px; text-align: center; color: var(--neon-yellow); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #msgs { flex: 1; overflow-y: auto; border: 1px solid #222; margin-bottom: 15px; padding: 10px; font-size: 0.85rem; background: rgba(255,255,255,0.02); border-radius: 5px; }

        /* Mobil ve Tablet Uyumluluğu */
        @media (max-width: 992px) {
            .layout { flex-direction: column; height: auto; }
            .arena { height: 60vh; min-height: 450px; }
            .pentagon-container { transform: scale(0.7); }
            .side { width: 100%; height: 500px; border-left: none; border-top: 2px solid var(--neon-green); }
        }

        @media (max-width: 500px) {
            .pentagon-container { transform: scale(0.55); }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="arena">
        <div class="pentagon-container">
            <div class="table-center">
                <div id="clock" style="font-size: 2.2rem; color: var(--neon-yellow); font-family: 'Courier New'; font-weight: bold;">90:00</div>
            </div>

            <div class="cam-slot" id="slot-1">
                <video id="myCam" autoplay muted playsinline></video>
                <div class="tag" id="tag-1">MASA SAHİBİ</div>
            </div>

            <div class="cam-slot" id="slot-2"><video id="v2" autoplay playsinline></video><div class="tag" id="tag-2">BOŞ</div></div>
            <div class="cam-slot" id="slot-3"><video id="v3" autoplay playsinline></video><div class="tag" id="tag-3">BOŞ</div></div>
            <div class="cam-slot" id="slot-4"><video id="v4" autoplay playsinline></video><div class="tag" id="tag-4">BOŞ</div></div>
            <div class="cam-slot" id="slot-5"><video id="v5" autoplay playsinline></video><div class="tag" id="tag-5">BOŞ</div></div>
        </div>
    </div>

    <div class="side">
        <div class="panel-header">Elite Masa Paneli</div>
        
        <div id="msgs"></div>

        <div class="input-group mb-3">
            <input type="text" id="chatInp" class="form-control bg-dark text-white border-success" placeholder="Mesaj gönder...">
            <button onclick="msg()" class="btn btn-success fw-bold">></button>
        </div>

        <div class="card bg-dark border-warning p-2 mb-3">
            <small class="text-warning mb-2 d-block text-center fw-bold">ÜYE DAVET ET</small>
            <div class="input-group input-group-sm">
                <input type="text" id="target" class="form-control bg-black text-white border-warning" placeholder="Kullanıcı Nickname">
                <button onclick="sendInv()" class="btn btn-warning text-black fw-bold">GÖNDER</button>
            </div>
        </div>

        <div class="d-grid gap-2 mt-auto">
            <a href="/profil" class="btn btn-outline-danger btn-sm">MASADAN AYRIL</a>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const room = "<%= roomId %>";
    const myNick = "<%= user.nickname %>";
    let myStream;
    const peers = {};

    // KOLTUK TAKİBİ
    const slotMap = {
        "slot-2": { busy: false, sid: null },
        "slot-3": { busy: false, sid: null },
        "slot-4": { busy: false, sid: null },
        "slot-5": { busy: false, sid: null }
    };

    async function init() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('myCam').srcObject = myStream;
        } catch (e) {
            console.log("Kamera yok veya izin verilmedi, sadece ses/metin.");
        }
        socket.emit('join-chat', { room, nickname: myNick, userId: "<%= user.id %>" });
    }

    init();

    // SAYAÇ
    socket.on('sync-meeting', (data) => {
        let rem = Math.floor(data.remaining / 1000);
        const timer = setInterval(() => {
            if(rem <= 0) {
                clearInterval(timer);
                window.location.href = "/profil";
            }
            let m = Math.floor(rem / 60); let s = rem % 60;
            document.getElementById('clock').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            rem--;
        }, 1000);
    });

    // BİRİ GİRDİĞİNDE
    socket.on('user-joined', (data) => {
        assignSlot(data.socketId, data.nickname);
        if(myStream) {
            const pc = createPeer(data.socketId, data.nickname);
            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                socket.emit('webrtc-offer', { toSocket: data.socketId, offer, senderNick: myNick });
            });
        }
    });

    function assignSlot(sid, nickname) {
        for (let key in slotMap) {
            if (!slotMap[key].busy) {
                slotMap[key].busy = true;
                slotMap[key].sid = sid;
                const tagId = "tag-" + key.split('-')[1];
                document.getElementById(tagId).innerText = nickname;
                document.getElementById(tagId).style.background = "rgba(57, 255, 20, 0.6)";
                break;
            }
        }
    }

    socket.on('webrtc-offer', async (data) => {
        assignSlot(data.fromSocket, data.senderNick);
        const pc = createPeer(data.fromSocket, data.senderNick);
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit('webrtc-answer', { toSocket: data.fromSocket, answer });
    });

    socket.on('webrtc-answer', async (data) => {
        if (peers[data.fromSocket]) {
            await peers[data.fromSocket].setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });

    socket.on('webrtc-ice-candidate', (data) => {
        if (peers[data.fromSocket]) {
            peers[data.fromSocket].addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e=>{});
        }
    });

    function createPeer(sid, nick) {
        if (peers[sid]) return peers[sid];
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        peers[sid] = pc;

        if(myStream) myStream.getTracks().forEach(t => pc.addTrack(t, myStream));

        pc.onicecandidate = (e) => {
            if (e.candidate) socket.emit('webrtc-ice-candidate', { toSocket: sid, candidate: e.candidate });
        };

        pc.ontrack = (e) => {
            for (let key in slotMap) {
                if (slotMap[key].sid === sid) {
                    const vId = "v" + key.split('-')[1];
                    document.getElementById(vId).srcObject = e.streams[0];
                }
            }
        };
        return pc;
    }

    socket.on('user-left', (sid) => {
        if (peers[sid]) { peers[sid].close(); delete peers[sid]; }
        for (let key in slotMap) {
            if (slotMap[key].sid === sid) {
                slotMap[key].busy = false; slotMap[key].sid = null;
                const num = key.split('-')[1];
                document.getElementById("tag-"+num).innerText = "BOŞ";
                document.getElementById("tag-"+num).style.background = "rgba(57, 255, 20, 0.2)";
                document.getElementById("v"+num).srcObject = null;
            }
        }
    });

    function msg() {
        const t = document.getElementById('chatInp').value;
        if(t) socket.emit('meeting-msg', { room, sender: myNick, text: t });
        document.getElementById('chatInp').value = "";
    }

    socket.on('new-meeting-msg', (d) => {
        const div = document.createElement('div');
        div.className = "chat-msg";
        div.innerHTML = `<b class="text-warning">${d.sender}:</b> ${d.text}`;
        const m = document.getElementById('msgs');
        m.appendChild(div); m.scrollTop = m.scrollHeight;
    });

    function sendInv() {
        const t = document.getElementById('target').value;
        if(t) socket.emit('send-private-invite', { from: myNick, toNick: t, room: room });
        document.getElementById('target').value = "";
    }
</script>
</body>
</html>
