<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>BPL | BEÅžGEN KONSEY VIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #d4af37; --erotic-red: #800020; --neon-green: #39FF14; }
        body { background: #000; color: white; height: 100vh; overflow: hidden; font-family: 'Cinzel', serif; }

        /* Ãœst Bar */
        .meeting-nav {
            background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--gold);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        }

        /* BeÅŸgen Masa Dizilimi AlanÄ± */
        .pentagon-container {
            position: relative; width: 100vw; height: 55vh;
            background: radial-gradient(circle, #1a0000 0%, #000 70%);
            display: flex; justify-content: center; align-items: center;
        }

        .v-slot {
            position: absolute; width: 130px; height: 130px;
            border: 2px solid var(--gold); border-radius: 50%;
            overflow: hidden; box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
            transition: 0.4s ease; cursor: pointer; background: #111;
        }

        /* KÃ¶ÅŸe KoordinatlarÄ± (Responsive BeÅŸgen) */
        .v1 { top: 5%; } /* Tepe */
        .v2 { top: 30%; left: 5%; } /* Sol Ãœst */
        .v3 { top: 30%; right: 5%; } /* SaÄŸ Ãœst */
        .v4 { bottom: 10%; left: 15%; } /* Sol Alt */
        .v5 { bottom: 10%; right: 15%; } /* SaÄŸ Alt */

        video { width: 100%; height: 100%; object-fit: cover; }
        .user-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); text-align: center; font-size: 0.7rem; color: var(--gold); }

        /* Zoom Modu */
        .zoomed-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9999; border-radius: 0 !important; border: none !important;
        }

        /* Yan Panel & Sohbet */
        .side-panel { height: 45vh; background: #0a0a0a; border-top: 2px solid var(--gold); display: flex; }
        .chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #vip-chat { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; background: #050505; }
        .gift-section { width: 200px; padding: 10px; background: #0f0f0f; }

        .gift-btn { width: 100%; margin-bottom: 5px; font-size: 0.7rem; font-weight: bold; background: var(--erotic-red); color: white; border: 1px solid var(--gold); }
        .gift-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }

        /* SavaÅŸ Overlay */
        #battle-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000; text-align: center;
        }
        .victory-text { font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 20px red; margin-top: 15vh; font-weight: bold; }
    </style>
</head>
<body>

    <div id="invite-bar" style="display:none;" class="alert alert-warning position-fixed top-0 w-100 z-3 shadow-lg">
        <i class="fas fa-crown"></i> ðŸ”¥ Konseye Davet Edildin! 
        <button onclick="location.reload()" class="btn btn-sm btn-dark ms-3">KATIL</button>
    </div>

    <nav class="meeting-nav">
        <img src="/caracter/page/logo.jpeg" style="height: 35px; border-radius: 5px;">
        <div class="small text-warning">KONSEY ID: <%= roomId %></div>
        <div class="text-success small">BAKÄ°YE: <span id="user-bpl"><%= user.bpl %></span> BPL</div>
    </nav>

    <div class="pentagon-container" id="video-grid">
        <div class="v-slot v1" id="local-box">
            <video id="my-video" autoplay muted playsinline></video>
            <div class="user-label">SÄ°Z (<%= user.nickname %>)</div>
        </div>
        <div class="v-slot v2"><div class="user-label">BOÅž</div></div>
        <div class="v-slot v3"><div class="user-label">BOÅž</div></div>
        <div class="v-slot v4"><div class="user-label">BOÅž</div></div>
        <div class="v-slot v5"><div class="user-label">BOÅž</div></div>
    </div>

    <div id="battle-overlay">
        <div class="victory-text" id="battle-status">HAZIRLANIN...</div>
        <video id="full-battle-video" style="max-width: 90vw; border: 2px solid var(--gold); margin-top: 20px;"></video>
    </div>

    <div class="side-panel">
        <div class="chat-section">
            <div id="vip-chat"></div>
            <div class="input-group p-2">
                <input type="text" id="vip-msg" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="MesajÄ±nÄ± fÄ±sÄ±lda...">
                <button class="btn btn-success btn-sm" onclick="sendVipMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="gift-section">
            <input type="text" id="gift-target" class="form-control form-control-sm mb-2 bg-dark text-white border-warning" placeholder="Kime? (Nick)">
            
            <button class="btn gift-btn" onclick="sendGiftVIP(50, 25)" <%= user.bpl < 5000 ? 'disabled' : '' %>>50 BPL (-25%)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(100, 27)" <%= user.bpl < 5000 ? 'disabled' : '' %>>100 BPL (-27%)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(250, 30)" <%= user.bpl < 5000 ? 'disabled' : '' %>>250 BPL (-30%)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(500, 33)" <%= user.bpl < 5000 ? 'disabled' : '' %>>500 BPL (-33%)</button>

            <% if (user.bpl < 5000) { %>
                <div class="text-danger style" style="font-size: 0.55rem; text-align: center;">Hediye iÃ§in 5000 BPL gerekir!</div>
            <% } %>

            <hr class="bg-warning">
            <button class="btn btn-warning btn-sm w-100" onclick="initArena()" style="font-size: 0.7rem;">
                <i class="fas fa-skull"></i> SAVAÅžA DAVET
            </button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const myId = "<%= user._id %>";
        const myNickname = "<%= user.nickname %>";
        const roomId = "<%= roomId %>";
        let myStream;

        // 1. Kamera BaÅŸlat
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            myStream = stream;
            document.getElementById('my-video').srcObject = stream;
            // Burada odaya katÄ±lÄ±m sinyali gÃ¶nderilir (WebRTC logic eklenebilir)
        }).catch(() => alert("Kamera gerekli!"));

        // 2. Zoom Fonksiyonu
        document.getElementById('video-grid').addEventListener('click', (e) => {
            if(e.target.tagName === 'VIDEO') {
                e.target.classList.toggle('zoomed-video');
            }
        });

        // 3. MesajlaÅŸma
        function sendVipMessage() {
            const input = document.getElementById('vip-msg');
            if(input.value) {
                socket.emit('chat-message', { nickname: myNickname, message: input.value, room: roomId });
                input.value = '';
            }
        }

        socket.on('new-message', (data) => {
            const chat = document.getElementById('vip-chat');
            chat.innerHTML += `<div class="mb-1"><b style="color:var(--gold)">${data.sender}:</b> ${data.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        // 4. Hediye GÃ¶nderme
        function sendGiftVIP(amount, tax) {
            const target = document.getElementById('gift-target').value;
            if(!target) return alert("AlÄ±cÄ± nickname girin!");
            socket.emit('send-gift-vip', { senderId: myId, targetNick: target, amount, tax, room: roomId });
        }

        socket.on('gift-result', (data) => {
            alert(data.message);
            if(data.status === 'success') location.reload();
        });

        // 5. Arena ve Video YÃ¶netimi
        function initArena() {
            const target = document.getElementById('gift-target').value;
            if(!target) return alert("Rakip seÃ§in!");
            if(confirm(target + " ile savaÅŸa giriyorsun. 200 BPL kesilecek. OnaylÄ±yor musun?")) {
                socket.emit('start-vip-battle', { room: roomId, p1: myNickname, p2: target });
            }
        }

        socket.on('battle-video-play', (data) => {
            const overlay = document.getElementById('battle-overlay');
            const video = document.getElementById('full-battle-video');
            const status = document.getElementById('battle-status');
            
            overlay.style.display = 'block';
            
            // AdÄ±m 1: Hamle Videosu (hayvanismi1.mp4)
            video.src = data.moveVideo;
            video.play();
            
            video.onended = () => {
                // AdÄ±m 2: Zafer/Final Videosu (hayvanismi.mp4)
                status.innerHTML = `ðŸ† ZAFER: ${data.winner}`;
                status.style.color = "gold";
                video.src = data.video; 
                video.play();
                
                video.onended = () => {
                    setTimeout(() => { location.href = '/profil'; }, 3000);
                };
            };
        });

    </script>
</body>
</html>
