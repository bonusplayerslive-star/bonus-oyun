<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | VIP KONSEY MERKEZƒ∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #ffd700; --gold-dark: #d4af37; --panel-dark: #0a0a0a; --neon-red: #ff003c; }
        body { background: #000; color: #fff; height: 100dvh; display: flex; margin: 0; overflow: hidden; font-family: 'Rajdhani', sans-serif; }

        /* SOL: MASADAKƒ∞LER (Vƒ∞DEOLAR) */
        .video-sidebar { width: 160px; border-right: 2px solid var(--gold-dark); background: #050505; display: flex; flex-direction: column; padding: 10px; gap: 10px; overflow-y: auto; }
        
        /* ORTA: CHAT VE KONTROL */
        .main-content { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle, #111 0%, #000 100%); }
        
        /* SAƒû: GLOBAL ONLINE PANELƒ∞ */
        .global-sidebar { width: 200px; border-left: 1px solid #333; background: #080808; display: flex; flex-direction: column; }
        
        .v-slot { width: 140px; height: 140px; border: 2px solid #222; border-radius: 10px; overflow: hidden; position: relative; background: #000; flex-shrink: 0; cursor: pointer; }
        .v-slot.active-speaker { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .user-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); color: var(--gold); font-size: 0.6rem; text-align: center; padding: 2px; }

        /* MEN√úLER */
        #action-menu { position: fixed; display: none; background: #111; border: 1px solid var(--gold); z-index: 10000; min-width: 180px; border-radius: 5px; box-shadow: 0 0 20px #000; }
        .menu-item { padding: 10px 15px; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid #222; }
        .menu-item:hover { background: var(--gold); color: #000; }

        .online-user-item { padding: 8px; border-bottom: 1px solid #111; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .online-user-item:hover { background: #151515; }
        .dot { width: 6px; height: 6px; background: #39FF14; border-radius: 50%; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .video-sidebar { width: 100%; height: 120px; flex-direction: row; border-right: none; border-bottom: 1px solid var(--gold); }
            .global-sidebar { display: none; } /* Mobilde saƒü paneli butona baƒülayabilirsin, ≈üimdilik gizli */
        }
    </style>
</head>
<body>

<div class="video-sidebar" id="video-list">
    <div class="v-slot" id="slot-me" onclick="showLocalMenu(event)">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="user-label">Sƒ∞Z (KOMUTAN)</div>
    </div>
</div>

<div class="main-content">
    <div class="p-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
        <span class="text-warning fw-bold font-cinzel">KONSEY ODASI</span>
        <div>
            <button onclick="toggleMic()" id="mic-btn" class="btn btn-sm btn-outline-warning"><i class="fas fa-microphone"></i></button>
            <button onclick="toggleVideo()" id="vid-btn" class="btn btn-sm btn-outline-warning"><i class="fas fa-video"></i></button>
        </div>
    </div>
    
    <div id="vip-chat" style="flex:1; overflow-y:auto; padding:15px; background:rgba(0,0,0,0.5);"></div>

    <div class="p-3 bg-black border-top border-secondary">
        <div class="input-group">
            <span class="input-group-text bg-dark text-warning border-secondary"><span id="my-bpl"><%= user.bpl %></span></span>
            <input type="text" id="chat-input" class="form-control bg-dark text-white border-secondary" placeholder="Mesaj g√∂nder...">
            <button onclick="sendMeetingMessage()" class="btn btn-warning">G√ñNDER</button>
        </div>
    </div>
</div>

<div class="global-sidebar">
    <div class="p-2 text-center border-bottom border-secondary bg-dark small">GLOBAL ONLINE</div>
    <div id="global-list" style="overflow-y:auto; flex:1;">
        </div>
    <div class="p-2">
        <input type="text" id="invite-nickname" class="form-control form-control-sm bg-dark text-white mb-1" placeholder="Nick gir...">
        <button onclick="sendInvite()" class="btn btn-sm btn-outline-success w-100">MASAYA √áAƒûIR</button>
    </div>
</div>
<div id="action-menu">
    <div id="menu-title" class="p-2 bg-dark text-warning text-center small fw-bold"></div>
    <div class="menu-item" onclick="askGiftAmount()">üéÅ HEDƒ∞YE G√ñNDER</div>
    <div class="menu-item" onclick="handleAction('arena')">‚öîÔ∏è ARENA DAVETƒ∞</div>
    <div class="menu-item text-danger" onclick="handleAction('mute')">üö´ SUSTUR</div>
</div>

<script>
async function askGiftAmount() {
    const { value: amount } = await Swal.fire({
        title: 'Miktar Se√ßin',
        input: 'select',
        inputOptions: { '100': '100 BPL', '500': '500 BPL', '1000': '1000 BPL', '2000': '2000 BPL' },
        inputPlaceholder: 'Miktar',
        showCancelButton: true
    });
    if (amount) handleAction('gift', parseInt(amount));
}
</script>
<div id="action-menu">
    <div id="menu-title" class="p-2 bg-dark text-warning text-center small fw-bold"></div>
    <div class="menu-item" onclick="handleAction('gift', 50)">üéÅ 50 BPL G√ñNDER</div>
    <div class="menu-item" onclick="handleAction('arena')">‚öîÔ∏è ARENA DAVETƒ∞</div>
    <div class="menu-item text-danger" id="mute-option" onclick="handleAction('mute')">üö´ Mƒ∞KROFONU KAPAT</div>
    <div class="menu-item text-center bg-secondary text-white" onclick="hideMenu()">KAPAT</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
let roomParam = new URLSearchParams(window.location.search).get('room');
    const myPeer = new Peer();
    let myStream;
    let selectedTarget = null; // Men√ºde se√ßilen ki≈üi
    let inviteCount = 0;

    // 1. Kamera Ba≈ülatma (iPhone uyumlu)
    async function init() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = myStream;
        } catch (e) {
            Swal.fire("Kamera Hatasƒ±", "Kamera eri≈üimi saƒülanamadƒ±.", "error");
        }
    }

    // 2. Peer & Connection
    myPeer.on('open', id => {
        socket.emit('join-meeting', { roomId: currentRoom, peerId: id, nickname: myNick });
    });

    myPeer.on('call', call => {
        call.answer(myStream);
        call.on('stream', remoteStream => {
            addVideoSlot(call.peer, remoteStream, "KATILIMCI");
        });
    });

    socket.on('user-connected', data => {
        if (data.peerId === myPeer.id) return;
        setTimeout(() => {
            const call = myPeer.call(data.peerId, myStream);
            call.on('stream', remoteStream => {
                addVideoSlot(data.peerId, remoteStream, data.nickname);
            });
        }, 1000);
    });

    function addVideoSlot(peerId, stream, nick) {
        if (document.getElementById(peerId)) return;
        const slot = document.createElement('div');
        slot.className = "v-slot";
        slot.id = peerId;
        slot.onclick = (e) => showActionMenu(e, nick, peerId);
        
        const v = document.createElement('video');
        v.srcObject = stream;
        v.autoplay = true;
        v.playsInline = true; // iPhone zorunlu
        
        const l = document.createElement('div');
        l.className = "user-label";
        l.innerText = nick;
        
        slot.append(v, l);
        document.getElementById('video-list').append(slot);
    }

    // 3. Global Online Listesi (Saƒü Panel)
    socket.on('update-global-online', users => {
        const list = document.getElementById('global-list');
        list.innerHTML = "";
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = "online-user-item";
            div.innerHTML = `<span>${u.nickname}</span> <div class="dot"></div>`;
            div.onclick = () => { document.getElementById('invite-nickname').value = u.nickname; };
            list.appendChild(div);
        });
    });

    // 4. Davet Sistemi (Max 10)
    function sendInvite() {
        const target = document.getElementById('invite-nickname').value;
        if (!target) return;
        if (inviteCount >= 10) return Swal.fire("Limit", "Bu oturumda max 10 davet g√∂nderebilirsin.", "warning");

        socket.emit('send-private-invite', { to: target, roomId: currentRoom });
        inviteCount++;
        Swal.fire("Ba≈üarƒ±lƒ±", target + " davet edildi (" + inviteCount + "/10)", "success");
    }

    // 5. Men√º ƒ∞≈ülemleri
    function showActionMenu(e, nick, peerId) {
        e.stopPropagation();
        selectedTarget = { nick, peerId };
        const menu = document.getElementById('action-menu');
        document.getElementById('menu-title').innerText = nick;
        menu.style.display = 'block';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
    }

    function handleAction(type, amt = 0) {
        if (!selectedTarget) return;
        
        if (type === 'gift') {
            socket.emit('send-gift-vip', { targetNick: selectedTarget.nick, amount: amt, room: currentRoom });
        } else if (type === 'arena') {
            socket.emit('arena-invite-request', { to: selectedTarget.nick, from: myNick, roomId: currentRoom });
        } else if (type === 'mute') {
            socket.emit('mute-user', { targetPeerId: selectedTarget.peerId, roomId: currentRoom });
        }
        hideMenu();
    }

    function hideMenu() { document.getElementById('action-menu').style.display = 'none'; }

    // 6. Komutanƒ±n Susturma Komutu
    socket.on('command-mute', data => {
        if (myPeer.id === data.peerId) {
            myStream.getAudioTracks()[0].enabled = false;
            document.getElementById('mic-btn').innerHTML = '<i class="fas fa-microphone-slash"></i>';
            Swal.fire({ toast: true, position: 'top', title: 'Komutan mikrofonunuzu kapattƒ±!', icon: 'warning', showConfirmButton: false, timer: 2000 });
        }
    });

    // 7. Chat
    function sendMeetingMessage() {
        const input = document.getElementById('chat-input');
        if (input.value.trim()) {
            socket.emit('send-meeting-message', { text: input.value, room: currentRoom });
            input.value = "";
        }
    }

    socket.on('new-meeting-message', d => {
        const box = document.getElementById('vip-chat');
        const div = document.createElement('div');
        div.innerHTML = `<small class="text-warning">[${d.sender}]:</small> <span class="text-white">${d.text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    function toggleMic() { 
        const state = myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled;
        document.getElementById('mic-btn').innerHTML = state ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
    }

    window.onclick = hideMenu;
    init();
</script>
</body>
</html>


