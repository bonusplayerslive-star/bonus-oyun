<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>BPL | BEÅžGEN KONSEY VIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --erotic-red: #800020; --neon-green: #39FF14; --dark-bg: #050505; }
        body { background: #000; color: white; height: 100vh; overflow: hidden; font-family: 'Cinzel', serif; }

        /* Ãœst Bar */
        .meeting-nav {
            background: rgba(0,0,0,0.95); border-bottom: 1px solid var(--gold);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        /* BeÅŸgen Masa AlanÄ± */
        .pentagon-container {
            position: relative; width: 100vw; height: 50vh;
            background: radial-gradient(circle, #1a0000 0%, #000 80%);
            display: flex; justify-content: center; align-items: center;
        }

        .v-slot {
            position: absolute; width: 120px; height: 120px;
            border: 2px solid var(--gold); border-radius: 50%;
            overflow: hidden; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            transition: 0.4s ease; cursor: pointer; background: #111;
        }
        .v-slot:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--gold); }

        /* KÃ¶ÅŸe KoordinatlarÄ± */
        .v1 { top: 5%; left: 50%; transform: translateX(-50%); } /* Tepe */
        .v2 { top: 30%; left: 5%; } /* Sol Ãœst */
        .v3 { top: 30%; right: 5%; } /* SaÄŸ Ãœst */
        .v4 { bottom: 5%; left: 15%; } /* Sol Alt */
        .v5 { bottom: 5%; right: 15%; } /* SaÄŸ Alt */

        video { width: 100%; height: 100%; object-fit: cover; }
        .user-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); text-align: center; font-size: 0.65rem; color: var(--gold); padding: 2px 0; }

        /* Sohbet ve Hediye Paneli */
        .side-panel { height: 50vh; background: var(--dark-bg); border-top: 2px solid var(--gold); display: flex; }
        .chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #vip-chat { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.85rem; background: #000; color: #ccc; }
        .gift-section { width: 220px; padding: 15px; background: #0a0a0a; overflow-y: auto; }

        .gift-btn { width: 100%; margin-bottom: 8px; font-size: 0.75rem; font-weight: bold; background: var(--erotic-red); color: white; border: 1px solid var(--gold); border-radius: 5px; transition: 0.3s; }
        .gift-btn:hover:not(:disabled) { background: #a00028; transform: translateY(-2px); }
        .gift-btn:disabled { opacity: 0.3; filter: grayscale(1); }

        /* SavaÅŸ Overlay */
        #battle-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000; text-align: center;
        }
        .victory-text { font-size: 2.5rem; color: var(--gold); text-shadow: 0 0 20px red; margin-top: 10vh; font-weight: bold; letter-spacing: 3px; }
        #full-battle-video { max-width: 85vw; max-height: 60vh; border: 2px solid var(--gold); margin-top: 20px; box-shadow: 0 0 30px var(--gold); }

        /* Zoom Modu */
        .zoomed-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9999; border-radius: 0 !important; border: none !important;
        }
    </style>
</head>
<body>

    <nav class="meeting-nav">
        <img src="/caracter/page/logo.jpeg" style="height: 40px; border-radius: 5px; border: 1px solid var(--gold);">
        <div class="small text-warning" style="letter-spacing: 1px;">KONSEY ID: <%= roomId %></div>
        <div class="text-success fw-bold">BAKÄ°YE: <span id="user-bpl"><%= user.bpl %></span> BPL</div>
    </nav>

    <div class="pentagon-container" id="video-grid">
        <div class="v-slot v1" id="local-box">
            <video id="my-video" autoplay muted playsinline></video>
            <div class="user-label">SÄ°Z (<%= user.nickname %>)</div>
        </div>
        <div class="v-slot v2"><div class="user-label">BOÅž SELLER</div></div>
        <div class="v-slot v3"><div class="user-label">BOÅž SELLER</div></div>
        <div class="v-slot v4"><div class="user-label">BOÅž SELLER</div></div>
        <div class="v-slot v5"><div class="user-label">BOÅž SELLER</div></div>
    </div>

    <div id="battle-overlay">
        <div class="victory-text" id="battle-status">HÃœCUM BAÅžLIYOR...</div>
        <video id="full-battle-video"></video>
    </div>

    <div class="side-panel">
        <div class="chat-section">
            <div id="vip-chat"></div>
            <div class="input-group p-3" style="background: #0a0a0a;">
                <input type="text" id="vip-msg" class="form-control bg-black text-white border-secondary shadow-none" placeholder="Konseyde fÄ±sÄ±lda...">
                <button class="btn btn-outline-warning" onclick="sendVipMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="gift-section">
            <p class="text-center text-warning small mb-2 fw-bold">VIP TRANSFER</p>
            <input type="text" id="gift-target" class="form-control form-control-sm mb-3 bg-dark text-white border-warning" placeholder="AlÄ±cÄ± Nickname">
            
            <button class="btn gift-btn" onclick="sendGiftVIP(50, 25)" <%= user.bpl < 5000 ? 'disabled' : '' %>>50 BPL (%25 VERGÄ°)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(100, 27)" <%= user.bpl < 5000 ? 'disabled' : '' %>>100 BPL (%27 VERGÄ°)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(250, 30)" <%= user.bpl < 5000 ? 'disabled' : '' %>>250 BPL (%30 VERGÄ°)</button>
            <button class="btn gift-btn" onclick="sendGiftVIP(500, 33)" <%= user.bpl < 5000 ? 'disabled' : '' %>>500 BPL (%33 VERGÄ°)</button>

            <% if (user.bpl < 5000) { %>
                <div class="text-danger mt-2" style="font-size: 0.6rem; text-align: center;">HEDÄ°YE Ä°Ã‡Ä°N 5.000 BPL GEREKLÄ°!</div>
            <% } %>

            <hr style="background-color: var(--gold); opacity: 0.5;">
            <button class="btn btn-warning btn-sm w-100 fw-bold" onclick="initArena()">
                <i class="fas fa-bolt"></i> ARENA DAVETÄ°
            </button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const myId = "<%= user._id %>";
        const myNickname = "<%= user.nickname %>";
        const roomId = "<%= roomId %>";

        // 1. Odaya GiriÅŸ KaydÄ± (ReferenceError Ã§Ã¶zÃ¼mÃ¼nÃ¼n istemci ayaÄŸÄ±)
        socket.emit('register-user', { id: myId, nickname: myNickname });
        socket.emit('join-meeting', roomId);

        // 2. Kamera Sistemini BaÅŸlat
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('my-video').srcObject = stream;
            } catch (err) {
                console.error("Kamera hatasÄ±:", err);
                document.getElementById('local-box').innerHTML += `<div style="padding:20px; font-size:10px; color:red;">Kamera Engellendi!</div>`;
            }
        }
        setupCamera();

        // 3. MesajlaÅŸma
        function sendVipMessage() {
            const input = document.getElementById('vip-msg');
            if(input.value.trim()) {
                socket.emit('chat-message', { text: input.value, room: roomId });
                input.value = '';
            }
        }

        // Enter tuÅŸu ile mesaj gÃ¶nderimi
        document.getElementById('vip-msg').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendVipMessage();
        });

        socket.on('new-message', (data) => {
            const chat = document.getElementById('vip-chat');
            const color = data.sender === "SÄ°STEM" ? "#39FF14" : "var(--gold)";
            chat.innerHTML += `<div class="mb-2"><b style="color:${color}">${data.sender}:</b> ${data.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        // 4. VIP Hediye
        function sendGiftVIP(amount, tax) {
            const target = document.getElementById('gift-target').value;
            if(!target) return alert("LÃ¼tfen alÄ±cÄ±nÄ±n adÄ±nÄ± yazÄ±n!");
            if(target === myNickname) return alert("Kendine hediye gÃ¶nderemezsin!");
            
            socket.emit('send-gift-vip', { senderId: myId, targetNick: target, amount, tax, room: roomId });
        }

        socket.on('gift-result', (data) => {
            alert(data.message);
            if(data.status === 'success') {
                document.getElementById('user-bpl').innerText = data.newBalance;
                location.reload(); 
            }
        });

        // 5. Arena SavaÅŸ MantÄ±ÄŸÄ±
        function initArena() {
            const target = document.getElementById('gift-target').value;
            if(!target) return alert("SavaÅŸmak istediÄŸin kiÅŸinin nickname'ini yaz!");
            if(confirm(target + " ile 200 BPL karÅŸÄ±lÄ±ÄŸÄ± VIP Arena savaÅŸÄ± baÅŸlatÄ±lsÄ±n mÄ±?")) {
                socket.emit('start-vip-battle', { room: roomId, p1: myNickname, p2: target });
            }
        }

        socket.on('battle-video-play', (data) => {
            const overlay = document.getElementById('battle-overlay');
            const video = document.getElementById('full-battle-video');
            const status = document.getElementById('battle-status');
            
            overlay.style.display = 'block';
            
            // AdÄ±m 1: SaldÄ±rÄ± Animasyonu
            video.src = data.moveVideo;
            video.play();
            
            video.onended = () => {
                // AdÄ±m 2: KazananÄ±n Ä°lanÄ± ve Final Videosu
                status.innerHTML = `ðŸ† ZAFER: ${data.winner}`;
                video.src = data.video; 
                video.play();
                
                video.onended = () => {
                    setTimeout(() => { overlay.style.display = 'none'; }, 3000);
                };
            };
        });

        // GÃ¶rÃ¼ntÃ¼yÃ¼ bÃ¼yÃ¼tme (Zoom)
        document.getElementById('video-grid').addEventListener('click', (e) => {
            if(e.target.tagName === 'VIDEO') e.target.classList.toggle('zoomed-video');
        });

    </script>
</body>
</html>
