<script>
    const socket = io();
    const videoGrid = document.getElementById('video-grid');
    const myNick = "<%= user.nickname %>";
    
    // PeerJS Yapılandırması - Render/HTTPS uyumlu
    const myPeer = new Peer(undefined, {
        secure: true,
        host: '0.peerjs.com', // Kendi server'ın yoksa public server en sağlıklısıdır
        port: 443
    });

    let myStream;
    const peers = {};

    async function init() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            addVideoStream(document.createElement('video'), myStream, `SİZ: ${myNick}`, 'me', true);

            myPeer.on('call', call => {
                call.answer(myStream);
                const video = document.createElement('video');
                call.on('stream', userStream => {
                    addVideoStream(video, userStream, "BİRLİK ÜYESİ", call.peer);
                });
            });

            socket.on('user-connected', data => {
                // Yeni kullanıcı bağlandığında 1sn bekle (PeerJS el sıkışması için)
                setTimeout(() => connectToNewUser(data.peerId, myStream, data.nickname), 1000);
            });

            myPeer.on('open', id => {
                socket.emit('join-meeting', { 
                    roomId: new URLSearchParams(window.location.search).get('room') || 'global', 
                    peerId: id, 
                    nickname: myNick 
                });
            });
        } catch (err) {
            Swal.fire("ERİŞİM REDDİ", "Kamera ve mikrofon izni olmadan odaya giremezsiniz.", "error")
                .then(() => location.href = '/chat');
        }
    }

    // Görüntü ve Ses Kapatma Fonksiyonları
    function toggleAudio() {
        const enabled = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !enabled;
        document.getElementById('mic-btn').classList.toggle('btn-kick');
    }

    function toggleVideo() {
        const enabled = myStream.getVideoTracks()[0].enabled;
        myStream.getVideoTracks()[0].enabled = !enabled;
        document.getElementById('cam-btn').classList.toggle('btn-kick');
    }

    function leaveRoom() {
        location.href = '/chat';
    }

    init();
</script>
