<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | KONSEY ODASI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --dark-bg: #0a0a0a; --panel-bg: rgba(20, 20, 20, 0.9); }
        body { background: #000; color: #fff; height: 100vh; overflow: hidden; margin: 0; font-family: sans-serif; }

        /* ANA YAPI */
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* ÜST BÖLÜM (%65) */
        .top-arena { display: flex; height: 65vh; border-bottom: 2px solid #333; }

        /* YAN PANELLER */
        .side-panel { width: 25%; background: var(--panel-bg); border-right: 1px solid #222; overflow-y: auto; padding: 10px; font-size: 0.8rem; }
        .side-panel h6 { color: var(--gold); font-size: 0.7rem; text-transform: uppercase; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* ORTA VİDEO ALANI */
        .video-center { flex: 1; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; padding: 10px; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); }
        .v-slot { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--gold); overflow: hidden; position: relative; background: #111; box-shadow: 0 0 15px rgba(255,215,0,0.2); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .v-label { position: absolute; bottom: 0; width: 100%; font-size: 0.5rem; background: rgba(0,0,0,0.6); text-align: center; color: var(--gold); }

        /* ALT CHAT (%35) */
        .bottom-chat { height: 35vh; display: flex; flex-direction: column; background: #050505; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.85rem; }
        .input-bar { display: flex; padding: 10px; gap: 5px; background: #000; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }

        /* LİSTE ÖĞELERİ */
        .user-item { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .btn-mini { font-size: 0.6rem; padding: 2px 5px; }

        @media (max-width: 768px) { .side-panel { width: 30%; } .v-slot { width: 80px; height: 80px; } }
    </style>
</head>
<body>

<div class="main-container">
    <div class="top-arena">
        <div class="side-panel">
            <h6>MASADAKİLER</h6>
            <div id="room-members"></div>
        </div>

        <div class="video-center" id="video-grid">
            <div class="v-slot">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="v-label">SİZ</div>
            </div>
        </div>

        <div class="side-panel">
            <h6>GLOBAL LİSTE</h6>
            <div id="global-online"></div>
        </div>
    </div>

    <div class="bottom-chat">
        <div id="chat-messages"></div>
        <div class="input-bar">
            <input type="text" id="chat-input" class="form-control bg-dark text-white border-secondary" placeholder="Odaya yaz...">
            <button onclick="sendMsg()" class="btn btn-warning btn-sm">GÖNDER</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
    const myNick = "<%= user.nickname %>";
    const currentRoom = new URLSearchParams(window.location.search).get('room');
    const socket = io();
    const myPeer = new Peer();
    let myStream;

    // 1. SİSTEMİ BAŞLAT
    async function init() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = myStream;
            
            myPeer.on('open', id => {
                socket.emit('join-meeting', currentRoom, id, myNick);
            });
        } catch (e) { alert("Kamera izni veriniz!"); }
    }

    // 2. GELEN ARAMA (Konuk gelince)
    myPeer.on('call', call => {
        call.answer(myStream);
        call.on('stream', stream => addVideo(call.peer, stream, "ÜYE"));
    });

    // 3. YENİ BAĞLANTIYI ARA
    socket.on('user-connected', (peerId, nick) => {
        setTimeout(() => {
            const call = myPeer.call(peerId, myStream);
            call.on('stream', stream => addVideo(peerId, stream, nick));
        }, 2000);
    });

    // 4. VİDEO EKLE
    function addVideo(id, stream, nick) {
        if(document.getElementById(id)) return;
        const div = document.createElement('div');
        div.className = "v-slot"; div.id = id;
        div.innerHTML = `<video id="v-${id}" autoplay playsinline></video><div class="v-label">${nick}</div>`;
        document.getElementById('video-grid').appendChild(div);
        document.getElementById(`v-${id}`).srcObject = stream;
    }

    // 5. LİSTELERİ GÜNCELLE (ODA VE GLOBAL)
    socket.on('update-lists', (data) => {
        // Odadakiler
        document.getElementById('room-members').innerHTML = data.roomMembers.map(m => 
            `<div class="user-item"><span>${m}</span></div>`).join('');

        // Global Online (Davet Mekanizması)
        document.getElementById('global-online').innerHTML = data.globalOnline.map(u => `
            <div class="user-item">
                <span>${u}</span>
                <button class="btn btn-outline-warning btn-mini" onclick="invite('${u}')">OKU</button>
            </div>
        `).join('');
    });

    // CHAT
    function sendMsg() {
        const inp = document.getElementById('chat-input');
        if(!inp.value) return;
        socket.emit('chat-message', { room: currentRoom, text: inp.value });
        inp.value = "";
    }

    socket.on('new-message', d => {
        const box = document.getElementById('chat-messages');
        box.innerHTML += `<div><b style="color:var(--gold)">${d.sender}:</b> ${d.text}</div>`;
        box.scrollTop = box.scrollHeight;
    });

    socket.on('user-disconnected', id => { if(document.getElementById(id)) document.getElementById(id).remove(); });

    init();
</script>
</body>
</html>
