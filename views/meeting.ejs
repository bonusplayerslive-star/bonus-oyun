<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | VIP KONSEY</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --gold-dark: #d4af37; --neon-red: #ff4444; }
        
        * { box-sizing: border-box; }
        
        body { 
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%); 
            color: #fff; height: 100vh; overflow: hidden; font-family: 'Orbitron', sans-serif; 
            margin: 0; display: flex; flex-direction: column;
        }

        /* ANA KONTEYNER: √úST (Kameralar + Liste) */
        .top-section {
            display: flex;
            height: 65vh; /* Ekranƒ±n %65'i */
            width: 100%;
            border-bottom: 2px solid var(--gold-dark);
        }

        /* SOL Dƒ∞KEY: Vƒ∞DEO GRID */
        #video-grid {
            flex: 1;
            display: flex;
            flex-direction: column; /* Dikey sƒ±ralama */
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            align-items: center;
        }

        .v-slot { 
            width: 120px; height: 120px; /* Sabit dikey slot boyutu */
            min-height: 120px;
            border: 2px solid var(--gold-dark); border-radius: 50%; 
            overflow: hidden; position: relative; background: #111;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        .user-label { 
            position: absolute; bottom: 0; width: 100%; 
            background: rgba(0,0,0,0.7); color: var(--gold); 
            font-size: 0.6rem; text-align: center; padding: 2px 0;
        }

        /* SAƒû Dƒ∞KEY: KONSEY Lƒ∞STESƒ∞ */
        #council-sidebar {
            width: 150px;
            background: rgba(0,0,0,0.5);
            border-left: 1px solid var(--gold-dark);
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .member-item {
            font-size: 0.75rem; padding: 8px 5px; border-bottom: 1px solid #333;
            color: #ccc; cursor: pointer;
        }
        .member-item:hover { color: var(--gold); }

        /* ALT PANEL: CHAT */
        .bottom-panel {
            height: 35vh; /* Ekranƒ±n %35'i */
            display: flex;
            flex-direction: column;
            background: #050505;
        }

        #vip-chat {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            -webkit-overflow-scrolling: touch;
        }

        .input-bar {
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #000;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        #user-context-menu {
            position: fixed; display: none; background: #111; border: 1px solid var(--gold);
            z-index: 5000; border-radius: 5px; min-width: 160px;
        }
        .menu-btn { padding: 12px; cursor: pointer; border-bottom: 1px solid #333; font-size: 0.8rem; text-align: center; color: white; }
        .menu-btn:hover { background: var(--gold-dark); color: #000; }

        @media (max-width: 768px) {
            #council-sidebar { width: 100px; font-size: 0.6rem; }
            .v-slot { width: 90px; height: 90px; min-height: 90px; }
        }
    </style>
</head>
<body>

<div class="top-section">
    <div id="video-grid">
        <div class="v-slot" id="slot-me">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="user-label">Sƒ∞Z</div>
        </div>
    </div>

    <div id="council-sidebar">
        <h6 style="color:var(--gold); font-size: 0.7rem; text-align: center;">√úYELER</h6>
        <div id="member-names"></div>
    </div>
</div>

<div class="bottom-panel">
    <div id="vip-chat">
        <div style="color: #666;">[Sƒ∞STEM]: G√ºvenli konsey hattƒ± a√ßƒ±ldƒ±.</div>
    </div>
    <div class="input-bar">
        <input type="text" id="chat-input" class="form-control bg-dark text-white border-warning" placeholder="Mesaj..." autocomplete="off">
        <button onclick="sendMessage()" class="btn btn-warning fw-bold">G√ñNDER</button>
    </div>
</div>

<div id="user-context-menu">
    <div class="menu-btn" onclick="executeAction('gift')">üéÅ 50 BPL HEDƒ∞YE</div>
    <div class="menu-btn" onclick="executeAction('arena')">‚öîÔ∏è ARENA DAVET</div>
    <div class="menu-btn text-danger" onclick="hideMenu()">KAPAT</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
 
    const myNick = "<%= user.nickname %>";
    const currentRoom = new URLSearchParams(window.location.search).get('room');
    const socket = io(); 
    const myPeer = new Peer();
    let myStream;
    let selectedUser = null;

    // Sistem mesajlarƒ±nƒ± yazdƒ±rmak i√ßin yardƒ±mcƒ± fonksiyon (Hata vermemesi i√ßin)
    function appendMsg(sender, text) {
        const chatBox = document.getElementById('vip-chat');
        if(!chatBox) return;
        const time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        chatBox.innerHTML += `
            <div style="margin-bottom:5px;">
                <small style="color:#555">${time}</small> 
                <b style="color:var(--gold)">${sender}:</b> 
                <span style="color:#eee">${text}</span>
            </div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Kamera Ba≈ülatma
    async function initCouncil() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = myStream;
            
            // Peer a√ßƒ±ldƒ±ƒüƒ±nda odaya katƒ±l
            myPeer.on('open', id => {
                console.log("Peer ID olu≈üturuldu, odaya giriliyor:", id);
                socket.emit('join-meeting', currentRoom, id, myNick);
            });
        } catch (e) {
            console.error("Kamera Hatasƒ±:", e);
            alert("Kamera/Mikrofon izni verilmedi. G√∂r√ºnt√ºl√º g√∂r√º≈üme yapƒ±lamaz.");
        }
    }

    // GELEN ARAMALARI YANITLA (Kavu≈ümanƒ±n ilk adƒ±mƒ±)
    myPeer.on('call', call => {
        console.log("Gelen arama yanƒ±tlanƒ±yor...");
        call.answer(myStream);
        call.on('stream', userStream => {
            // Arayan ki≈üinin peerId'sini kullanarak slot olu≈ütur
            addVideoSlot(call.peer, userStream, "√úYE"); 
        });
    });

    // YENƒ∞ Bƒ∞Rƒ∞ GELDƒ∞ƒûƒ∞NDE ONU ARA (Kavu≈ümanƒ±n ikinci adƒ±mƒ±)
    socket.on('user-connected', (peerId, nick) => {
        console.log("Yeni kullanƒ±cƒ± baƒülandƒ±, g√∂r√ºnt√ºl√º aranƒ±yor:", nick);
        
        // √ñNEMLƒ∞: Biraz bekleyelim ki kar≈üƒ± tarafƒ±n answer() dinleyicisi hazƒ±r olsun
        setTimeout(() => {
            const call = myPeer.call(peerId, myStream);
            call.on('stream', userStream => {
                addVideoSlot(peerId, userStream, nick);
            });
        }, 2000); 
        
        appendMsg("Sƒ∞STEM", `${nick} masaya katƒ±ldƒ±.`);
    });

    function addVideoSlot(peerId, stream, nick) {
        // Eƒüer bu peerId i√ßin zaten bir video varsa tekrar ekleme
        if (document.getElementById(peerId)) return;

        const slot = document.createElement('div');
        slot.className = "v-slot";
        slot.id = peerId;
        slot.onclick = (e) => showMenu(e, nick);

        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        // Kendi sesimizin bize geri d√∂nmemesi i√ßin (Echo √∂nleme)
        if(nick === myNick) video.muted = true;

        const label = document.createElement('div');
        label.className = "user-label";
        label.innerText = nick;

        slot.append(video, label);
        document.getElementById('video-grid').prepend(slot);
    }

    // Oda ƒ∞√ßindeki Listeyi G√ºncelle
    socket.on('update-council-list', (members) => {
        const listDiv = document.getElementById('member-names');
        if(!listDiv) return;
        listDiv.innerHTML = members.map(m => `
            <div class="member-item" onclick="showMenu(event, '${m}')">
                ${m === myNick ? '<b>Sƒ∞Z</b>' : m}
            </div>
        `).join('');
    });

    // Chat Mesaj G√∂nderimi
    function sendMessage() {
        const input = document.getElementById('chat-input');
        if(!input || !input.value.trim()) return;
        socket.emit('chat-message', { room: currentRoom, text: input.value });
        input.value = '';
    }

    // Mesaj Geldiƒüinde
    socket.on('new-message', d => {
        appendMsg(d.sender, d.text);
    });

    // Men√º ve Diƒüer Fonksiyonlar (Aynƒ± kalabilir)
    function showMenu(e, nick) {
        if(nick === myNick) return;
        selectedUser = nick;
        const menu = document.getElementById('user-context-menu');
        menu.style.display = 'block';
        menu.style.left = (e.pageX > window.innerWidth - 160 ? e.pageX - 160 : e.pageX) + 'px';
        menu.style.top = e.pageY + 'px';
        e.stopPropagation();
    }

    function hideMenu() { 
        const menu = document.getElementById('user-context-menu');
        if(menu) menu.style.display = 'none'; 
    }
    
    function executeAction(action) {
        if(action === 'gift') socket.emit('transfer-bpl', { to: selectedUser, amount: 50 });
        if(action === 'arena') socket.emit('send-invite', { to: selectedUser, type: 'arena', cost: 50 });
        hideMenu();
    }

    window.onclick = hideMenu;

    socket.on('user-disconnected', (peerId) => { 
        const el = document.getElementById(peerId);
        if(el) el.remove(); 
    });
    
    // Ba≈ülat
    initCouncil();
</script>
</body>
</html>


