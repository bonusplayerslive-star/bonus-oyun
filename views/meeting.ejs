<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL | STRATEJİK TOPLANTI</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00ffcc; --bg: #050a0f; --card: #0d161f; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #video-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; padding: 15px; overflow-y: auto; }
        .video-container { position: relative; background: var(--card); border: 2px solid #1a2a3a; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .user-label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; font-size: 12px; border-left: 3px solid var(--neon); }
        .ui-panel { background: #0d161f; border-top: 1px solid #1a2a3a; padding: 15px; }
        #chat-messages { height: 100px; overflow-y: auto; margin-bottom: 10px; border-radius: 5px; background: rgba(0,0,0,0.3); padding: 5px; }
        .controls { display: flex; gap: 10px; }
        input { flex: 1; background: #1a2a3a; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; }
        button { background: var(--neon); color: black; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="video-grid"></div>
    <div class="ui-panel">
        <div id="chat-messages"></div>
        <div class="controls">
            <input type="text" id="chat-input" placeholder="Mesaj yaz...">
            <button id="send-btn">GÖNDER</button>
        </div>
    </div>

 <script>
    const socket = io();
    const videoGrid = document.getElementById('video-grid');
    const urlParams = new URLSearchParams(window.location.search);
    const ROOM_ID = urlParams.get('room') || 'global';
    const peers = {};

    const myPeer = new Peer(undefined, {
        host: '/',
        port: '443',
        secure: true,
        path: '/peerjs' 
    });

    let myStream;

    // FONKSİYONU DIŞARI ALDIK (Hata vermemesi için)
    function connectToNewUser(peerId, stream, nickname) {
        const call = myPeer.call(peerId, stream);
        const video = document.createElement('video');
        call.on('stream', userVideoStream => {
            addVideoStream(video, userVideoStream, nickname || "BİRLİK ÜYESİ");
        });
        call.on('close', () => video.closest('.video-container').remove());
        peers[peerId] = call;
    }

    async function init() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            addVideoStream(document.createElement('video'), myStream, "SİZ (KOMUTAN)");

            myPeer.on('call', call => {
                call.answer(myStream);
                const video = document.createElement('video');
                call.on('stream', userStream => addVideoStream(video, userStream, "BİRLİK ÜYESİ"));
            });

            socket.on('user-connected', data => {
                console.log('Yeni komutan geldi: ' + data.peerId);
                setTimeout(() => {
                    connectToNewUser(data.peerId, myStream, data.nickname);
                }, 1200); // PeerJS el sıkışması için süre tanıdık
            });

            myPeer.on('open', id => {
                socket.emit('join-meeting', { roomId: ROOM_ID, peerId: id });
            });

        } catch (err) {
            alert("Kamera izni verilmeli!");
        }
    }

    function addVideoStream(video, stream, label) {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => video.play());
        const container = document.createElement('div');
        container.className = 'video-container';
        const tag = document.createElement('div');
        tag.className = 'user-label';
        tag.innerText = label;
        container.append(video, tag);
        videoGrid.append(container);
    }

    // Mesajlaşma ve diğer soketler aynı kalabilir...
    init();
</script>
</body>
</html>

