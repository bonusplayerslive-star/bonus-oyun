<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | VIP STRATEJİK MERKEZ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --bg-dark: #050505;
            --panel-dark: #0d0d0d;
            --neon-blue: #00f3ff;
        }

        body {
            background: var(--bg-dark);
            color: #fff;
            height: 100dvh;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
        }

        /* ÜST BAR */
        .top-nav {
            height: 60px;
            background: #000;
            border-bottom: 2px solid var(--gold);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }

        .host-badge { border: 1px solid var(--gold); padding: 2px 10px; border-radius: 20px; color: var(--gold); font-size: 0.8rem; font-weight: bold; box-shadow: 0 0 10px var(--gold-glow); }

        /* ANA YAPI: 3 SÜTUNLU SİSTEM */
        .master-container {
            flex: 1;
            display: grid;
            grid-template-columns: 240px 1fr 320px; /* Sol: Kameralar, Orta: Ekran, Sağ: Chat */
            overflow: hidden;
        }

        /* SOL PANEL: DİKEY KAMERALAR */
        .video-grid {
            background: var(--panel-dark);
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 15px;
            overflow-y: auto;
        }

        .v-slot {
            width: 100%;
            aspect-ratio: 4/3;
            border-radius: 12px;
            border: 2px solid #333;
            overflow: hidden;
            position: relative;
            background: #000;
            transition: 0.3s;
        }

        .v-slot.is-host { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }
        .v-slot.active-speaker { border-color: #39FF14; transform: scale(1.02); }

        video { width: 100%; height: 100%; object-fit: cover; background: #000; }

        .name-tag {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: var(--gold);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Cinzel';
        }

        /* ORTA PANEL: STRATEJİ ALANI */
        .presentation-area {
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex;
            flex-direction: column;
            position: relative;
            border-right: 1px solid #222;
        }

        /* SAĞ PANEL: VIP CHAT */
        .chat-sidebar {
            background: #080808;
            display: flex;
            flex-direction: column;
        }

        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; }
        .msg { margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid #111; padding-bottom: 5px; }
        .msg b { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }

        /* HOST ÖZEL MENÜ */
        #context-menu {
            position: fixed;
            display: none;
            background: #111;
            border: 1px solid var(--gold);
            border-radius: 8px;
            z-index: 9999;
            width: 180px;
            box-shadow: 0 0 20px #000;
        }
        .menu-item { padding: 12px 15px; cursor: pointer; transition: 0.2s; font-size: 0.8rem; border-bottom: 1px solid #222; }
        .menu-item:hover { background: var(--gold); color: #000; }

        /* MOBİL UYUMLULUK */
        @media (max-width: 992px) {
            .master-container { grid-template-columns: 1fr; grid-template-rows: 140px 1fr 200px; }
            .video-grid { flex-direction: row; height: 140px; width: 100%; }
            .v-slot { width: 160px; height: 120px; flex-shrink: 0; }
            .chat-sidebar { height: 200px; }
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="d-flex align-items-center gap-3">
        <div class="host-badge"><i class="fas fa-crown"></i> <span id="room-owner-name">YÜKLENİYOR</span></div>
    </div>
    <div class="d-flex align-items-center gap-2">
        <div class="text-warning small fw-bold me-2"><i class="fas fa-coins"></i> <span id="user-bpl"><%= user.bpl %></span></div>
        <button onclick="toggleMic()" id="mic-btn" class="btn btn-sm btn-outline-light"><i class="fas fa-microphone"></i></button>
        <button onclick="toggleVid()" id="vid-btn" class="btn btn-sm btn-outline-light"><i class="fas fa-video"></i></button>
        <button onclick="exitRoom()" class="btn btn-sm btn-danger"><i class="fas fa-door-open"></i></button>
    </div>
</nav>

<div class="master-container">
    <div class="video-grid" id="video-wrapper">
        <div class="v-slot is-host" id="local-slot">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="name-tag">SEN (LİDER)</div>
        </div>
    </div>

    <div class="presentation-area">
        <div id="screen-placeholder" class="h-100 d-flex align-items-center justify-content-center text-center">
            <div>
                <i class="fas fa-shield-halved fa-3x mb-3 text-warning" style="opacity: 0.3;"></i>
                <p class="font-cinzel text-muted small">VIP STRATEJİ ODASI LİMİTİ: 5 KİŞİ</p>
            </div>
        </div>
        <video id="shared-screen" autoplay playsinline style="display:none;"></video>
    </div>

    <div class="chat-sidebar">
        <div class="p-2 border-bottom border-secondary bg-dark text-center small font-cinzel text-warning">VIP PANEL</div>
        <div class="chat-messages" id="meeting-chat"></div>
        
        <div class="p-2 bg-black border-top border-secondary">
            <div class="input-group mb-2">
                <input type="text" id="m-input" class="form-control form-control-sm bg-dark text-white border-0" placeholder="Mesaj...">
                <button onclick="sendMsg()" class="btn btn-sm btn-warning"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div class="input-group">
                <input type="text" id="invite-nick" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="Nick...">
                <button onclick="inviteUser()" class="btn btn-sm btn-success">DAVET</button>
            </div>
        </div>
    </div>
</div>

<div id="context-menu">
    <div id="menu-user-title" class="p-2 bg-dark text-center text-warning small fw-bold border-bottom border-warning"></div>
    <div class="menu-item" onclick="handleMenuAction('gift')"><i class="fas fa-gift me-2"></i>Hediye Gönder</div>
    <div class="menu-item text-danger" id="host-mute-opt" onclick="handleMenuAction('mute')"><i class="fas fa-microphone-slash me-2"></i>Sustur (Host)</div>
    <div class="menu-item text-danger" id="host-kick-opt" onclick="handleMenuAction('kick')"><i class="fas fa-user-times me-2"></i>Odadan At (Host)</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const urlParams = new URLSearchParams(window.location.search);
    const currentRoom = urlParams.get('room') || 'global';
    const isRoomOwner = (myNick === currentRoom); // Oda adı kurucunun nicki ise yetkili odur

    document.getElementById('room-owner-name').innerText = currentRoom + " MASASI";

    let myStream;
    let myPeer = new Peer();
    let selectedUser = null;
    let peers = {};

    // 1. Kamera ve Mikrofon Başlat (iOS Uyumluluğu İçin)
    async function startMedia() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const localVideo = document.getElementById('localVideo');
            localVideo.srcObject = myStream;
            // Safari'de autoplay bazen kullanıcı etkileşimi ister
            localVideo.play().catch(e => console.log("Autoplay engellendi, etkileşim bekleniyor."));
        } catch (e) {
            Swal.fire("Medya Hatası", "Kamera/Mikrofon izni verilmedi veya cihaz bulunamadı.", "error");
        }
    }

    // 2. Peer Bağlantısı
    myPeer.on('open', id => {
        socket.emit('join-meeting', { roomId: currentRoom, peerId: id, nickname: myNick });
    });

    // Birisi bağlandığında onu ara
    socket.on('user-connected', data => {
        if (data.peerId === myPeer.id) return;
        console.log("Yeni kullanıcı bağlandı:", data.nickname);
        const call = myPeer.call(data.peerId, myStream, { metadata: { nickname: myNick } });
        call.on('stream', userStream => {
            addRemoteVideo(data.peerId, userStream, data.nickname);
        });
        peers[data.peerId] = call;
    });

    // Aramayı cevapla
    myPeer.on('call', call => {
        call.answer(myStream);
        call.on('stream', userStream => {
            addRemoteVideo(call.peer, userStream, call.metadata.nickname || "Katılımcı");
        });
        peers[call.peer] = call;
    });

    function addRemoteVideo(peerId, stream, nick) {
        if (document.getElementById(peerId)) return;
        const wrapper = document.getElementById('video-wrapper');
        const slot = document.createElement('div');
        slot.className = "v-slot";
        slot.id = peerId;
        slot.onclick = (e) => showMenu(e, nick, peerId);
        
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true; // iOS Kritik
        
        const tag = document.createElement('div');
        tag.className = "name-tag";
        tag.innerText = nick;

        slot.append(video, tag);
        wrapper.append(slot);
    }

    // 3. Menü ve Yetkiler
    function showMenu(e, nick, peerId) {
        e.stopPropagation();
        selectedUser = { nick, peerId };
        const menu = document.getElementById('context-menu');
        document.getElementById('menu-user-title').innerText = nick;
        
        // Sadece Host ise Sustur/At butonlarını göster
        document.getElementById('host-mute-opt').style.display = isRoomOwner ? 'block' : 'none';
        document.getElementById('host-kick-opt').style.display = isRoomOwner ? 'block' : 'none';

        menu.style.display = 'block';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
    }

    async function handleMenuAction(action) {
        if (!selectedUser) return;
        if (action === 'mute') {
            socket.emit('host-action', { action: 'mute', targetPeerId: selectedUser.peerId, room: currentRoom });
        } else if (action === 'kick') {
            socket.emit('host-action', { action: 'kick', targetPeerId: selectedUser.peerId, room: currentRoom });
        } else if (action === 'gift') {
            // Hediye mantığı buraya...
        }
        document.getElementById('context-menu').style.display = 'none';
    }

    // Host komutlarını dinle (Kullanıcının kendisi susturulduysa)
    socket.on('command-mute', () => {
        myStream.getAudioTracks().forEach(t => t.enabled = false);
        document.getElementById('mic-btn').classList.replace('btn-outline-light', 'btn-danger');
        Swal.fire("UYARI", "Oda lideri mikrofonunuzu kapattı.", "warning");
    });

    socket.on('command-kick', () => {
        Swal.fire("BİLGİ", "Odadan çıkarıldınız.", "error").then(() => {
            window.location.href = "/chat";
        });
    });

    // 4. Sohbet ve Fonksiyonlar
    function sendMsg() {
        const input = document.getElementById('m-input');
        if (input.value.trim()) {
            socket.emit('meeting-message', { room: currentRoom, text: input.value });
            input.value = "";
        }
    }

    socket.on('new-meeting-message', data => {
        const chat = document.getElementById('meeting-chat');
        const div = document.createElement('div');
        div.className = "msg";
        div.innerHTML = `<b>${data.sender}:</b> <span>${data.text}</span>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });

    function toggleMic() {
        const audioTrack = myStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        document.getElementById('mic-btn').classList.toggle('btn-danger', !audioTrack.enabled);
    }

    function toggleVid() {
        const videoTrack = myStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        document.getElementById('vid-btn').classList.toggle('btn-danger', !videoTrack.enabled);
    }

    function inviteUser() {
        const nick = document.getElementById('invite-nick').value;
        if (nick) {
            socket.emit('send-meeting-invite', { target: nick, from: myNick });
            Swal.fire("Başarılı", nick + " davet edildi.", "success");
            document.getElementById('invite-nick').value = "";
        }
    }

    function exitRoom() {
        window.location.href = "/chat";
    }

    // Başlangıç
    startMedia();
    window.onclick = () => document.getElementById('context-menu').style.display = 'none';
</script>

</body>
</html>
