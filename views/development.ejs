<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL - Geliştirme Merkezi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #050505; color: #39FF14; font-family: 'Courier New', Courier, monospace; }
        .dev-container { max-width: 700px; margin: 30px auto; padding: 20px; border: 1px solid #333; border-radius: 15px; background: rgba(0,0,0,0.95); }
        
        /* Hayvan Seçim Kartları */
        .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .animal-card { 
            border: 2px solid #222; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s;
            filter: grayscale(100%); opacity: 0.6;
        }
        .animal-card.active { border-color: #39FF14; filter: grayscale(0%); opacity: 1; box-shadow: 0 0 10px rgba(57,255,20,0.4); background: rgba(57,255,20,0.05); }
        .animal-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
        .animal-card p { margin: 5px 0 0; font-size: 0.8rem; font-weight: bold; }

        .stat-card { background: rgba(255,255,255,0.02); border: 1px solid #222; padding: 12px 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; }
        .stat-info h3 { margin: 0; color: #FFFF00; font-size: 1rem; }
        .stat-info p { margin: 3px 0; font-size: 0.75rem; color: #777; }
        
        .btn-upgrade { background: transparent; border: 1px solid #39FF14; color: #39FF14; padding: 8px 15px; cursor: pointer; transition: 0.2s; border-radius: 4px; font-weight: bold; }
        .btn-upgrade:hover { background: #39FF14; color: #000; }
        
        .balance-box { text-align: center; font-size: 1.2rem; margin-bottom: 20px; color: #FFFF00; padding: 10px; border-bottom: 1px solid #222; }
        .back-btn { display: block; text-align: center; margin-top: 20px; color: #888; text-decoration: none; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="dev-container">
        <h2 style="text-align: center; color: #39FF14; text-shadow: 0 0 5px #39FF14;">GELİŞTİRME LABORATUVARI</h2>

        <div class="inventory-grid">
            <% if (user.inventory && user.inventory.length > 0) { %>
                <% user.inventory.forEach((item, index) => { %>
                    <div class="animal-card <%= index === 0 ? 'active' : '' %>" onclick="selectAnimal('<%= item.name %>', this)">
                        <img src="<%= item.img %>" alt="<%= item.name %>">
                        <p><%= item.name %></p>
                        <small style="color: #888;">LVL <%= item.level %></small>
                    </div>
                <% }) %>
            <% } else { %>
                <p style="grid-column: span 3; text-align: center; color: #ff4444;">Henüz hayvanın yok!</p>
            <% } %>
        </div>

        <div class="balance-box">
            Bakiye: <span id="current-bpl"><%= user.bpl.toLocaleString() %></span> BPL
        </div>

        <div class="stat-card">
            <div class="stat-info">
                <h3><i class="fas fa-heart"></i> HP (CAN)</h3>
                <p>Dayanıklılığı +10 artırır.</p>
            </div>
            <div>
                <span style="color: #FFFF00; margin-right: 10px;">50 BPL</span>
                <button class="btn-upgrade" onclick="upgrade('hp', 50)">YÜKSELT</button>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-info">
                <h3><i class="fas fa-swords"></i> SALDIRI (ATK)</h3>
                <p>Vuruş gücünü +5 artırır.</p>
            </div>
            <div>
                <span style="color: #FFFF00; margin-right: 10px;">40 BPL</span>
                <button class="btn-upgrade" onclick="upgrade('atk', 40)">YÜKSELT</button>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-info">
                <h3><i class="fas fa-shield-alt"></i> SAVUNMA (DEF)</h3>
                <p>Gelen hasarı azaltır.</p>
            </div>
            <div>
                <span style="color: #FFFF00; margin-right: 10px;">35 BPL</span>
                <button class="btn-upgrade" onclick="upgrade('def', 35)">YÜKSELT</button>
            </div>
        </div>

        <a href="/profil" class="back-btn"><i class="fas fa-arrow-left"></i> ÜSSE DÖN</a>
    </div>

    <script>
        // Sayfa açıldığında ilk hayvanı seçili yap
        let selectedAnimal = "<%= user.inventory && user.inventory.length > 0 ? user.inventory[0].name : '' %>";

        function selectAnimal(name, element) {
            selectedAnimal = name;
            // Tüm kartlardan active class'ını sil
            document.querySelectorAll('.animal-card').forEach(card => card.classList.remove('active'));
            // Tıklanana ekle
            element.classList.add('active');
        }

        async function upgrade(type, cost) {
            if (!selectedAnimal) {
                alert("Önce geliştirilecek bir hayvan seçmelisin!");
                return;
            }

            if (!confirm(`${selectedAnimal} için ${cost} BPL harcanacak. Onaylıyor musun?`)) return;

            try {
                const response = await fetch('/upgrade-stat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        animalName: selectedAnimal,
                        statType: type,
                        cost: cost
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('current-bpl').innerText = result.newBalance.toLocaleString();
                    // undefined hatası burada çözüldü: result.msg artık dolu geliyor
                    alert("ONAYLANDI: " + result.msg);
                } else {
                    alert("HATA: " + result.msg);
                }
            } catch (err) {
                alert("Bağlantı hatası!");
            }
        }
    </script>
</body>
</html>
