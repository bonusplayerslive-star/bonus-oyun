<%- include('header') %>

<style>
    .upgrade-card {
        background: rgba(20, 20, 20, 0.95);
        border: 1px solid #28a745;
        border-radius: 15px;
        transition: transform 0.3s;
        margin-bottom: 20px;
    }
    .upgrade-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.2);
    }
    .stat-label {
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 2px;
    }
    .progress {
        height: 8px;
        background-color: #333;
        margin-bottom: 15px;
    }
    .char-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 2px solid #28a745;
        border-radius: 50%;
    }
    .btn-upgrade {
        font-size: 0.75rem;
        font-weight: bold;
        letter-spacing: 1px;
    }
</style>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1 class="text-success fw-bold">BPL GELÄ°ÅžTÄ°RME MERKEZÄ°</h1>
        <p class="text-white-50">Karakterlerini gÃ¼Ã§lendir ve arenada rakipsiz ol!</p>
        <div class="badge bg-dark border border-warning p-2 text-warning" style="font-size: 1.2rem;">
            CÃœZDAN: <span id="balanceDisplay"><%= user.bpl %></span> BPL
        </div>
    </div>

    <div class="row">
        <% if (user.inventory && user.inventory.length > 0) { %>
            <% user.inventory.forEach(animal => { %>
                <div class="col-md-6 col-lg-4">
                    <div class="upgrade-card p-4">
                        <div class="text-center mb-3">
                            <img src="/caracter/profile/<%= animal.name %>.jpg" class="char-img mb-2" alt="<%= animal.name %>">
                            <h3 class="text-white"><%= animal.name.toUpperCase() %></h3>
                            <span class="badge bg-success">SEVÄ°YE 1</span>
                        </div>

                        <div class="stat-box">
                            <div class="d-flex justify-content-between stat-label">
                                <span>SAÄžLIK (HP)</span>
                                <span><%= animal.stats.hp %></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: <%= (animal.stats.hp / 500) * 100 %>%"></div>
                            </div>
                            <button class="btn btn-outline-danger w-100 btn-upgrade mb-3" onclick="upgradeStat('<%= animal.name %>', 'hp', 50)">
                                HP YÃœKSELT <span class="float-end">50 BPL</span>
                            </button>
                        </div>

                        <div class="stat-box">
                            <div class="d-flex justify-content-between stat-label">
                                <span>SALDIRI (ATK)</span>
                                <span><%= animal.stats.atk %></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: <%= (animal.stats.atk / 200) * 100 %>%"></div>
                            </div>
                            <button class="btn btn-outline-warning w-100 btn-upgrade mb-3" onclick="upgradeStat('<%= animal.name %>', 'atk', 40)">
                                ATK YÃœKSELT <span class="float-end">40 BPL</span>
                            </button>
                        </div>

                        <div class="stat-box">
                            <div class="d-flex justify-content-between stat-label">
                                <span>SAVUNMA (DEF)</span>
                                <span><%= animal.stats.def %></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" style="width: <%= (animal.stats.def / 200) * 100 %>%"></div>
                            </div>
                            <button class="btn btn-outline-info w-100 btn-upgrade" onclick="upgradeStat('<%= animal.name %>', 'def', 35)">
                                DEF YÃœKSELT <span class="float-end">35 BPL</span>
                            </button>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="col-12 text-center text-white">
                <p>HenÃ¼z bir karakteriniz yok. Marketten bir tane edinin!</p>
                <a href="/market" class="btn btn-success">MARKETE GÄ°T</a>
            </div>
        <% } %>
    </div>
</div>

<script>
function upgradeStat(animalName, statType, cost) {
    if(!confirm(animalName + ' iÃ§in ' + statType.toUpperCase() + ' geliÅŸtirmek istediÄŸine emin misin?')) return;

    fetch('/upgrade-stat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ animalName, statType, cost })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            alert('ðŸš€ ' + data.msg);
            location.reload(); // Ä°statistiklerin gÃ¼ncellenmesi iÃ§in sayfayÄ± yeniler
        } else {
            alert('âŒ Hata: ' + data.msg);
        }
    })
    .catch(err => {
        console.error('Sistem hatasÄ±:', err);
        alert('GeliÅŸtirme sÄ±rasÄ±nda bir hata oluÅŸtu.');
    });
}
</script>

<%- include('footer') %>
