<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL - Stratejik Operasyon Merkezi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon-turq: #00f2ff; --neon-red: #ff004c; --neon-yellow: #ffcc00; --bg-dark: #050a0f; }
        body { 
            background-color: var(--bg-dark); color: #fff; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
        }

        .main-layout { display: flex; width: 100%; gap: 15px; flex: 1; margin-top: 10px; overflow: hidden; }

        .chat-section { 
            flex: 3; border: 2px solid var(--neon-turq); border-radius: 15px; 
            box-shadow: 0 0 15px rgba(0,242,255,0.2); display: flex; flex-direction: column; background: rgba(0,0,0,0.6);
        }

        .users-section { 
            flex: 1.2; border: 1px solid rgba(0,242,255,0.3); border-radius: 15px; 
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column; padding: 15px;
        }

        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; }
        .msg-line { margin-bottom: 10px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.03); border-left: 3px solid var(--neon-turq); }
        .msg-sender { color: var(--neon-turq); font-weight: 700; font-family: 'Orbitron'; font-size: 0.75rem; }

        .user-item { padding: 12px; border-bottom: 1px solid rgba(0,242,255,0.1); display: flex; flex-direction: column; gap: 8px; }
        .user-nick { color: #fff; font-weight: 600; font-family: 'Orbitron'; font-size: 0.8rem; }
        
        .action-btns { display: flex; gap: 5px; }
        .btn-action { font-size: 9px; padding: 6px 8px; border-radius: 5px; font-family: 'Orbitron'; border: none; color: #fff; flex: 1; cursor: pointer; }
        .btn-arena { background: var(--neon-red); }
        .btn-meeting { background: var(--neon-yellow); color: #000; font-weight: bold; }

        .input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(0,242,255,0.2); }
        .neon-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--neon-turq); color: #fff; border-radius: 20px; padding: 10px 20px; outline: none; }
        .btn-send { width: 45px; height: 45px; border-radius: 50%; background: var(--neon-turq); border: none; color: #000; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="chat-section">
        <div class="p-3 border-bottom border-info d-flex justify-content-between align-items-center">
            <div>
                <span style="color:var(--neon-turq); font-family:'Orbitron'; font-weight: bold;">STRATEJİK KANAL</span>
                <div id="bakiye-status" style="font-size: 11px; color: var(--neon-yellow);">Bakiye: <%= user.bpl %> BPL</div>
            </div>
            <a href="/profil" class="btn btn-outline-info btn-sm">ÜS MERKEZİ</a>
        </div>
        
        <div id="chat-messages"></div>

        <div class="input-area">
            <input type="text" id="chat-input" class="neon-input" placeholder="Mesaj..." autocomplete="off">
            <button onclick="sendMessage()" class="btn-send">➤</button>
        </div>
    </div>

    <div class="users-section">
        <h6 class="text-center border-bottom pb-2 mb-3" style="color:var(--neon-turq); font-family:'Orbitron'">AKTİF KOMUTANLAR</h6>
        <div id="user-list" class="overflow-auto"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const userBPL = parseInt("<%= user.bpl %>");

    // Mesaj Gönder
    function sendMessage() {
        const text = document.getElementById('chat-input').value.trim();
        if (text) {
            socket.emit('chat-message', { text });
            document.getElementById('chat-input').value = '';
        }
    }

    // Kullanıcı Listesi ve Davetler
    socket.on('update-user-list', (users) => {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        users.forEach(u => {
            if(u.nickname === myNick) return;
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <span class="user-nick">${u.nickname}</span>
                <div class="action-btns">
                    <button class="btn-action btn-arena" onclick="invite('arena', '${u.nickname}')">ARENA (50)</button>
                    <button class="btn-action btn-meeting" onclick="invite('meeting', '${u.nickname}')">MEETING (50)</button>
                </div>
            `;
            userList.appendChild(div);
        });
    });

    function invite(type, target) {
        Swal.fire({
            title: 'OPERASYON ONAYI',
            text: `${target} kullanıcısına 50 BPL ile davet gönderilsin mi?`,
            background: '#050a0f', color: '#fff', showCancelButton: true,
            confirmButtonText: 'BPL ÖDE', cancelButtonText: 'İPTAL'
        }).then((res) => {
            if (res.isConfirmed) {
                socket.emit('send-bpl-invite', { type, target, cost: 50 });
            }
        });
    }

    socket.on('receive-bpl-invite', (data) => {
        Swal.fire({
            title: 'DAVET ALINDI!',
            text: `${data.from} seni ${data.type.toUpperCase()} operasyonuna çağırıyor!`,
            background: '#050a0f', color: '#fff', showCancelButton: true,
            confirmButtonText: 'KATIL', cancelButtonText: 'REDDET'
        }).then((res) => {
            if (res.isConfirmed) socket.emit('accept-bpl-invite', { type: data.type, from: data.from });
        });
    });

    socket.on('redirect-to-room', (data) => {
        // Ücreti ödeyen role=host parametresiyle gider, diğeri guest
        window.location.href = `/${data.type}?room=${data.roomId}&role=${data.role}`;
    });

    socket.on('new-chat-message', (data) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg-line';
        msgDiv.innerHTML = `<span class="msg-sender">${data.sender}:</span> <span class="msg-text">${data.text}</span>`;
        document.getElementById('chat-messages').appendChild(msgDiv);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    });

    socket.on('error', (msg) => Swal.fire('Hata', msg, 'error'));
</script>
</body>
</html>
