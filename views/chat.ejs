<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJƒ∞K ƒ∞LETƒ∞≈ûƒ∞M</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon-blue: #00f3ff; 
            --neon-red: #ff2400; /* Ate≈ü Kƒ±rmƒ±zƒ±sƒ± */
            --neon-green: #39FF14; 
            --gold: #ffc107; 
            --terminal-dark: #0a0b0c; 
        }

        body { 
            background: #000; 
            color: #e0e0e0; 
            font-family: 'Rajdhani', sans-serif; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            margin: 0; 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
        }

        /* Ana Yerle≈üim */
        .main-layout { display: flex; flex: 1; min-height: 0; }
        
        /* Sohbet Alanƒ± */
        .chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #chatMessages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(10,10,10,1) 100%);
        }

        /* Online Panel */
        .online-panel { width: 250px; background: #050505; border-left: 1px solid #222; overflow-y: auto; }
        @media (max-width: 768px) { .online-panel { display: none; } }
        
        .user-list-item { padding: 12px; border-bottom: 1px solid #111; cursor: pointer; transition: 0.2s; font-size: 0.85rem; display: flex; align-items: center; color: var(--neon-blue); text-shadow: 0 0 5px rgba(0, 243, 255, 0.3); }
        .user-list-item:hover { background: rgba(0, 243, 255, 0.1); }
        .status-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; margin-right: 10px; box-shadow: 0 0 8px var(--neon-green); }

        /* Mesaj Stilleri */
        .msg-entry { margin-bottom: 10px; padding: 5px 10px; border-left: 2px solid #222; }
        .sender-tag { 
            color: var(--neon-blue) !important; 
            font-weight: bold; 
            cursor: pointer; 
            font-family: 'Orbitron'; 
            font-size: 0.8rem; 
            margin-right: 8px; 
            text-shadow: 0 0 8px var(--neon-blue);
        }
        
        .msg-text-white { color: #ffffff; text-shadow: 0 0 5px #ffffff; }
        .msg-text-red { color: var(--neon-red); text-shadow: 0 0 5px var(--neon-red); }

        .history-divider { text-align: center; border-bottom: 1px solid #333; line-height: 0.1em; margin: 20px 0; color: #555; font-size: 0.7rem; }

        /* Aksiyon Paneli */
        #userActionPanel { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 85%; 
            max-width: 300px; 
            background: rgba(5,5,5,0.98); 
            border: 2px solid var(--gold); 
            padding: 20px; 
            z-index: 5000; 
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.2);
        }
        .btn-action { width: 100%; padding: 12px; margin-bottom: 10px; font-family: 'Orbitron'; font-size: 0.75rem; border-radius: 8px; transition: 0.3s; }
        
        /* Input Alanƒ± */
        .input-footer { background: #000; padding: 15px; border-top: 1px solid #222; }
        #messageInput { background: #0a0a0a !important; color: #fff !important; border: 1px solid #333 !important; border-radius: 20px; padding-left: 15px; }
        #messageInput:focus { border-color: var(--neon-blue) !important; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
    </style>
</head>
<body>

<div class="header-status d-flex justify-content-between p-2 bg-black border-bottom border-secondary">
    <div class="status-item small font-orbitron">ID: <span style="color: var(--neon-blue)"><%= user.nickname %></span></div>
    <div class="status-item small font-orbitron text-warning">BPL: <span id="myBpl"><%= user.bpl %></span></div>
</div>

<div class="main-layout">
    <div class="chat-section">
        <div id="chatMessages">
            <div class="history-divider"><span>OPERASYONEL MESAJLA≈ûMA</span></div>
        </div>
        
        <div class="input-footer">
            <form id="chatForm" onsubmit="sendMessage(); return false;" class="input-group">
                <input type="text" id="messageInput" class="form-control shadow-none" placeholder="Mesaj g√∂nder..." autocomplete="off">
                <button type="submit" class="btn btn-outline-info px-4 border-0"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <div class="online-panel">
        <div class="p-3 border-bottom border-secondary text-center font-orbitron small text-muted">AKTƒ∞F KOMUTANLAR</div>
        <div id="onlineUserList"></div>
    </div>
</div>

<div id="userActionPanel">
    <h6 id="selectedUserLabel" class="text-center text-info mb-3 font-orbitron" style="letter-spacing: 2px;">SE√áƒ∞LEN HEDEF</h6>
    <button onclick="sendAction('gift')" class="btn btn-outline-danger btn-action">üéÅ BPL G√ñNDER</button>
    <button onclick="sendAction('arena')" class="btn btn-outline-info btn-action">‚öîÔ∏è ARENA D√úELLO</button>
    <button onclick="sendAction('meeting')" class="btn btn-outline-warning btn-action">üèõÔ∏è KONSEY KUR (50 BPL)</button>
    <button onclick="closePanel()" class="btn btn-sm btn-dark w-100 mt-2 text-muted border-0">ƒ∞PTAL</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    let selectedUser = "";

    // Sƒ∞STEM Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞
    socket.on('update-bpl', (newBpl) => {
        const bplElement = document.getElementById('myBpl');
        if (bplElement) bplElement.innerText = newBpl;
    });

    socket.on('load-history', (history) => {
        history.forEach(msg => appendMessage(msg.sender, msg.text));
    });

    socket.on('new-message', (data) => {
        appendMessage(data.sender, data.text);
    });

    socket.on('update-online-users', (users) => {
        const list = document.getElementById('onlineUserList');
        if (!list) return;
        list.innerHTML = "";
        users.forEach(u => {
            if (u.nickname !== myNick) {
                const item = document.createElement('div');
                item.className = "user-list-item";
                item.onclick = () => openUserMenu(u.nickname);
                item.innerHTML = `<div class="status-dot"></div><span>${u.nickname}</span>`;
                list.appendChild(item);
            }
        });
    });

    // DAVET Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞
    socket.on('arena-invite-received', (data) => {
        Swal.fire({
            title: '‚öîÔ∏è ARENA √áAƒûRISI!',
            text: `${data.from} seni d√ºelloya davet ediyor!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'KABUL ET',
            cancelButtonText: 'REDDET',
            background: '#0a0b0c',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/arena?from=${data.from}`;
            }
        });
    });

    socket.on('meeting-invite-received', (data) => {
        Swal.fire({
            title: 'üèõÔ∏è KONSEYE √áAƒûRILDIN',
            text: `${data.from} seni strateji masasƒ±na bekliyor!`,
            confirmButtonText: 'KATIL',
            background: '#0a0b0c',
            color: '#ffc107'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/meeting?room=" + data.from;
            }
        });
    });

    // FONKSƒ∞YONLAR
    function appendMessage(sender, text) {
        const box = document.getElementById('chatMessages');
        if (!box) return;
        const div = document.createElement('div');
        div.className = "msg-entry";
        
        // Nickname Neon Mavi, Mesajlar Sƒ±rayla Beyaz/Kƒ±rmƒ±zƒ± Neon
        const colorClass = (sender === "Sƒ∞STEM") ? "msg-text-red" : "msg-text-white";
        
        div.innerHTML = `
            <span class="sender-tag" onclick="openUserMenu('${sender}')">[${sender}]</span> 
            <span class="${colorClass}">${text}</span>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input && input.value.trim()) {
            socket.emit('chat-message', { text: input.value.trim() });
            input.value = "";
        }
    }

    function openUserMenu(nick) {
        if (nick === myNick || nick === "Sƒ∞STEM") return;
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    async function sendAction(type) {
        closePanel();
        if (type === 'gift') {
            const { value: amt } = await Swal.fire({
                title: 'BPL Miktarƒ±',
                input: 'number',
                background: '#111', color: '#fff'
            });
            if (amt > 0) socket.emit('send-gift-bpl', { to: selectedUser, amount: amt });
        } else if (type === 'arena') {
            socket.emit('arena-invite-request', { to: selectedUser });
        } else if (type === 'meeting') {
            // Konseyi Kur ve y√∂nlendir
            socket.emit('send-meeting-invite', { target: selectedUser });
            window.location.href = "/meeting?room=" + myNick + "&role=host";
        }
    }


socket.on('meeting-invite-received', (data) => {
    Swal.fire({
        title: 'STRATEJƒ∞ DAVETƒ∞!',
        text: `${data.from} seni VIP masasƒ±na √ßaƒüƒ±rƒ±yor.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'KATIL',
        cancelButtonText: 'REDDET',
        background: '#000',
        color: '#ffd700',
        confirmButtonColor: '#28a745'
    }).then((result) => {
        if (result.isConfirmed) {
            // BURASI KRƒ∞Tƒ∞K: data.room g√∂nderenin ismidir.
            window.location.href = `/meeting?room=${data.room}`;
        }
    });
});

socket.on('force-join-meeting', (data) => {
    // Davet g√∂nderdiƒüin an seni odaya y√∂nlendirir
    window.location.href = `/meeting?room=${data.room}&role=host`;
});

// Davet alan ki≈üi i√ßin (Kabul ettiƒüinde √ßalƒ±≈üƒ±r)
socket.on('meeting-invite-received', (data) => {
    Swal.fire({
        title: 'TOPLANTI DAVETƒ∞',
        text: `${data.from} seni konsey odasƒ±na √ßaƒüƒ±rƒ±yor!`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'KATIL',
        cancelButtonText: 'REDDET'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = `/meeting?room=${data.room}&role=guest`;
        }
    });
});
</script>
</body>
</html>


