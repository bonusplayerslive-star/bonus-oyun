<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJÄ°K Ä°LETÄ°ÅÄ°M</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; --gold: #ffc107; --terminal-dark: #0a0b0c; }
        body { background: #000; color: #e0e0e0; font-family: 'Rajdhani', sans-serif; height: 100dvh; display: flex; flex-direction: column; margin: 0; overflow: hidden; position: fixed; width: 100%; }

        /* Ana YerleÅŸim */
        .main-layout { display: flex; flex: 1; min-height: 0; }
        
        /* Sohbet AlanÄ± */
        .chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.8); }

        /* Online Panel (SaÄŸ Taraf) */
        .online-panel { width: 250px; background: #050505; border-left: 1px solid var(--neon-green); overflow-y: auto; }
        @media (max-width: 768px) { .online-panel { display: none; } /* iPhone'da alanÄ± korumak iÃ§in gizledim, menÃ¼den eriÅŸilecek */ }
        
        .user-list-item { padding: 10px; border-bottom: 1px solid #111; cursor: pointer; transition: 0.2s; font-size: 0.8rem; display: flex; align-items: center; }
        .user-list-item:hover { background: rgba(57, 255, 20, 0.1); }
        .status-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px var(--neon-green); }

        /* Mesaj Stilleri */
        .msg-entry { margin-bottom: 8px; padding: 8px; border-left: 3px solid transparent; background: rgba(255,255,255,0.02); }
        .history-divider { text-align: center; border-bottom: 1px solid #333; line-height: 0.1em; margin: 20px 0; color: #555; font-size: 0.7rem; }
        .sender-tag { color: var(--gold); font-weight: bold; cursor: pointer; font-family: 'Orbitron'; font-size: 0.75rem; margin-right: 5px; }

        /* Aksiyon Paneli (Pop-up) */
        #userActionPanel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 300px; background: rgba(0,0,0,0.95); border: 2px solid var(--neon-blue); padding: 20px; z-index: 5000; border-radius: 10px; }
        .btn-action { width: 100%; padding: 12px; margin-bottom: 8px; font-family: 'Orbitron'; font-size: 0.75rem; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header-status d-flex justify-content-between p-2 bg-dark border-bottom border-success">
    <div class="status-item small text-uppercase font-orbitron">ID: <span class="val-neon"><%= user.nickname %></span></div>
    <div class="status-item small font-orbitron text-warning">BPL: <span id="myBpl"><%= user.bpl %></span></div>
</div>

<div class="main-layout">
    <div class="chat-section">
        <div id="chatMessages">
            <div class="history-divider"><span>SON 1 SAATLÄ°K GEÃ‡MÄ°Å</span></div>
        </div>
        
        <div class="input-footer p-2 bg-black border-top border-secondary">
            <form id="chatForm" onsubmit="sendMessage(); return false;" class="input-group">
                <input type="text" id="messageInput" class="form-control bg-dark text-success border-secondary" placeholder="Mesaj yaz..." autocomplete="off">
                <button type="submit" class="btn btn-success px-4"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <div class="online-panel">
        <div class="p-2 border-bottom border-secondary text-center font-orbitron small text-success">AKTÄ°F OYUNCULAR</div>
        <div id="onlineUserList">
            </div>
    </div>
</div>

<div id="userActionPanel">
    <h6 id="selectedUserLabel" class="text-center text-info mb-3 font-orbitron">HEDEF SEÃ‡Ä°LDÄ°</h6>
    <button onclick="sendAction('gift')" class="btn btn-outline-danger btn-action">ğŸ HEDÄ°YE (BPL)</button>
    <button onclick="sendAction('arena')" class="btn btn-outline-info btn-action">âš”ï¸ ARENA (DÃœELLO)</button>
    <button onclick="sendAction('meeting')" class="btn btn-outline-warning btn-action">ğŸ›ï¸ KONSEY (50 BPL)</button>
    <button onclick="closePanel()" class="btn btn-sm btn-dark w-100 mt-2 text-muted">KAPAT</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    let selectedUser = "";

    // --- 1. SÄ°STEM DÄ°NLEYÄ°CÄ°LERÄ° ---

    // Bakiye GÃ¼ncelleme (Hediye gÃ¶nderince veya davet atÄ±nca anlÄ±k dÃ¼ÅŸer)
    socket.on('update-bpl', (newBpl) => {
        const bplElement = document.getElementById('myBpl');
        if (bplElement) bplElement.innerText = newBpl;
    });

    // GeÃ§miÅŸ MesajlarÄ± YÃ¼kle
    socket.on('load-history', (history) => {
        const box = document.getElementById('chatMessages');
        // GeÃ§miÅŸi yÃ¼klemeden Ã¶nce temizlemek istersen: box.innerHTML = '';
        history.forEach(msg => appendMessage(msg.sender, msg.text, true));
    });

    // Yeni Mesaj GeldiÄŸinde
    socket.on('new-message', (data) => {
        appendMessage(data.sender, data.text);
    });

    // Online Listesini GÃ¼ncelle (Fix: Obje yapÄ±sÄ±na uygun)
    socket.on('update-online-users', (users) => {
        const list = document.getElementById('onlineUserList');
        if (!list) return;
        list.innerHTML = "";
        users.forEach(u => {
            if (u.nickname !== myNick) {
                const item = document.createElement('div');
                item.className = "user-list-item";
                item.onclick = () => openUserMenu(u.nickname);
                item.innerHTML = `<div class="status-dot"></div><span>${u.nickname}</span>`;
                list.appendChild(item);
            }
        });
    });

    // --- 2. DAVET DÄ°NLEYÄ°CÄ°LERÄ° (GELEN TALEPLER) ---

    // Arena Daveti GeldiÄŸinde
    socket.on('arena-invite-received', (data) => {
        Swal.fire({
            title: 'âš”ï¸ DÃœELLO TALEBÄ°!',
            text: `${data.from} seni arenaya davet ediyor!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#d33',
            confirmButtonText: 'KABUL ET',
            cancelButtonText: 'REDDET',
            background: '#0a0b0c',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/arena";
            }
        });
    });

    // Konsey Daveti GeldiÄŸinde
    socket.on('meeting-invite-received', (data) => {
        Swal.fire({
            title: 'ğŸ›ï¸ KONSEY Ã‡AÄRISI',
            text: `${data.from} seni konsey odasÄ±na bekliyor!`,
            icon: 'info',
            confirmButtonColor: '#00f3ff',
            confirmButtonText: 'ODAYA GÄ°T',
            background: '#0a0b0c',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/meeting";
            }
        });
    });

    // --- 3. FONKSÄ°YONLAR ---

    // Mesaj Ekleme
    function appendMessage(sender, text, isHistory = false) {
        const box = document.getElementById('chatMessages');
        if (!box) return;
        const div = document.createElement('div');
        div.className = "msg-entry";
        if (isHistory) div.style.opacity = "0.6";
        
        // GÃ¶nderen SÄ°STEM ise farklÄ± renk yapabilirsin
        const tagClass = (sender === "SÄ°STEM") ? "text-danger" : "sender-tag";
        
        div.innerHTML = `<span class="${tagClass}" onclick="openUserMenu('${sender}')">[${sender}]</span> 
                         <span class="text-light small">${text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // Mesaj GÃ¶nderme
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input && input.value.trim()) {
            socket.emit('chat-message', { text: input.value.trim() });
            input.value = "";
        }
    }

    // KullanÄ±cÄ± MenÃ¼sÃ¼nÃ¼ AÃ§
    function openUserMenu(nick) {
        if (nick === myNick || nick === "SÄ°STEM") return;
        selectedUser = nick;
        const label = document.getElementById('selectedUserLabel');
        if (label) label.innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
    }

    // MenÃ¼yÃ¼ Kapat
    function closePanel() { 
        document.getElementById('userActionPanel').style.display = 'none'; 
    }

    // MenÃ¼ AksiyonlarÄ±nÄ± GÃ¶nder (Hediye, Arena, Konsey)
    async function sendAction(type) {
        closePanel();
        
        if (type === 'gift') {
            const { value: amt } = await Swal.fire({
                title: 'M miktar girin',
                input: 'number',
                inputLabel: 'GÃ¶nderilecek BPL MiktarÄ±',
                inputPlaceholder: 'Ã–rn: 100',
                background: '#111',
                color: '#fff',
                confirmButtonText: 'GÃ–NDER'
            });
            if (amt && amt > 0) {
                socket.emit('send-gift-bpl', { to: selectedUser, amount: amt });
            }
        } 
        
        else if (type === 'arena') {
            socket.emit('arena-invite-request', { to: selectedUser });
            Swal.fire({ 
                icon: 'success', 
                title: 'DÃ¼ello Ä°letildi', 
                text: 'Davet gÃ¶nderildi, 50 BPL tahsil edildi.', 
                timer: 2000, 
                showConfirmButton: false,
                background: '#000', 
                color: '#fff' 
            });
        }
        
        else if (type === 'meeting') {
            socket.emit('send-meeting-invite', { target: selectedUser });
            Swal.fire({ 
                icon: 'info', 
                title: 'Konsey Ã‡aÄŸrÄ±sÄ±', 
                text: 'Davet iletildi, 50 BPL dÃ¼ÅŸÃ¼ldÃ¼. Odaya aktarÄ±lÄ±yorsunuz...', 
                timer: 2000, 
                showConfirmButton: false,
                background: '#000', 
                color: '#fff' 
            });
            setTimeout(() => { window.location.href = "/meeting"; }, 1600);
        }
    }
</script>
</body>
</html>

