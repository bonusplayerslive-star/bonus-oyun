<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL - Stratejik Operasyon Merkezi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-turq: #00f2ff; --neon-red: #ff004c; --bg-dark: #050a0f; }
        body { 
            background-color: var(--bg-dark); color: #fff; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex;
            padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
        }

        /* Ana Panel */
        .main-layout { display: flex; width: 100%; gap: 10px; height: 95vh; margin-top: auto; margin-bottom: auto; }

        /* Sol Taraf: Chat */
        .chat-section { 
            flex: 3; border: 2px solid var(--neon-turq); border-radius: 15px; 
            box-shadow: 0 0 15px rgba(0,242,255,0.3); display: flex; flex-direction: column; background: rgba(0,0,0,0.4);
        }

        /* Sağ Taraf: Aktif Kullanıcılar */
        .users-section { 
            flex: 1; border: 1px solid rgba(0,242,255,0.3); border-radius: 15px; 
            background: rgba(0,0,0,0.6); display: flex; flex-direction: column; padding: 10px;
        }

        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Mesaj Stilleri */
        .msg-line { margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .msg-sender { color: var(--neon-turq); font-weight: 700; text-shadow: 0 0 5px var(--neon-turq); }
        .msg-text { color: #fff; text-shadow: 0 0 2px rgba(255,255,255,0.3); }
        .msg-system { color: var(--neon-red); font-weight: bold; animation: pulse 1s infinite; }

        /* Kullanıcı Listesi ve Butonlar */
        .user-item { 
            padding: 8px; border-bottom: 1px solid rgba(0,242,255,0.2); 
            display: flex; flex-direction: column; gap: 5px;
        }
        .user-actions { display: flex; gap: 5px; }
        .btn-mini { font-size: 10px; padding: 2px 6px; border-radius: 5px; font-family: 'Orbitron'; }

        /* Giriş Alanı */
        .input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.8); }
        .neon-input { 
            flex: 1; background: transparent; border: 1px solid var(--neon-turq); 
            color: #fff; border-radius: 20px; padding: 8px 15px; 
        }
        .btn-send-neon { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--neon-red); 
            border: none; box-shadow: 0 0 15px var(--neon-red); color: #fff;
        }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @media (max-width: 768px) { .main-layout { flex-direction: column; } .users-section { flex: 0.4; } }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="chat-section">
        <div class="p-2 border-bottom border-info d-flex justify-content-between">
            <span style="color:var(--neon-turq); font-family:'Orbitron'">STRATEJİK KANAL</span>
            <a href="/profil" class="btn btn-outline-info btn-sm" style="font-size: 10px;">GERİ DÖN</a>
        </div>
        <div id="chat-messages"></div>
        <form id="chat-form" class="input-area">
            <input type="text" id="chat-input" class="neon-input" placeholder="Mesaj..." autocomplete="off">
            <button type="submit" class="btn-send-neon">➤</button>
        </form>
    </div>

    <div class="users-section">
        <h6 class="text-center border-bottom pb-2" style="color:var(--neon-turq)">AKTİF KOMUTANLAR</h6>
        <div id="user-list" class="overflow-auto"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const userList = document.getElementById('user-list');

    // 1. MESAJLAŞMA SİSTEMİ
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (chatInput.value.trim()) {
            socket.emit('chat-message', { text: chatInput.value });
            chatInput.value = '';
        }
    });

    socket.on('new-message', (data) => {
        const div = document.createElement('div');
        div.className = 'msg-line';
        if(data.sender === "SİSTEM") {
            div.innerHTML = `<span class="msg-system">⚠️ ${data.text}</span>`;
        } else {
            div.innerHTML = `<span class="msg-sender">${data.sender}:</span> <span class="msg-text">${data.text}</span>`;
        }
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // 2. AKTİF KULLANICILAR VE AKSİYON BUTONLARI
    socket.on('update-online-users', (users) => {
        userList.innerHTML = '';
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <span style="font-size:13px">${u.nickname}</span>
                <div class="user-actions">
                    <button class="btn btn-danger btn-mini" onclick="inviteArena('${u.nickname}')">ARENA</button>
                    <button class="btn btn-warning btn-mini" onclick="sendGift('${u.nickname}')">BPL</button>
                    <button class="btn btn-info btn-mini" onclick="inviteMeeting('${u.nickname}')">MEET</button>
                </div>
            `;
            userList.appendChild(div);
        });
    });

    // 3. FONKSİYONLAR (HEDİYE, ARENA, MEETING)
    function sendGift(nick) {
        Swal.fire({
            title: `BPL Gönder: ${nick}`,
            input: 'number',
            inputLabel: 'Miktar (100 - 2000)',
            showCancelButton: true,
            confirmButtonColor: '#ff004c',
            background: '#050a0f',
            color: '#fff'
        }).then((res) => {
            if (res.isConfirmed) socket.emit('send-gift-bpl', { to: nick, amount: res.value });
        });
    }

    function inviteArena(nick) {
        socket.emit('arena-invite-request', { to: nick });
        Swal.fire({ title: 'Davet gönderildi...', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
    }

    function inviteMeeting(nick) {
        socket.emit('send-meeting-invite', { target: nick });
        Swal.fire({ title: 'Meeting daveti iletildi!', icon: 'success', timer: 1500 });
    }

    // 4. GELEN DAVETLERİN KARŞILANMASI
    socket.on('arena-invite-received', (data) => {
        Swal.fire({
            title: 'ARENA DAVETİ!',
            text: `${data.from} seni düelloya çağırıyor! (25 BPL)`,
            showCancelButton: true,
            confirmButtonText: 'KABUL ET',
            cancelButtonText: 'REDDET'
        }).then((res) => {
            if (res.isConfirmed) socket.emit('arena-invite-accept', { from: data.from });
        });
    });

    socket.on('meeting-invite-received', (data) => {
        Swal.fire({
            title: 'MEETING DAVETİ',
            text: `${data.from} seni masasına bekliyor.`,
            showCancelButton: true,
            confirmButtonText: 'KATIL',
        }).then((res) => {
            if (res.isConfirmed) window.location.href = `/meeting?room=${data.room}&role=guest`;
        });
    });

    // Yönlendirmeler
    socket.on('force-arena-match', (data) => window.location.href = `/arena?room=${data.room}`);
    socket.on('force-join-meeting', (data) => window.location.href = `/meeting?room=${data.room}&role=${data.role || 'guest'}`);
    socket.on('error', (msg) => Swal.fire('Hata', msg, 'error'));

</script>
</body>
</html>
