<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL | STRATEJƒ∞K ƒ∞LETƒ∞≈ûƒ∞M MERKEZƒ∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --neon-blue: #00f3ff; 
            --neon-red: #ff003c; 
            --neon-green: #39FF14; 
            --terminal-dark: #0a0b0c;
            --panel-bg: rgba(10, 11, 12, 0.95);
        }

        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            color: #e0e0e0; 
            font-family: 'Rajdhani', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* √úst Bilgi Paneli */
        .header-status { 
            padding: 12px 20px; 
            background: linear-gradient(90deg, #000 0%, #111 50%, #000 100%);
            border-bottom: 2px solid var(--neon-green);
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
            z-index: 10;
        }

        .status-item { font-family: 'Orbitron', sans-serif; font-size: 0.8rem; letter-spacing: 1px; }
        .val-neon { color: var(--neon-green); text-shadow: 0 0 5px var(--neon-green); }

        /* Mesaj Alanƒ± */
        .chat-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 15px; 
            background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
        }

        #chatMessages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(57, 255, 20, 0.15); 
            border-radius: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-green) transparent;
        }

        /* Mesaj Balonlarƒ± */
        .msg-entry { 
            margin-bottom: 8px; 
            padding: 8px 12px; 
            background: rgba(255, 255, 255, 0.03); 
            border-left: 3px solid transparent;
            transition: 0.3s;
        }
        .msg-entry:hover { background: rgba(57, 255, 20, 0.05); border-left-color: var(--neon-green); }
        
        .sender-tag { 
            color: #FFFF00; 
            font-weight: 700; 
            cursor: pointer; 
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            margin-right: 8px;
        }
        .sender-tag:hover { text-shadow: 0 0 8px #FFFF00; }

        /* Kullanƒ±cƒ± Aksiyon Paneli */
        #userActionPanel { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 320px; 
            background: var(--panel-bg); 
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3);
            border-radius: 0; 
            padding: 25px; 
            z-index: 4000;
        }
        
        #userActionPanel::before {
            content: "USER_ID_AUTH_REQUIRED";
            position: absolute; top: -10px; left: 10px;
            background: var(--neon-blue); color: #000;
            font-size: 0.6rem; padding: 2px 5px; font-weight: bold;
        }

        .btn-action {
            width: 100%; padding: 12px; margin-bottom: 10px;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
            text-transform: uppercase; border-radius: 0; transition: 0.3s;
        }
        .btn-gift { border: 1px solid var(--neon-red); color: var(--neon-red); background: transparent; }
        .btn-gift:hover:not(:disabled) { background: var(--neon-red); color: #fff; }
        .btn-fight { border: 1px solid var(--neon-blue); color: var(--neon-blue); background: transparent; }
        .btn-fight:hover { background: var(--neon-blue); color: #000; }

        /* Giri≈ü Alanƒ± */
        .input-footer { padding: 15px; background: #000; border-top: 1px solid #222; }
        .terminal-input {
            background: #0a0a0a !important;
            border: 1px solid #333 !important;
            color: var(--neon-green) !important;
            border-radius: 0 !important;
            font-family: 'Courier New', monospace;
        }
        .btn-send { 
            border-radius: 0 !important; 
            background: var(--neon-green) !important; 
            color: #000 !important; 
            font-weight: bold;
        }

        /* Animasyon */
        .scanline {
            width: 100%; height: 2px; background: rgba(57, 255, 20, 0.1);
            position: absolute; top: 0; left: 0; animation: scan 4s linear infinite; z-index: 5;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>

<div class="scanline"></div>

<div class="header-status d-flex justify-content-between">
    <div class="status-item text-muted">USER: <span class="val-neon"><%= user.nickname %></span></div>
    <div class="status-item text-muted">NODE: <span class="text-white">GLOBAL_LOBBY_01</span></div>
    <div class="status-item text-muted">CREDITS: <span id="myBpl" class="text-warning"><%= user.bpl %></span> BPL</div>
</div>

<div class="chat-container">
    <div id="chatMessages">
        <div class="msg-entry">
            <span class="sender-tag" style="color:var(--neon-blue)">[SISTEM]:</span>
            <span class="text-info">G√ºvenli hat kuruldu. Komuta merkezine ho≈ü geldiniz.</span>
        </div>
    </div>
</div>

<div id="userActionPanel">
    <h5 id="selectedUserLabel" class="text-center text-white mb-4 fs-6">HEDEF SE√áƒ∞LDƒ∞</h5>
    <button id="giftBtn" class="btn btn-action btn-gift">üéÅ LOJƒ∞STƒ∞K DESTEK</button>
    <button id="fightBtn" class="btn btn-action btn-fight">‚öîÔ∏è D√úELLO TALEBƒ∞</button>
    <button onclick="closePanel()" class="btn btn-sm text-muted w-100 mt-2">ƒ∞PTAL</button>
</div>

<div class="input-footer">
    <form id="chatForm" onsubmit="return false;">
        <div class="input-group">
            <span class="input-group-text bg-dark border-secondary text-success">></span>
            <input type="text" id="messageInput" class="form-control terminal-input" placeholder="Komut veya mesaj girin..." autocomplete="off">
            <button onclick="sendMessage()" class="btn btn-send"><i class="fas fa-bolt me-2"></i>G√ñNDER</button>
        </div>
    </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const userId = "<%= user._id %>";
    let myBpl = <%= user.bpl %>;
    let selectedUser = "";

    socket.emit('register-user', { id: userId, nickname: myNick });

    function openUserMenu(nick) {
        if(nick === myNick || nick === "Sƒ∞STEM" || nick === "ARENA_SISTEM") return;
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = "HEDEF: " + nick;
        document.getElementById('userActionPanel').style.display = 'block';
        
        const giftBtn = document.getElementById('giftBtn');
        if(myBpl < 6000) {
            giftBtn.disabled = true;
            giftBtn.innerHTML = "<small>Yetersiz Kredi (Min 6k)</small>";
        } else {
            giftBtn.disabled = false;
            giftBtn.innerHTML = "üéÅ LOJƒ∞STƒ∞K DESTEK (Hediye)";
            giftBtn.onclick = () => sendBplGift(nick);
        }

        document.getElementById('fightBtn').onclick = () => challengeToFight(nick);
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    function sendBplGift(nick) {
        Swal.fire({
            title: 'Lojistik Transfer',
            text: `${nick} komutanƒ±na ka√ß BPL g√∂ndereceksin? (Maks: 1000)`,
            input: 'number',
            background: '#0a0a0a',
            color: '#fff',
            confirmButtonColor: '#ff003c',
            showCancelButton: true
        }).then((result) => {
            if (result.value && result.value > 0 && result.value <= 1000) {
                socket.emit('transfer-bpl', { to: nick, amount: parseInt(result.value) });
                closePanel();
            }
        });
    }

    function challengeToFight(nick) {
        socket.emit('send-challenge', { target: nick });
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'info',
            title: `${nick} komutanƒ±na meydan okundu!`,
            showConfirmButton: false,
            timer: 3000
        });
        closePanel();
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(text) {
            socket.emit('chat-message', { text: text });
            input.value = "";
        }
    }

    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    socket.on('new-message', (data) => {
        const box = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = "msg-entry";
        
        div.innerHTML = `<span class="sender-tag" onclick="openUserMenu('${data.sender}')">${data.sender}:</span> 
                         <span class="text-light">${data.text}</span>`;
        
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    socket.on('gift-result', (data) => {
        Swal.fire({ icon: 'info', title: 'Sistem Mesajƒ±', text: data.message, background: '#0a0a0a', color: '#fff' });
        if(data.newBalance) {
            myBpl = data.newBalance;
            document.getElementById('myBpl').innerText = myBpl;
        }
    });

    socket.on('challenge-received', (data) => {
        Swal.fire({
            title: 'D√úELLO TALEBƒ∞!',
            text: `${data.from} seni ARENA'YA √ßaƒüƒ±rƒ±yor!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'KABUL ET',
            cancelButtonText: 'REDDET',
            background: '#0a0a0a',
            color: '#fff',
            confirmButtonColor: '#00f3ff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/arena?opponent=" + data.from;
            }
        });
    });
</script>
</body>
</html>
