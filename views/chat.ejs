// Path: views\chat.ejs
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL Global Chat & Lobi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            background: #000; color: #39FF14; 
            font-family: 'Courier New', monospace; 
            overflow-x: hidden; 
            height: 100vh; 
            display: flex; flex-direction: column;
        }
        
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; z-index: 1000;
        }
        .page-logo { width: 60px; height: auto; border: 1px solid #39FF14; border-radius: 5px; }

        .main-wrapper {
            flex: 1; display: flex; flex-direction: column;
            max-width: 900px; margin: 0 auto; width: 100%;
            padding: 10px;
        }

        .chat-container {
            flex: 1;
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #39FF14; border-radius: 15px;
            padding: 15px; display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
            min-height: 0;
        }

        #chatMessages {
            flex: 1; overflow-y: auto;
            border-bottom: 1px solid #39FF14; margin-bottom: 10px; padding: 10px;
            scrollbar-width: thin; scrollbar-color: #39FF14 #000;
        }

        .msg { margin-bottom: 8px; padding: 5px 10px; border-radius: 8px; background: rgba(57, 255, 20, 0.05); border-left: 3px solid #39FF14; font-size: 0.95rem; }
        .msg b { color: #FFFF00; cursor: pointer; }
        .system-msg { color: #00FFFF; font-style: italic; border-left: 3px solid #00FFFF; }

        .room-sidebar {
            background: rgba(255, 255, 0, 0.05);
            border: 1px solid #FFFF00; padding: 15px; border-radius: 10px;
            margin-top: 10px; text-align: center;
        }

        #giftOverlay {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; text-align: center; pointer-events: none;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 20px; border: 2px solid #FFFF00;
        }

        .invite-box {
            border: 2px solid #FFFF00; padding: 12px; margin: 10px 0; 
            background: rgba(0,0,0,0.95); color: #fff; border-radius: 10px; 
            text-align: center; box-shadow: 0 0 15px rgba(255, 255, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="header-bar">
    <img src="/caracter/page/logo.jpeg" class="page-logo">
    <div class="d-flex gap-2">
        <div class="p-2 border border-warning text-warning small">BAKƒ∞YE: <span id="myBpl"><%= user.bpl %></span> BPL</div>
        <a href="/profil?id=<%= user.id %>" class="btn btn-sm btn-outline-success">PROFƒ∞L</a>
        <a href="/arena?id=<%= user.id %>" class="btn btn-sm btn-outline-warning">ARENA</a>
    </div>
</div>

<div id="giftOverlay">
    <div style="font-size: 50px;">üéÅ</div>
    <h2 id="giftAnnounce" style="color: #FFFF00; text-shadow: 0 0 10px #000;"></h2>
</div>

<div class="main-wrapper">
    <div class="chat-container">
        <h5 class="text-center mb-0">GLOBAL LOBƒ∞</h5>
        <p class="text-center x-small text-muted mb-2" style="font-size: 0.7rem;">Hediye: Nicke Tƒ±kla (Min: 6000 BPL Bakiyeliler)</p>
        
        <div id="chatMessages"></div>

        <div class="input-group">
            <input type="text" id="messageInput" class="form-control bg-dark text-white border-success" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
            <button onclick="sendMessage()" class="btn btn-success">G√ñNDER</button>
        </div>
    </div>

    <div class="room-sidebar">
        <h6 class="mb-1">√ñZEL BE≈ûGEN MASA</h6>
        <p class="small mb-2">50 BPL / Kamera ve Sesli Sohbet</p>
        <form action="/create-meeting?id=<%= user.id %>" method="POST">
            <button type="submit" class="btn btn-warning btn-sm fw-bold w-100">ODA KUR VE Sƒ∞NYAL G√ñNDER</button>
        </form>
    </div>
</div>

<script>
    const socket = io();
    const myId = "<%= user.id %>";
    const myNick = "<%= user.nickname %>";
    const chatBox = document.getElementById('chatMessages');

    // 1. Odaya Katƒ±l
    socket.emit('join-chat', { room: 'Global', nickname: myNick, userId: myId });

    // 2. Mesaj G√∂nderme
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input.value.trim() !== "") {
            socket.emit('chat-message', { 
                room: 'Global', 
                message: input.value, 
                nickname: myNick 
            });
            input.value = "";
        }
    }

    // 3. Mesaj Alma
    socket.on('new-message', (data) => {
        const div = document.createElement('div');
        div.className = (data.sender === "Sƒ∞STEM" || data.sender === "Sistem") ? "msg system-msg" : "msg";
        div.innerHTML = `<b onclick="promptGift('${data.sender}')">${data.sender}:</b> ${data.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 4. Davet Sinyali Yakalama
    socket.on('receive-meeting-invite', (data) => {
        if (data.toNick === "Herkes" || data.toNick.toLowerCase() === myNick.toLowerCase()) {
            const inviteMsg = document.createElement('div');
            inviteMsg.className = "invite-box";
            inviteMsg.innerHTML = `
                <p>üîî <strong>Sƒ∞NYAL:</strong> ${data.from} seni Be≈ügen Masa'ya √ßaƒüƒ±rdƒ±!</p>
                <button onclick="window.location.href='/meeting?userId=${myId}&roomId=${data.room}'" 
                        class="btn btn-warning btn-sm fw-bold">
                    KATIL
                </button>
            `;
            chatBox.appendChild(inviteMsg);
            chatBox.scrollTop = chatBox.scrollHeight;
            alert("Sƒ∞NYAL ALINDI: " + data.from + " seni masaya √ßaƒüƒ±rƒ±yor!");
        }
    });

    // 5. HEDƒ∞YE Sƒ∞STEMƒ∞ (G√úNCEL KURALLAR)
    function promptGift(targetNick) {
        if(targetNick === myNick || targetNick === "Sƒ∞STEM" || targetNick === "Sistem") return;

        // Bakiye Kontrol√º (Aray√ºzde hƒ±zlƒ± engel)
        const currentBpl = parseInt(document.getElementById('myBpl').innerText);
        if(currentBpl < 6000) {
            alert("Hediye g√∂ndermek i√ßin hesabƒ±nƒ±zda en az 6000 BPL bulunmalƒ±dƒ±r!");
            return;
        }

        const amount = prompt(`${targetNick} kullanƒ±cƒ±sƒ±na ne kadar BPL g√∂ndereceksiniz? (Maks: 500 BPL)`);
        
        if(amount && !isNaN(amount)) {
            const val = parseInt(amount);
            
            if(val <= 0) return;
            if(val > 500) {
                alert("Tek seferde en fazla 500 BPL g√∂nderebilirsiniz!");
                return;
            }

            socket.emit('send-gift', { 
                userId: myId, 
                to: targetNick, 
                amount: val, 
                room: 'Global' 
            });
        }
    }

    // Hediye Sonucu (Animasyon ve Bakiye G√ºncelleme)
    socket.on('gift-result', (data) => {
        if(data.newBalance !== undefined) {
            document.getElementById('myBpl').innerText = data.newBalance;
        }
        
        const overlay = document.getElementById('giftOverlay');
        const announce = document.getElementById('giftAnnounce');
        
        announce.innerText = data.message;
        overlay.style.display = 'block';
        
        setTimeout(() => { 
            overlay.style.display = 'none'; 
        }, 3500);
    });

    // Enter Tu≈üu Desteƒüi
    document.getElementById('messageInput').addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>

</body>
</html>