<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJƒ∞K ƒ∞LETƒ∞≈ûƒ∞M</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; --gold: #ffc107; --terminal-dark: #0a0b0c; }
        body { background: #000; color: #e0e0e0; font-family: 'Rajdhani', sans-serif; height: 100dvh; display: flex; flex-direction: column; margin: 0; overflow: hidden; position: fixed; width: 100%; }

        /* Ana Yerle≈üim */
        .main-layout { display: flex; flex: 1; min-height: 0; }
        
        /* Sohbet Alanƒ± */
        .chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.8); }

        /* Online Panel (Saƒü Taraf) */
        .online-panel { width: 250px; background: #050505; border-left: 1px solid var(--neon-green); overflow-y: auto; }
        @media (max-width: 768px) { .online-panel { display: none; } /* iPhone'da alanƒ± korumak i√ßin gizledim, men√ºden eri≈üilecek */ }
        
        .user-list-item { padding: 10px; border-bottom: 1px solid #111; cursor: pointer; transition: 0.2s; font-size: 0.8rem; display: flex; align-items: center; }
        .user-list-item:hover { background: rgba(57, 255, 20, 0.1); }
        .status-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px var(--neon-green); }

        /* Mesaj Stilleri */
        .msg-entry { margin-bottom: 8px; padding: 8px; border-left: 3px solid transparent; background: rgba(255,255,255,0.02); }
        .history-divider { text-align: center; border-bottom: 1px solid #333; line-height: 0.1em; margin: 20px 0; color: #555; font-size: 0.7rem; }
        .sender-tag { color: var(--gold); font-weight: bold; cursor: pointer; font-family: 'Orbitron'; font-size: 0.75rem; margin-right: 5px; }

        /* Aksiyon Paneli (Pop-up) */
        #userActionPanel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 300px; background: rgba(0,0,0,0.95); border: 2px solid var(--neon-blue); padding: 20px; z-index: 5000; border-radius: 10px; }
        .btn-action { width: 100%; padding: 12px; margin-bottom: 8px; font-family: 'Orbitron'; font-size: 0.75rem; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header-status d-flex justify-content-between p-2 bg-dark border-bottom border-success">
    <div class="status-item small text-uppercase font-orbitron">ID: <span class="val-neon"><%= user.nickname %></span></div>
    <div class="status-item small font-orbitron text-warning">BPL: <span id="myBpl"><%= user.bpl %></span></div>
</div>

<div class="main-layout">
    <div class="chat-section">
        <div id="chatMessages">
            <div class="history-divider"><span>SON 1 SAATLƒ∞K GE√áMƒ∞≈û</span></div>
        </div>
        
        <div class="input-footer p-2 bg-black border-top border-secondary">
            <form id="chatForm" onsubmit="sendMessage(); return false;" class="input-group">
                <input type="text" id="messageInput" class="form-control bg-dark text-success border-secondary" placeholder="Mesaj yaz..." autocomplete="off">
                <button type="submit" class="btn btn-success px-4"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <div class="online-panel">
        <div class="p-2 border-bottom border-secondary text-center font-orbitron small text-success">AKTƒ∞F OYUNCULAR</div>
        <div id="onlineUserList">
            </div>
    </div>
</div>

<div id="userActionPanel">
    <h6 id="selectedUserLabel" class="text-center text-info mb-3 font-orbitron">HEDEF SE√áƒ∞LDƒ∞</h6>
    <button onclick="sendAction('gift')" class="btn btn-outline-danger btn-action">üéÅ HEDƒ∞YE (BPL)</button>
    <button onclick="sendAction('arena')" class="btn btn-outline-info btn-action">‚öîÔ∏è ARENA (D√úELLO)</button>
    <button onclick="sendAction('meeting')" class="btn btn-outline-warning btn-action">üèõÔ∏è KONSEY (50 BPL)</button>
    <button onclick="closePanel()" class="btn btn-sm btn-dark w-100 mt-2 text-muted">KAPAT</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    let selectedUser = "";

    // --- 1. Sƒ∞STEM Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
    socket.on('update-bpl', (newBpl) => {
        const bplElement = document.getElementById('myBpl');
        if (bplElement) bplElement.innerText = newBpl;
    });

    socket.on('error', (msg) => {
        Swal.fire("Sistem Mesajƒ±", msg, "info");
    });

    socket.on('load-history', (history) => {
        const box = document.getElementById('chatMessages');
        history.forEach(msg => appendMessage(msg.sender, msg.text, true));
    });

    socket.on('new-message', (data) => {
        appendMessage(data.sender, data.text);
    });

    socket.on('update-online-users', (users) => {
        const list = document.getElementById('onlineUserList');
        if (!list) return;
        list.innerHTML = "";
        users.forEach(u => {
            if (u.nickname !== myNick) {
                const item = document.createElement('div');
                item.className = "user-list-item";
                item.onclick = () => openUserMenu(u.nickname);
                item.innerHTML = `<div class="status-dot"></div><span>${u.nickname}</span>`;
                list.appendChild(item);
            }
        });
    });

    // --- 2. DAVET VE ARENA Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
    socket.on('arena-invite-received', (data) => {
        Swal.fire({
            title: '‚öîÔ∏è ARENA MEYDAN OKUMASI!',
            text: `${data.from} seni d√ºelloya davet ediyor! (50 BPL)`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'KABUL ET',
            cancelButtonText: 'REDDET',
            background: '#0a0b0c',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                // Kabul edince sunucuya bildir (Arena odasƒ±na y√∂nlendirme backend'den yapƒ±lacak)
                socket.emit('arena-join-queue', { bet: 25, prize: 50 }); 
            }
        });
    });

    socket.on('meeting-invite-received', (data) => {
        Swal.fire({
            title: 'üèõÔ∏è KONSEY √áAƒûRISI',
            text: `${data.from} seni VIP odasƒ±na davet etti!`,
            icon: 'info',
            confirmButtonText: 'Gƒ∞T',
            background: '#0a0b0c',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/meeting?room=" + data.from;
            }
        });
    });

    // --- 3. FONKSƒ∞YONLAR ---
    function appendMessage(sender, text, isHistory = false) {
        const box = document.getElementById('chatMessages');
        if (!box) return;
        const div = document.createElement('div');
        div.className = "msg-entry";
        const tagClass = (sender === "Sƒ∞STEM") ? "text-danger" : "sender-tag";
        div.innerHTML = `<span class="${tagClass}" onclick="openUserMenu('${sender}')">[${sender}]</span> 
                         <span class="text-light small">${text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input && input.value.trim()) {
            socket.emit('chat-message', { text: input.value.trim() });
            input.value = "";
        }
    }

    function openUserMenu(nick) {
        if (nick === myNick || nick === "Sƒ∞STEM") return;
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    async function sendAction(type) {
        closePanel();
        if (type === 'gift') {
            const { value: amt } = await Swal.fire({
                title: 'BPL G√∂nder',
                input: 'number',
                background: '#111', color: '#fff'
            });
            if (amt > 0) socket.emit('send-gift-bpl', { to: selectedUser, amount: amt });
        } else if (type === 'arena') {
            socket.emit('arena-invite-request', { to: selectedUser });
        } else if (type === 'meeting') {
            socket.emit('send-meeting-invite', { target: selectedUser });
            window.location.href = "/meeting?room=" + myNick;
        }
    }
</script>
</body>
</html>


