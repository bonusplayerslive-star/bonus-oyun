<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL Global Chat & Lobi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: #000; color: #39FF14; 
            font-family: 'Courier New', monospace; 
            height: 100vh; display: flex; flex-direction: column;
        }
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .page-logo { width: 50px; border: 1px solid #39FF14; }
        .main-wrapper { flex: 1; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; width: 100%; padding: 10px; overflow: hidden; }
        .chat-container { flex: 1; background: rgba(0, 20, 0, 0.9); border: 2px solid #39FF14; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; min-height: 0; }
        #chatMessages { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #333; }
        .msg { margin-bottom: 8px; padding: 5px 10px; border-left: 3px solid #39FF14; background: rgba(57, 255, 20, 0.05); }
        .msg b { color: #FFFF00; cursor: pointer; }
        .system-msg { color: #00FFFF; border-left-color: #00FFFF; font-style: italic; }
        .invite-box { border: 2px solid #FFFF00; padding: 10px; margin: 10px 0; background: #000; text-align: center; border-radius: 10px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #giftOverlay { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background: rgba(0,0,0,0.9); padding: 30px; border: 3px solid #FFFF00; border-radius: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="header-bar">
    <img src="/caracter/page/logo.jpeg" class="page-logo" onerror="this.src='/caracter/logo/logo.jpeg'">
    <div class="d-flex gap-2">
        <div class="p-2 border border-warning text-warning small">BAKƒ∞YE: <span id="myBpl"><%= user.bpl %></span> BPL</div>
        <a href="/profil" class="btn btn-sm btn-outline-success">PROFƒ∞L</a>
    </div>
</div>

<div id="giftOverlay">
    <div style="font-size: 60px;">üéÅ</div>
    <h3 id="giftAnnounce" style="color: #FFFF00;"></h3>
</div>

<div class="main-wrapper">
    <div class="chat-container">
        <h6 class="text-center">GLOBAL LOBƒ∞ (√úcretsiz)</h6>
        <div id="chatMessages"></div>
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control bg-dark text-white border-success" placeholder="Mesaj yazƒ±n...">
            <button onclick="sendMessage()" class="btn btn-success">G√ñNDER</button>
        </div>
    </div>

    <div class="mt-3 p-3 border border-warning rounded text-center" style="background: rgba(255, 255, 0, 0.05);">
        <p class="small mb-2 text-warning">Kamera ve Sesli Sohbet (50 BPL)</p>
        <form action="/create-meeting" method="POST">
            <button type="submit" class="btn btn-warning btn-sm fw-bold w-100">√ñZEL BE≈ûGEN MASA KUR</button>
        </form>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const myId = "<%= user._id %>";
    const chatBox = document.getElementById('chatMessages');

    // Kayƒ±t ve Odaya Giri≈ü
    socket.emit('register-user', { id: myId, nickname: myNick });
    socket.emit('join-chat', { room: 'Global' });

    // Mesaj G√∂nderme
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input.value.trim() !== "") {
            socket.emit('chat-message', { 
                nickname: myNick, 
                message: input.value,
                room: 'Global' 
            });
            input.value = "";
        }
    }

    // Mesaj Alma (Undefined Hatasƒ± Fixlendi)
    socket.on('new-message', (data) => {
        const div = document.createElement('div');
        div.className = (data.sender === "Sƒ∞STEM" || data.sender === "Sistem") ? "msg system-msg" : "msg";
        // Nicke tƒ±klayƒ±nca hediye penceresi a√ßƒ±lƒ±r
        div.innerHTML = `<b onclick="promptGift('${data.sender}')">${data.sender}:</b> ${data.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Be≈ügen Masa Daveti (Sinyal)
    socket.on('receive-meeting-invite', (data) => {
        const div = document.createElement('div');
        div.className = "invite-box";
        div.innerHTML = `
            <p class="mb-1 text-warning">üî• ${data.from} Be≈ügen Masa kurdu!</p>
            <a href="/meeting?roomId=${data.room}" class="btn btn-warning btn-xs">MASAYA OTUR</a>
        `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Hediye G√∂nderme (Backend Entegrasyonlu)
    function promptGift(targetNick) {
        if(targetNick === myNick || targetNick === "Sƒ∞STEM" || targetNick === "Sistem") return;
        
        const currentBpl = parseInt(document.getElementById('myBpl').innerText);
        if(currentBpl < 6000) {
            alert("Hediye g√∂ndermek i√ßin en az 6000 BPL bakiyeniz olmalƒ±dƒ±r!");
            return;
        }

        const amount = prompt(`${targetNick} kullanƒ±cƒ±sƒ±na ne kadar BPL (Max 500) g√∂ndereceksiniz?`);
        if(amount && !isNaN(amount) && amount > 0) {
            socket.emit('send-gift', { 
                userId: myId, 
                to: targetNick, 
                amount: parseInt(amount), 
                room: 'Global' 
            });
        }
    }

    // Hediye Sonucu ve Animasyon
    socket.on('gift-result', (data) => {
        if(data.newBalance !== undefined) {
            document.getElementById('myBpl').innerText = data.newBalance;
        }
        
        const overlay = document.getElementById('giftOverlay');
        document.getElementById('giftAnnounce').innerText = data.message;
        overlay.style.display = 'block';
        setTimeout(() => { overlay.style.display = 'none'; }, 3500);
    });

    // Enter tu≈üu
    document.getElementById('messageInput').addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>
</body>
</html>
