<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJÄ°K Ä°LETÄ°ÅÄ°M MERKEZÄ°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; 
            --terminal-dark: #0a0b0c; --panel-bg: rgba(10, 11, 12, 0.98); --gold: #ffcc00;
        }

        /* FHD+ EKRANLAR Ä°Ã‡Ä°N TAM ESNEK YAPI */
        body { 
            background: #000; color: #e0e0e0; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden;
        }

        .header-status { 
            height: 60px; background: #000; border-bottom: 2px solid var(--neon-green);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }

        .main-content { display: flex; flex: 1; overflow: hidden; }

        .online-sidebar {
            width: 80px; background: rgba(0,0,0,0.5); border-right: 1px solid #222;
            display: flex; flex-direction: column; align-items: center; padding: 10px 0;
            overflow-y: auto;
        }

        .chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }

        /* MesajlarÄ±n AktÄ±ÄŸÄ± Alan */
        #chatMessages { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .msg-entry { padding: 8px; border-left: 3px solid var(--neon-blue); background: rgba(255,255,255,0.02); }

        /* TELEFONDA KAYBOLAN INPUT ALANI BURASI */
        .input-footer { 
            background: #0a0a0a; padding: 15px; border-top: 1px solid #333;
            /* iPhone alt barÄ± iÃ§in koruma alanÄ± */
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .terminal-input { 
            background: #1a1a1a !important; border: 1px solid #444 !important; 
            color: var(--neon-green) !important; height: 45px; font-size: 16px; 
        }

        #userActionPanel { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 320px; background: var(--panel-bg); border: 2px solid var(--neon-blue);
            padding: 20px; z-index: 5000; text-align: center;
        }
        #userActionPanel button { width: 100%; margin-bottom: 8px; font-family: 'Orbitron'; padding: 12px; background: transparent; }
    </style>
</head>
<body>

<div class="header-status">
    <div class="status-item">USER: <span style="color:var(--neon-blue)"><%= user.nickname %></span></div>
    <div class="status-item">CREDITS: <span id="myBpl" style="color:var(--gold)"><%= user.bpl %></span></div>
</div>

<div class="main-content">
    <div class="online-sidebar" id="onlineUsersList"></div>
    <div class="chat-window">
        <div id="chatMessages">
            <div class="msg-entry"><span style="color:var(--neon-green)">[SÄ°STEM]: Komuta merkezi aktif.</span></div>
        </div>
    </div>
</div>

<div class="input-footer">
    <div class="input-group">
        <input type="text" id="messageInput" class="form-control terminal-input" placeholder="Mesaj..." autocomplete="off">
        <button onclick="sendMessage()" class="btn" style="background:var(--neon-green); color:#000; font-weight:bold;">GÃ–NDER</button>
    </div>
</div>

<div id="userActionPanel">
    <h5 id="selectedUserLabel" class="text-white">HEDEF</h5>
    <button id="giftBtn" style="border:1px solid var(--neon-red); color:var(--neon-red);">ğŸ LOJÄ°STÄ°K DESTEK</button>
    <button id="fightBtn" style="border:1px solid var(--neon-blue); color:var(--neon-blue);">âš”ï¸ ARENA (-50)</button>
    <button id="meetBtn" style="border:1px solid gold; color:gold;">ğŸ›ï¸ Ã–ZEL ODA (-30)</button>
    <button onclick="closePanel()" style="border:none; color:#666; margin-top:10px;">[ Ä°PTAL ]</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    let myBpl = <%= user.bpl %>;
    let selectedUser = "";

    // Mesaj GÃ¶nderme (Arena MantÄ±ÄŸÄ±yla AynÄ±)
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if(!input.value.trim()) return;

        // URL'den oda varsa al (Meeting/Arena iÃ§indeyse)
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('room');

        socket.emit('chat-message', { 
            text: input.value,
            room: roomId // Varsa oda ID'si, yoksa null gider (Global olur)
        });
        input.value = '';
    }

    // Mesaj Alma
    socket.on('new-message', (data) => {
        const params = new URLSearchParams(window.location.search);
        const currentRoom = params.get('room');

        // MantÄ±k: Mesaj odaya aitse ve ben o odadaysam VEYA mesaj globalsyse ve ben globaldeysem gÃ¶ster
        if (data.room === currentRoom) {
            const box = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = "msg-entry";
            div.innerHTML = `<b style="color:gold">${data.sender}:</b> <span class="text-light">${data.text}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    });

    // ... DiÄŸer Online Liste ve Davet KodlarÄ±n AynÄ± Kalabilir ...
    // Sadece sendMessage iÃ§indeki oda kontrolÃ¼ ve CSS deÄŸiÅŸikliÄŸi FHD+ sorununu Ã§Ã¶zer.
</script>
</body>
</html>
