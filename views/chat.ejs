<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL | STRATEJƒ∞K ƒ∞LETƒ∞≈ûƒ∞M MERKEZƒ∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; 
            --terminal-dark: #0a0b0c; --panel-bg: rgba(10, 11, 12, 0.98);
        }

        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            color: #e0e0e0; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0;
        }

        /* √úst Durum √áubuƒüu */
        .header-status { 
            height: 8vh; padding: 0 20px; background: #000; border-bottom: 2px solid var(--neon-green);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        .status-item { font-family: 'Orbitron'; font-size: 0.75rem; }

        /* Ana ƒ∞√ßerik Alanƒ± */
        .main-layout { display: flex; height: 82vh; width: 100vw; }

        /* Sol Dikey Men√º (Online Kullanƒ±cƒ±lar) */
        .online-sidebar {
            width: 80px; background: rgba(0,0,0,0.8); border-right: 1px solid #222;
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; overflow-y: auto;
        }
        .user-avatar {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--neon-green);
            margin-bottom: 15px; cursor: pointer; transition: 0.3s; position: relative;
        }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--neon-green); }
        .online-dot { 
            position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; 
            background: var(--neon-green); border-radius: 50%; border: 2px solid #000;
        }

        /* Chat Alanƒ± */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.5); position: relative; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.9rem; }

        .msg-entry { margin-bottom: 6px; padding: 6px 12px; border-radius: 4px; background: rgba(255,255,255,0.02); }
        .sender-tag { color: #FFFF00; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; }

        /* Aksiyon Paneli */
        #userActionPanel { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; max-width: 320px; background: var(--panel-bg); border: 2px solid var(--neon-blue);
            padding: 20px; z-index: 5000; box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        /* Footer Giri≈ü Alanƒ± */
        .input-footer { height: 10vh; background: #000; padding: 10px 15px; border-top: 1px solid #222; }
        .terminal-input { background: #050505 !important; border: 1px solid #333 !important; color: var(--neon-green) !important; font-family: monospace; }
        .btn-send { background: var(--neon-green) !important; color: #000 !important; font-weight: bold; }

        @media (max-width: 600px) { .online-sidebar { width: 65px; } .user-avatar { width: 40px; height: 40px; } }
    </style>
</head>
<body>

<div class="header-status">
    <div class="status-item"><span class="val-neon"><%= user.nickname %></span></div>
    <div class="status-item"><span id="myBpl" class="text-warning"><%= user.bpl %></span> BPL</div>
    <div id="peer-status" class="status-item text-danger small">OFFLINE</div>
</div>

<div class="main-layout">
    <div class="online-sidebar" id="onlineUsers">
        </div>

    <div class="chat-area">
        <div id="chatMessages"></div>
    </div>
</div>

<div id="userActionPanel">
    <h6 id="selectedUserLabel" class="text-center text-info mb-3 font-orbitron">HEDEF SE√áƒ∞LDƒ∞</h6>
    <button id="giftBtn" class="btn btn-action btn-gift btn-outline-danger w-100 mb-2">üéÅ HEDƒ∞YE G√ñNDER (%25 Vergi)</button>
    <button id="fightBtn" class="btn btn-action btn-fight btn-outline-info w-100 mb-2">‚öîÔ∏è ARENA D√úELLO (-50 BPL)</button>
    <button id="meetBtn" class="btn btn-action btn-meeting btn-outline-warning w-100 mb-2">üèõÔ∏è √ñZEL ODA (-30 BPL)</button>
    <button onclick="closePanel()" class="btn btn-sm text-muted w-100">KAPAT</button>
</div>

<div class="input-footer">
    <form id="chatForm" onsubmit="return false;">
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control terminal-input" placeholder="Mesaj yazƒ±n..." autocomplete="off">
            <button onclick="sendMessage()" class="btn btn-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
    const socket = io(); 
    const myNick = "<%= user.nickname %>";
    let myBpl = <%= user.bpl %>;
    let selectedUser = "";

    // 1. ONLINE Lƒ∞STESƒ∞ VE SOL MEN√ú G√úNCELLEME
    socket.on('update-user-list', (users) => {
        const sidebar = document.getElementById('onlineUsers');
        sidebar.innerHTML = '';
        users.forEach(u => {
            if(u.nickname !== myNick) {
                const div = document.createElement('div');
                div.className = 'user-avatar';
                div.title = u.nickname;
                div.innerHTML = `<img src="/caracter/page/logo.jpeg" style="width:100%; border-radius:50%">
                                 <div class="online-dot"></div>`;
                div.onclick = () => openUserMenu(u.nickname);
                sidebar.appendChild(div);
            }
        });
    });

    // 2. PANEL A√áILI≈ûI
    function openUserMenu(nick) {
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
        
        document.getElementById('giftBtn').onclick = () => showGiftPrompt(nick);
        document.getElementById('fightBtn').onclick = () => sendInvite(nick, 'arena', 50);
        document.getElementById('meetBtn').onclick = () => sendInvite(nick, 'meeting', 30);
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    // 3. HEDƒ∞YE Sƒ∞STEMƒ∞ (LIMITLƒ∞ VE VERGƒ∞Lƒ∞)
    function showGiftPrompt(nick) {
        Swal.fire({
            title: 'HEDƒ∞YE Mƒ∞KTARI',
            input: 'number',
            inputLabel: 'G√∂nderilecek BPL miktarƒ±nƒ± yazƒ±n',
            footer: '‚ö†Ô∏è %25 transfer √ºcreti kesilir. Alt limit: 5500 BPL',
            background: '#0a0a0a', color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'G√ñNDER'
        }).then((res) => {
            if(res.isConfirmed) {
                const amount = parseInt(res.value);
                if(amount <= 0) return;
                
                // Kural 1: 5500 Altƒ±na d√º≈üemez
                if(myBpl - amount < 5500) {
                    return Swal.fire('HATA', 'ƒ∞≈ülem sonrasƒ± bakiyeniz 5500 BPL altƒ±na d√º≈üemez!', 'error');
                }
                
                // Kural 2: 24 Saatlik 3000 Limit (Serverda da kontrol edilmeli)
                socket.emit('gift-bpl', { to: nick, amount: amount });
                closePanel();
            }
        });
    }

    // 4. ARENA & MEETING DAVETƒ∞
    function sendInvite(nick, type, cost) {
        if(myBpl < cost) return Swal.fire('HATA', 'Yetersiz bakiye!', 'error');
        
        Swal.fire({
            title: 'EMƒ∞N Mƒ∞Sƒ∞N?',
            text: `${nick} kullanƒ±cƒ±sƒ±nƒ± davet etmek i√ßin ${cost} BPL kesilecek.`,
            icon: 'warning',
            showCancelButton: true,
            background: '#0a0a0a', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) {
                socket.emit('send-invite', { to: nick, type: type, cost: cost });
                closePanel();
            }
        });
    }

    // 5. DAVET ALMA (SOCKET)
    socket.on('receive-invite', (data) => {
        Swal.fire({
            title: data.type === 'arena' ? '‚öîÔ∏è D√úELLO DAVETƒ∞!' : 'üèõÔ∏è √ñZEL ODA DAVETƒ∞!',
            text: `${data.from} seni √ßaƒüƒ±rƒ±yor.`,
            showCancelButton: true,
            confirmButtonText: 'KABUL ET',
            background: '#0a0a0a', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) {
                // Oda ismi davet edenin nickname'i olur
                const targetUrl = data.type === 'arena' ? `/arena?room=${data.from}` : `/meeting?room=${data.from}`;
                window.location.href = targetUrl;
            }
        });
    });

    // 6. CHAT FONKSƒ∞YONLARI
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if(input.value.trim()) {
            socket.emit('chat-message', { text: input.value });
            input.value = '';
        }
    }

    socket.on('new-message', (data) => {
        const box = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = "msg-entry";
        div.innerHTML = `<span class="sender-tag" onclick="openUserMenu('${data.sender}')">${data.sender}:</span> 
                         <span>${data.text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    socket.on('update-bpl', (newBpl) => {
        myBpl = newBpl;
        document.getElementById('myBpl').innerText = newBpl;
    });

    // PeerJS Baƒülantƒ± Durumu
    const peer = new Peer();
    peer.on('open', (id) => {
        document.getElementById('peer-status').innerText = "ONLINE";
        document.getElementById('peer-status').className = "status-item text-success small";
    });
</script>
</body>
</html>
