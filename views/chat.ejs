<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPL GLOBAL LOBƒ∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; }
        body { background: #000; color: var(--neon-green); font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .chat-wrapper { flex: 1; display: flex; flex-direction: column; padding: 10px; position: relative; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 10px; background: rgba(0,20,0,0.3); border: 1px solid rgba(57, 255, 20, 0.2); border-radius: 10px; }
        
        .msg { margin-bottom: 12px; font-size: 0.95rem; line-height: 1.4; border-bottom: 1px solid rgba(57, 255, 20, 0.05); padding-bottom: 5px; }
        .msg b { color: #FFFF00; cursor: pointer; text-decoration: underline; }
        
        #userActionPanel { 
            display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; background: rgba(0,0,0,0.95); border: 2px solid var(--neon-blue);
            border-radius: 15px; padding: 20px; z-index: 3000; box-shadow: 0 0 20px var(--neon-blue);
        }

        .btn-gift { background: transparent; border: 2px solid var(--neon-red); color: var(--neon-red); font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-gift:disabled { opacity: 0.3; border-color: #555; color: #555; }
        .btn-fight { background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue); font-weight: bold; width: 100%; }
        
        .header-info { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0a0a0a; border-bottom: 1px solid var(--neon-green); }
        .input-area { padding: 10px; background: #000; }
    </style>
</head>
<body>

<div class="header-info">
    <div class="small">LOBƒ∞: <span class="text-white"><%= user.nickname %></span></div>
    <div class="small text-warning">C√úZDAN: <span id="myBpl"><%= user.bpl %></span> BPL</div>
</div>

<div class="chat-wrapper">
    <div id="chatMessages"></div>
</div>

<div id="userActionPanel">
    <h6 id="selectedUserLabel" class="text-center text-white mb-3">KUMANDAN SE√áƒ∞LDƒ∞</h6>
    <button id="giftBtn" class="btn btn-gift">üéÅ HEDƒ∞YE G√ñNDER (MAX 1000)</button>
    <button id="fightBtn" class="btn btn-fight">‚öîÔ∏è KAVGAYA √áAƒûIR (ARENA)</button>
    <button onclick="closePanel()" class="btn btn-sm text-muted w-100 mt-2">KAPAT</button>
</div>

<div class="input-area">
    <form id="chatForm" onsubmit="return false;">
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control bg-dark text-white border-success" placeholder="Mesaj at..." autocomplete="off">
            <button onclick="sendMessage()" class="btn btn-success"><i class="fas fa-paper-plane"></i></button>
        </div>
    </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    const userId = "<%= user._id %>";
    let myBpl = <%= user.bpl %>;
    let selectedUser = "";

    // 1. ADIM: Sunucuya kim olduƒüumuzu kaydet (register-user)
    socket.emit('register-user', { id: userId, nickname: myNick });

    // Kullanƒ±cƒ± Men√ºs√ºn√º A√ß
    function openUserMenu(nick) {
        if(nick === myNick || nick === "Sƒ∞STEM" || nick === "ARENA_SISTEM") return;
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
        
        const giftBtn = document.getElementById('giftBtn');
        if(myBpl < 6000) {
            giftBtn.disabled = true;
            giftBtn.innerText = "HEDƒ∞YE (Mƒ∞N 6000 BPL GEREKLƒ∞)";
        } else {
            giftBtn.disabled = false;
            giftBtn.innerText = "üéÅ HEDƒ∞YE G√ñNDER (-%25 VERGƒ∞)";
            giftBtn.onclick = () => sendBplGift(nick);
        }

        document.getElementById('fightBtn').onclick = () => challengeToFight(nick);
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    // Hediye G√∂nder
    function sendBplGift(nick) {
        const amount = prompt(`${nick} i√ßin miktar (Max 1000):`);
        if(amount && amount > 0 && amount <= 1000) {
            socket.emit('transfer-bpl', { to: nick, amount: parseInt(amount) });
            closePanel();
        }
    }

    // Meydan Oku
    function challengeToFight(nick) {
        socket.emit('send-challenge', { target: nick });
        alert(nick + " meydan okuma g√∂nderildi!");
        closePanel();
    }

    // Mesaj G√∂nder
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(text) {
            socket.emit('chat-message', { text: text });
            input.value = "";
        }
    }

    // Enter tu≈üu ile mesaj g√∂nder
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // Yeni Mesaj Geldiƒüinde
    socket.on('new-message', (data) => {
        const box = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = "msg";
        
        // G√∂nderen ismine tƒ±klayƒ±nca men√º a√ßƒ±lmasƒ± i√ßin
        div.innerHTML = `<b onclick="openUserMenu('${data.sender}')">${data.sender}:</b> ${data.text}`;
        
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    // Transfer Sonucu
    socket.on('gift-result', (data) => {
        alert(data.message);
        if(data.newBalance) {
            myBpl = data.newBalance;
            document.getElementById('myBpl').innerText = myBpl;
        }
    });

    // Meydan Okuma Alƒ±ndƒ±ƒüƒ±nda
    socket.on('challenge-received', (data) => {
        if(confirm(`${data.from} seni ARENA'DA par√ßalamak istiyor! Kabul m√º?`)) {
            window.location.href = "/arena?opponent=" + data.from;
        }
    });
</script>
</body>
</html>
