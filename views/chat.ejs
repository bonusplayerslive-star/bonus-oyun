<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJÄ°K Ä°LETÄ°ÅÄ°M MERKEZÄ°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --neon-blue: #00f3ff; 
            --neon-red: #ff003c; 
            --neon-green: #39FF14; 
            --terminal-dark: #0a0b0c;
            --panel-bg: rgba(10, 11, 12, 0.98);
        }

        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            color: #e0e0e0; 
            font-family: 'Rajdhani', sans-serif; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .header-status { 
            flex-shrink: 0;
            padding: 12px 15px; 
            background: linear-gradient(90deg, #000 0%, #111 50%, #000 100%);
            border-bottom: 2px solid var(--neon-green);
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
            z-index: 10;
        }

        .status-item { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; letter-spacing: 1px; }
        .val-neon { color: var(--neon-green); text-shadow: 0 0 5px var(--neon-green); }

        .chat-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            min-height: 0;
            position: relative;
        }

        #chatMessages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: rgba(0, 0, 0, 0.7); 
            border: 1px solid rgba(57, 255, 20, 0.15); 
            border-radius: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .msg-entry { 
            margin-bottom: 8px; 
            padding: 8px 12px; 
            background: rgba(255, 255, 255, 0.03); 
            border-left: 3px solid transparent;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }

        .msg-entry:hover { background: rgba(57, 255, 20, 0.05); border-left-color: var(--neon-green); }
        
        .sender-tag { 
            color: #FFFF00; 
            font-weight: 700; 
            cursor: pointer; 
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            margin-right: 8px;
        }

        #userActionPanel { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 320px;
            background: var(--panel-bg); 
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.4);
            padding: 25px; 
            z-index: 4000;
        }

        .btn-action {
            width: 100%; padding: 14px; margin-bottom: 10px;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
            text-transform: uppercase; border-radius: 0; transition: 0.3s;
        }
        .btn-gift { border: 1px solid var(--neon-red); color: var(--neon-red); background: transparent; }
        .btn-fight { border: 1px solid var(--neon-blue); color: var(--neon-blue); background: transparent; }
        .btn-meeting { border: 1px solid #ffc107; color: #ffc107; background: transparent; }

        .input-footer { 
            flex-shrink: 0;
            padding: 15px; 
            background: #000; 
            border-top: 1px solid #222;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        
        .terminal-input {
            background: #0a0a0a !important;
            border: 1px solid #333 !important;
            color: var(--neon-green) !important;
            font-family: 'Courier New', monospace;
            border-radius: 0;
        }
        .btn-send { background: var(--neon-green) !important; color: #000 !important; font-weight: bold; border-radius: 0; }
    </style>
</head>
<body>

<div class="header-status d-flex justify-content-between">
    <div class="status-item text-muted">USER: <span class="val-neon"><%= user.nickname %></span></div>
    <div class="status-item text-muted">BPL: <span id="myBpl" class="text-warning"><%= user.bpl %></span></div>
</div>

<div class="chat-container">
    <div id="chatMessages">
        <div class="msg-entry">
            <span class="sender-tag" style="color:var(--neon-blue)">[SÄ°STEM]:</span>
            <span class="text-info small">BaÄŸlantÄ± ÅŸifreli. Hedef seÃ§mek iÃ§in kullanÄ±cÄ± adÄ±na tÄ±klayÄ±n.</span>
        </div>
    </div>
</div>

<div id="userActionPanel">
    <h5 id="selectedUserLabel" class="text-center text-white mb-4 fs-6">HEDEF SEÃ‡Ä°LDÄ°</h5>
    <button id="giftBtn" class="btn btn-action btn-gift">ğŸ LOJÄ°STÄ°K DESTEK</button>
    <button id="fightBtn" class="btn btn-action btn-fight">âš”ï¸ ARENA DAVETÄ°</button>
    <button id="meetBtn" class="btn btn-action btn-meeting">ğŸ›ï¸ KONSEY DAVETÄ°</button>
    <button onclick="closePanel()" class="btn btn-sm text-muted w-100 mt-2">Ä°PTAL</button>
</div>
<div class="message-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #444;">
    <div class="message-content">
        <strong style="color: #edb709;"><%= sender %>:</strong> 
        <span><%= text %></span>
    </div>
    <div class="message-actions">
        <button onclick="openGiftModal('<%= sender %>')" class="btn btn-sm btn-outline-success" title="Hediye GÃ¶nder">
            <i class="fas fa-gift"></i>
        </button>
        <button onclick="challengeToArena('<%= sender %>')" class="btn btn-sm btn-outline-danger" title="Arena'ya Ã‡aÄŸÄ±r">
            <i class="fas fa-swords"></i>
        </button>
        <button onclick="inviteToMeeting('<%= sender %>')" class="btn btn-sm btn-outline-warning" title="Masaya Davet Et">
            <i class="fas fa-users"></i>
        </button>
    </div>
</div>
<div class="input-footer">
    <form id="chatForm" onsubmit="sendMessage(); return false;">
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control terminal-input" placeholder="Komut satÄ±rÄ±..." autocomplete="off">
            <button type="submit" class="btn btn-send px-3"><i class="fas fa-paper-plane"></i></button>
        </div>
    </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io(); 
    const myNick = "<%= user.nickname %>";
    let myBpl = parseInt("<%= user.bpl %>");
    let selectedUser = "";

    // 1. KullanÄ±cÄ± MenÃ¼sÃ¼ ve Yetki KontrolÃ¼
    function openUserMenu(nick) {
        if(nick === myNick || nick === "SÄ°STEM" || nick === "Bilinmeyen") return;
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = "HEDEF: " + nick;
        document.getElementById('userActionPanel').style.display = 'block';
        
        const giftBtn = document.getElementById('giftBtn');
        // VIP Hediye SÄ±nÄ±rÄ±: 5500 + GÃ¶nderilecek Miktar
        if(myBpl < 5550) {
            giftBtn.disabled = true;
            giftBtn.classList.add('opacity-50');
            giftBtn.innerHTML = "<small>BPL Yetersiz (Min 5550)</small>";
        } else {
            giftBtn.disabled = false;
            giftBtn.classList.remove('opacity-50');
            giftBtn.innerHTML = "ğŸ LOJÄ°STÄ°K DESTEK";
            giftBtn.onclick = () => sendBplGift(nick);
        }

        document.getElementById('fightBtn').onclick = () => challengeToFight(nick);
        document.getElementById('meetBtn').onclick = () => inviteToMeeting(nick);
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    // 2. VIP Hediye Ä°ÅŸlemi
    function sendBplGift(nick) {
        Swal.fire({
            title: 'DESTEK MÄ°KTARI',
            background: '#0a0b0c', color: '#fff',
            showConfirmButton: false,
            html: `
                <div class="d-grid gap-2">
                    <button onclick="executeGift('${nick}', 50)" class="btn btn-outline-warning">50 BPL</button>
                    <button onclick="executeGift('${nick}', 100)" class="btn btn-outline-warning">100 BPL</button>
                    <button onclick="executeGift('${nick}', 150)" class="btn btn-outline-warning">150 BPL</button>
                </div>`
        });
    }

    function executeGift(nick, amount) {
        if (myBpl - amount < 5500) {
            Swal.fire({ icon: 'error', title: 'Limit', text: 'Bakiyeniz 5500 altÄ±na dÃ¼ÅŸemez!', background: '#0a0a0a', color: '#fff' });
            return;
        }
        socket.emit('send-gift-vip', { targetNick: nick, amount: amount, room: "GENEL_KONSEY" });
        Swal.close();
        closePanel();
    }

    // 3. DÃ¼ello Daveti GÃ¶nder
    function challengeToFight(nick) {
        socket.emit('send-challenge', { target: nick });
        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'DÃ¼ello daveti iletildi.', showConfirmButton: false, timer: 2000 });
        closePanel();
    }

    // 4. Sohbet Ä°ÅŸlemleri
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(text) {
            socket.emit('chat-message', { text: text });
            input.value = "";
        }
    }

    // --- SOCKET DÄ°NLEYÄ°CÄ°LERÄ° ---

    // Yeni Mesaj AlÄ±ndÄ±ÄŸÄ±nda
    socket.on('new-message', (data) => {
        const box = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = "msg-entry";
        div.innerHTML = `<span class="sender-tag" onclick="openUserMenu('${data.sender}')">${data.sender}:</span> 
                         <span class="text-light">${data.text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    // Bakiye GÃ¼ncellemesi (Hediye geldiÄŸinde veya gittiÄŸinde)
    socket.on('update-bpl', (newBpl) => {
        myBpl = newBpl;
        document.getElementById('myBpl').innerText = myBpl;
    });

    // DÃ¼ello Daveti GeldiÄŸinde
    socket.on('challenge-received', (data) => {
        if(data.target === myNick) {
            Swal.fire({
                title: 'DÃœELLO TALEBÄ°!',
                text: `${data.from} sana meydan okuyor! Kabul ediyor musun?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#00f3ff',
                cancelButtonColor: '#ff003c',
                confirmButtonText: 'KABUL ET',
                cancelButtonText: 'REDDET',
                background: '#0a0b0c',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Arena sayfasÄ±na rakip ve oda bilgisiyle git
                    window.location.href = `/arena?opponent=${data.from}&room=${data.room}`;
                }
            });
        }
    });

    // Klavye aÃ§Ä±ldÄ±ÄŸÄ±nda mesajlarÄ±n en alta kaymasÄ± iÃ§in
    document.getElementById('messageInput').addEventListener('focus', () => {
        setTimeout(() => { 
            const box = document.getElementById('chatMessages');
            box.scrollTop = box.scrollHeight; 
        }, 300);
    });

    // Panel dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapat
    window.onclick = (e) => { 
        const panel = document.getElementById('userActionPanel');
        if(e.target === panel) closePanel(); 
    };


// Konsey (Ã–zel Oda) Daveti GÃ¶nder
function inviteToMeeting(nick) {
    socket.emit('send-meeting-invite', { target: nick });
    Swal.fire({ 
        toast: true, 
        position: 'top-end', 
        icon: 'success', 
        title: 'Konsey daveti gÃ¶nderildi.', 
        showConfirmButton: false, 
        timer: 2000 
    });
    closePanel();
}

// Konsey Daveti GeldiÄŸinde Dinle
socket.on('meeting-request', (data) => {
    if(data.target === myNick) {
        Swal.fire({
            title: 'KONSEY Ã‡AÄRISI',
            text: `${data.from} seni Ã¶zel bir gÃ¶rÃ¼ÅŸmeye Ã§aÄŸÄ±rÄ±yor.`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'KATIL',
            cancelButtonText: 'REDDET',
            background: '#0a0b0c', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) {
                window.location.href = `/private-chat?room=${data.room}&with=${data.from}`;
            }
        });
    }
});
// Arena Meydan Okuma
function challengeToArena(targetNick) {
    if(confirm(targetNick + " isimli oyuncuya ARENA dÃ¼ellosu gÃ¶ndermek istiyor musun?")) {
        socket.emit('arena-invite-request', { to: targetNick, from: userNickname });
        alert("Meydan okuma gÃ¶nderildi!");
    }
}

// Hediye GÃ¶nderme (BPL)
function openGiftModal(targetNick) {
    const amount = prompt(targetNick + " kullanÄ±cÄ±sÄ±na ne kadar BPL gÃ¶ndermek istersin?");
    if (amount && !isNaN(amount)) {
        socket.emit('send-gift-bpl', { toNickname: targetNick, amount: amount });
        alert("Hediye gÃ¶nderiliyor...");
    }
}

// ToplantÄ± (BeÅŸgen Masa) Daveti
function inviteToMeeting(targetNick) {
    if(confirm(targetNick + " kullanÄ±cÄ±sÄ±nÄ± Ã¶zel masana davet etmek istiyor musun?")) {
        // Burada kullanÄ±cÄ±nÄ±n mevcut bir odasÄ± olmalÄ± (50 BPL ile aÃ§tÄ±ÄŸÄ±)
        socket.emit('send-private-invite', { to: targetNick, roomId: myCurrentRoomId });
        alert("Masa daveti iletildi!");
    }
}
</script>
</body>
</html>


