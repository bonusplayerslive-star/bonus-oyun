<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL | STRATEJƒ∞K ƒ∞LETƒ∞≈ûƒ∞M MERKEZƒ∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --neon-blue: #00f3ff; --neon-red: #ff003c; --neon-green: #39FF14; 
            --terminal-dark: #0a0b0c; --panel-bg: rgba(10, 11, 12, 0.98);
        }

        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            color: #e0e0e0; font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0;
        }

        /* √úST STATUS BAR */
        .header-status { 
            height: 60px; padding: 0 20px; background: #000; border-bottom: 2px solid var(--neon-green);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        .status-item { font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 1px; }

        /* ANA ƒ∞√áERƒ∞K ALANI */
        .main-content { display: flex; flex: 1; height: calc(100vh - 140px); overflow: hidden; }

        /* SOL USER Lƒ∞STESƒ∞ */
        .online-sidebar {
            width: 90px; background: rgba(0, 0, 0, 0.8); border-right: 1px solid #222;
            display: flex; flex-direction: column; align-items: center; padding: 15px 0;
            overflow-y: auto; scrollbar-width: none;
        }
        .online-sidebar::-webkit-scrollbar { display: none; }

        .user-node {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
            cursor: pointer; transition: 0.3s; width: 100%;
        }
        .avatar-circle {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon-blue);
            background: #111; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .online-status {
            position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px;
            background: var(--neon-green); border-radius: 50%; border: 2px solid #000;
        }
        .node-name { font-size: 0.65rem; color: #aaa; margin-top: 5px; text-transform: uppercase; text-align: center; }

        /* CHAT PENCERESƒ∞ */
        .chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); }
        #chatMessages { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .msg-entry { margin-bottom: 5px; padding: 10px; background: rgba(255,255,255,0.03); border-left: 3px solid var(--neon-blue); }
        .sender-tag { color: #FFFF00; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; font-size: 0.75rem; margin-right: 10px; }

        /* FHD+ EKRANLARDA G√úVENLƒ∞ INPUT ALANI */
        .input-footer { 
            background: #000; padding: 15px; border-top: 1px solid #222;
            /* iPhone alt barƒ± ve FHD+ telefonlar i√ßin koruma */
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .terminal-input { 
            background: #0a0a0a !important; border: 1px solid #333 !important; 
            color: var(--neon-green) !important; font-family: 'Courier New', monospace; 
            height: 50px; font-size: 16px; /* 16px iPhone zoom hatasƒ±nƒ± √∂nler */
        }
        .btn-send { background: var(--neon-green) !important; color: #000 !important; font-weight: bold; padding: 0 25px; }

        /* AKSƒ∞YON PANELƒ∞ */
        #userActionPanel { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: var(--panel-bg); border: 2px solid var(--neon-blue);
            padding: 25px; z-index: 5000; box-shadow: 0 0 40px rgba(0,0,0,0.9); text-align: center;
        }
        #userActionPanel button { 
            width: 100%; margin-bottom: 10px; padding: 10px; 
            font-family: 'Orbitron'; font-size: 0.8rem; background: transparent;
        }
        #giftBtn { border: 1px solid var(--neon-red); color: var(--neon-red); }
        #fightBtn { border: 1px solid var(--neon-blue); color: var(--neon-blue); }
        #meetBtn { border: 1px solid #ffc107; color: #ffc107; }

        @media (max-width: 768px) {
            .online-sidebar { width: 75px; }
            .avatar-circle { width: 45px; height: 45px; }
        }
    </style>
</head>
<body>

<div class="header-status">
    <div class="status-item text-muted">USER: <span class="val-neon" style="color:var(--neon-blue)"><%= user.nickname %></span></div>
    <div class="status-item text-muted">CREDITS: <span id="myBpl" class="text-warning"><%= user.bpl %></span> BPL</div>
    <div class="status-item text-muted">STATUS: <span id="peer-status" class="text-success small">AKTƒ∞F</span></div>
</div>

<div class="main-content">
    <div class="online-sidebar" id="onlineUsersList"></div>

    <div class="chat-window">
        <div id="chatMessages">
            <div class="msg-entry">
                <span class="sender-tag">[Sƒ∞STEM]:</span>
                <span class="text-info">Komuta merkezi aktif.</span>
            </div>
        </div>
    </div>
</div>

<div class="input-footer">
    <div class="input-group">
        <input type="text" id="messageInput" class="form-control terminal-input" placeholder="Komut girin..." autocomplete="off">
        <button onclick="sendMessage()" class="btn btn-send"><i class="fas fa-bolt me-2"></i>G√ñNDER</button>
    </div>
</div>

<div id="userActionPanel">
    <h5 id="selectedUserLabel" class="mb-4 text-white" style="font-family: 'Orbitron'; font-size: 1rem;">HEDEF</h5>
    <button id="giftBtn">üéÅ LOJƒ∞STƒ∞K DESTEK</button>
    <button id="fightBtn">‚öîÔ∏è ARENA D√úELLO (-50)</button>
    <button id="meetBtn">üèõÔ∏è √ñZEL ODA (-30)</button>
    <button onclick="closePanel()" style="border: none; color: #666; font-size: 0.7rem; background:transparent;">[ ƒ∞PTAL ]</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io(); 
    const myNick = "<%= user.nickname %>";
    let myBpl = <%= user.bpl %>;
    let selectedUser = "";

    // 1. ONLINE LISTESI G√úNCELLEME
    socket.on('update-user-list', (users) => {
        const listContainer = document.getElementById('onlineUsersList');
        listContainer.innerHTML = ''; 
        users.forEach(u => {
            if(u.nickname !== myNick) {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-node';
                userDiv.onclick = () => openUserMenu(u.nickname);
                userDiv.innerHTML = `
                    <div class="avatar-circle">
                        <img src="/caracter/page/logo.jpeg" alt="user">
                        <div class="online-status"></div>
                    </div>
                    <div class="node-name">${u.nickname}</div>
                `;
                listContainer.appendChild(userDiv);
            }
        });
    });

    // 2. PANEL FONKSIYONLARI
    function openUserMenu(nick) {
        selectedUser = nick;
        document.getElementById('selectedUserLabel').innerText = nick;
        document.getElementById('userActionPanel').style.display = 'block';
        
        document.getElementById('giftBtn').onclick = () => { closePanel(); sendGift(nick); };
        document.getElementById('fightBtn').onclick = () => { handleInvite(nick, 'arena', 50); };
        document.getElementById('meetBtn').onclick = () => { handleInvite(nick, 'meeting', 30); };
    }

    function closePanel() { document.getElementById('userActionPanel').style.display = 'none'; }

    // 3. HEDƒ∞YE TRANSFERƒ∞
    function sendGift(nick) {
        Swal.fire({
            title: 'LOJƒ∞STƒ∞K TRANSFER',
            text: `${nick} i√ßin BPL miktarƒ± (%25 transfer √ºcreti kesilir)`,
            input: 'number',
            background: '#0a0b0c', color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'G√ñNDER'
        }).then((result) => {
            if (result.isConfirmed) {
                const amount = parseInt(result.value);
                if(isNaN(amount) || amount <= 0) return;
                socket.emit('transfer-bpl', { to: nick, amount: amount });
            }
        });
    }

    // 4. DAVET G√ñNDERME
    function handleInvite(nick, type, cost) {
        closePanel();
        socket.emit('send-invite', { to: nick, type: type, cost: cost });
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Davet iletildi', showConfirmButton: false, timer: 1500 });
    }

    // 5. DAVET ALMA
    socket.on('receive-invite', (data) => {
        Swal.fire({
            title: data.type === 'arena' ? '‚öîÔ∏è ARENA D√úELLO!' : 'üèõÔ∏è √ñZEL ODA DAVETƒ∞!',
            text: `${data.from} seni √ßaƒüƒ±rƒ±yor.`,
            showCancelButton: true,
            confirmButtonText: 'KATIL',
            cancelButtonText: 'REDDET',
            background: '#0a0a0a', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) {
                window.location.href = data.type === 'arena' ? `/arena?room=${data.roomId}` : `/meeting?room=${data.roomId}`;
            }
        });
    } );

    // 6. CHAT MESAJLA≈ûMA (Arena Uyumlu)
    function sendMessage() {
        const input = document.getElementById('messageInput');
        if(input.value.trim()) {
            // Global chatte olduƒüumuz i√ßin room g√∂ndermiyoruz (veya 'GENEL' g√∂nderiyoruz)
            socket.emit('chat-message', { text: input.value, room: null });
            input.value = '';
        }
    }

// chat.ejs i√ßindeki dinleyici
socket.on('new-message', (data) => {
    // SADECE 'GENEL' etiketli mesajlarƒ± ana ekrana bas
    if (data.room === 'GENEL') {
        const box = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = "msg-entry";
        div.innerHTML = `<span class="sender-tag" onclick="openUserMenu('${data.sender}')">${data.sender}:</span> 
                         <span class="text-light">${data.text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
});

    socket.on('update-bpl', (newBpl) => {
        myBpl = newBpl;
        document.getElementById('myBpl').innerText = newBpl;
    });


// Davet ƒ∞steƒüi Penceresi
socket.on('receive-invite-request', (data) => {
    const onay = confirm(`${data.from} seni √∂zel odaya davet ediyor. Katƒ±lmak ister misin?`);
    
    if (onay) {
        // Sunucuya "Kabul ettim, bizi odaya sok" de
        socket.emit('accept-invite', { 
            from: data.from, 
            roomId: data.roomId, 
            type: data.type 
        });
    }
});

    socket.on('redirect-to-room', (url) => { window.location.href = url; });

    document.getElementById('messageInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>


