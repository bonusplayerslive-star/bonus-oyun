<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BPL - Stratejik Operasyon Merkezi</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --neon-turq: #00f2ff; 
            --neon-red: #ff004c; 
            --neon-yellow: #ffcc00; 
            --bg-dark: #050a0f; 
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--bg-dark); 
            color: #fff; 
            font-family: 'Rajdhani', sans-serif; 
            height: 100vh; 
            height: -webkit-fill-available;
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            padding: var(--safe-top) 10px var(--safe-bottom) 10px;
        }

        /* Mobil ve Desktop Uyumlu Layout */
        .main-layout { 
            display: flex; 
            width: 100%; 
            gap: 15px; 
            flex: 1; 
            margin-top: 10px; 
            overflow: hidden; 
        }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .users-section { order: -1; flex: 0.4 !important; }
        }

        .chat-section { 
            flex: 3; 
            border: 2px solid var(--neon-turq); 
            border-radius: 15px; 
            box-shadow: 0 0 15px rgba(0,242,255,0.2); 
            display: flex; 
            flex-direction: column; 
            background: rgba(0,0,0,0.8);
        }

        .users-section { 
            flex: 1.2; 
            border: 1px solid rgba(0,242,255,0.3); 
            border-radius: 15px; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            padding: 15px;
            overflow-y: auto;
        }

        #chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            scrollbar-width: thin;
        }

        .msg-line { 
            margin-bottom: 8px; 
            padding: 8px 12px; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.05); 
            border-left: 3px solid var(--neon-turq);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .user-item { 
            padding: 10px; 
            margin-bottom: 10px;
            border: 1px solid rgba(0,242,255,0.1);
            border-radius: 10px;
            transition: 0.3s;
        }

        .user-item:hover { background: rgba(0,242,255,0.05); }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 8px; }
        
        .btn-action { 
            font-size: 8px; 
            padding: 5px 2px; 
            border-radius: 4px; 
            font-family: 'Orbitron'; 
            border: none; 
            color: #fff; 
            text-transform: uppercase;
        }

        .btn-arena { background: var(--neon-red); }
        .btn-meeting { background: var(--neon-yellow); color: #000; }
        .btn-gift { background: #8a2be2; } /* Hediye butonu */

        .input-area { 
            padding: 15px; 
            display: flex; 
            gap: 10px; 
            background: rgba(0,0,0,0.5); 
            border-top: 1px solid rgba(0,242,255,0.2); 
        }

        .neon-input { 
            flex: 1; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid var(--neon-turq); 
            color: #fff; 
            border-radius: 20px; 
            padding: 10px 20px; 
            outline: none;
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="chat-section">
        <div class="p-3 border-bottom border-info d-flex justify-content-between align-items-center">
            <div>
                <span style="color:var(--neon-turq); font-family:'Orbitron'; font-weight: bold;">OPERASYON KANALI</span>
                <div id="bakiye-display" style="font-size: 11px; color: var(--neon-yellow);">
                    BAKİYE: <span id="current-bpl"><%= user.bpl %></span> BPL
                </div>
            </div>
            <a href="/profil" class="btn btn-outline-info btn-sm">ÜS MERKEZİ</a>
        </div>
        
        <div id="chat-messages"></div>

        <div class="input-area">
            <input type="text" id="chat-input" class="neon-input" placeholder="Mesaj yazın..." autocomplete="off">
            <button onclick="sendMessage()" class="btn btn-info rounded-circle">➤</button>
        </div>
    </div>

    <div class="users-section">
        <h6 class="text-center border-bottom pb-2 mb-3" style="color:var(--neon-turq); font-family:'Orbitron'">AKTİF KOMUTANLAR</h6>
        <div id="user-list"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const socket = io();
    const myNick = "<%= user.nickname %>";
    let myBPL = parseInt("<%= user.bpl %>");

    // Mesaj Gönderimi
    function sendMessage() {
        const text = document.getElementById('chat-input').value.trim();
        if (text) {
            socket.emit('chat-message', { text, sender: myNick });
            document.getElementById('chat-input').value = '';
        }
    }

    // Kullanıcı Listesi Güncelleme (Hediye ve Davet Butonları Dahil)
    socket.on('update-user-list', (users) => {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        users.forEach(u => {
            if(u.nickname === myNick) return;
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <span class="user-nick">${u.nickname}</span>
                <div class="action-btns">
                    <button class="btn-action btn-arena" onclick="invite('arena', '${u.nickname}')">ARENA</button>
                    <button class="btn-action btn-meeting" onclick="invite('meeting', '${u.nickname}')">MEET(50)</button>
                    <button class="btn-action btn-gift" onclick="sendGift('${u.nickname}')">HEDİYE</button>
                </div>
            `;
            userList.appendChild(div);
        });
    });

    // 1. HEDİYE SİSTEMİ (%30 Kesinti)
    function sendGift(target) {
        if (myBPL < 5500) {
            return Swal.fire('Yetersiz Fon', 'Hediye göndermek için en az 5500 BPL gereklidir!', 'warning');
        }
        
        Swal.fire({
            title: 'HEDİYE GÖNDER',
            text: `${target} kullanıcısına ne kadar BPL göndereceksin? (%30 Vergi alınır)`,
            input: 'number',
            background: '#050a0f', color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'GÖNDER'
        }).then((res) => {
            if (res.isConfirmed && res.value > 0) {
                socket.emit('process-gift', { target, amount: res.value });
            }
        });
    }

    // 2. DAVET SİSTEMİ (Arena & Meeting)
    function invite(type, target) {
        let cost = type === 'meeting' ? 50 : 0;
        if (myBPL < cost) return Swal.fire('Hata', 'Yetersiz BPL!', 'error');

        socket.emit('send-bpl-invite', { type, target, cost });
    }

    // Davet Alma
    socket.on('receive-bpl-invite', (data) => {
        Swal.fire({
            title: 'OPERASYON DAVETİ',
            text: `${data.from} seni ${data.type.toUpperCase()} moduna çağırıyor!`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'KATIL',
            cancelButtonText: 'REDDET'
        }).then((res) => {
            if (res.isConfirmed) {
                socket.emit('accept-bpl-invite', { type: data.type, from: data.from, roomId: data.roomId });
            }
        });
    });

    // Yönlendirme
    socket.on('redirect-to-room', (data) => {
        // Arena için hızlı başlangıç parametresi ekliyoruz
        const fastStart = data.type === 'arena' ? '&fast=true' : '';
        window.location.href = `/${data.type}?room=${data.roomId}&role=${data.role}${fastStart}`;
    });

    // Mesaj Alma
    socket.on('new-chat-message', (data) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg-line';
        msgDiv.innerHTML = `<span class="msg-sender">${data.sender}:</span> <span>${data.text}</span>`;
        const container = document.getElementById('chat-messages');
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    });

    // Bakiye Güncelleme (Hediye gelince veya harcama yapınca)
    socket.on('update-balance', (newBalance) => {
        myBPL = newBalance;
        document.getElementById('current-bpl').innerText = newBalance;
    });
</script>
</body>
</html>
