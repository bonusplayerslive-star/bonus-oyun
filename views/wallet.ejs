<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPL | Cüzdan & Varlık Yönetimi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon-green: #39FF14; --neon-red: #ff003c; --dark-bg: #0a0a0a; }
        body { background: var(--dark-bg); color: #fff; font-family: 'Courier New', monospace; padding-top: 20px; }
        
        .neon-border { border: 1px solid var(--neon-green); box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); background: rgba(0,0,0,0.9); border-radius: 15px; }
        .text-neon { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); }
        .btn-neon { border: 1px solid var(--neon-green); color: var(--neon-green); background: transparent; transition: 0.3s; font-weight: bold; text-transform: uppercase; }
        .btn-neon:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 25px var(--neon-green); }
        
        .bep20-alert { background: rgba(255, 0, 60, 0.1); border: 2px dashed var(--neon-red); color: #fff; padding: 15px; border-radius: 10px; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 5px var(--neon-red); } 50% { box-shadow: 0 0 20px var(--neon-red); } 100% { box-shadow: 0 0 5px var(--neon-red); } }
        
        .asset-card { background: linear-gradient(145deg, #0f0f0f, #1a1a1a); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; transition: 0.4s; position: relative; }
        .asset-card:hover { border-color: var(--neon-green); transform: translateY(-10px); }
        .asset-img { height: 160px; width: 100%; object-fit: cover; filter: grayscale(40%); transition: 0.5s; }
        .asset-card:hover .asset-img { filter: grayscale(0%); }
        
        input.form-control { background: #111 !important; border: 1px solid #333 !important; color: #fff !important; }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 p-4 neon-border">
        <div>
            <h2 class="text-neon m-0"><i class="fas fa-wallet me-2"></i>WALLET & ASSETS</h2>
            <small class="text-muted">Merkeziyetsiz Varlık Yönetim Paneli</small>
        </div>
        <div class="text-end">
            <span class="h4 d-block mb-1 text-warning"><%= user.bpl.toLocaleString() %> BPL</span>
            <a href="/profil" class="btn btn-sm btn-outline-light"><i class="fas fa-arrow-left me-1"></i> Üsse Dön</a>
        </div>
    </div>

    <div class="bep20-alert mb-5 text-center">
        <h5 class="m-0 fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> PROTOKOL UYARISI: SADECE BEP20</h5>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card p-4 neon-border h-100">
                <h4 class="text-info mb-4 border-bottom border-info pb-2">Finansal Altyapı</h4>
                <div class="mb-4">
                    <label class="form-label">Geri Ödeme Adresin (BEP20)</label>
                    <input type="text" id="usdtAddress" class="form-control" value="<%= user.bnb_address || '' %>" placeholder="0x...">
                    <button onclick="saveAddress()" class="btn btn-neon mt-3 w-100">KAYDET</button>
                </div>
                <div class="mt-auto pt-3">
                    <a href="/payment" class="btn btn-warning w-100 py-3 fw-bold">BPL PAKETİ AL</a>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-4 neon-border h-100" style="border-color: var(--neon-red)">
                <h4 class="text-danger mb-4 border-bottom border-danger pb-2">BPL Tasfiye</h4>
                <div class="mb-3">
                    <label class="form-label text-white-50">Çekilecek Miktar (BPL)</label>
                    <input type="number" id="withdrawInput" class="form-control bg-dark text-white border-secondary" placeholder="Miktar girin...">
                    <small class="text-muted mt-1 d-block" style="font-size: 0.75rem;">
                        * Sadece 5.000 BPL üzerindeki tutarlar çekilebilir. <br>
                        * %25 Tasfiye komisyonu uygulanır.
                    </small>
                </div>
                <button onclick="handleWithdraw()" id="withdrawBtn" class="btn btn-danger w-100 py-3 fw-bold">TALEBİ İLET</button>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12 text-center mb-4">
            <h3 class="text-neon">ASSET INVENTORY</h3>
        </div>

        <div class="row justify-content-center">
            <% if(!user.inventory || user.inventory.length === 0) { %>
                <div class="col-md-8 text-center text-muted py-5 border rounded border-secondary">
                    <p>Envanter boş.</p>
                </div>
            <% } else { %>
                <% 
                    // Resim isimlerini GitHub'daki gibi (Baş harfi büyük) düzelttik
                    const animalTranslate = {
                        "YILAN": "Snake", "SNAKE": "Snake", "KAPLAN": "Tiger", "TIGER": "Tiger",
                        "AYI": "Bear", "BEAR": "Bear", "TIMSAH": "Crocodile", "CROCODILE": "Crocodile",
                        "KARTAL": "Eagle", "EAGLE": "Eagle", "KURT": "Wolf", "WOLF": "Wolf",
                        "ASLAN": "Lion", "LION": "Lion", "GORIL": "Gorilla", "GORILLA": "Gorilla",
                        "GERGEDAN": "Rhino", "RHINO": "Rhino", "GÖKDOĞAN": "Falcon", "FALCON": "Falcon"
                    };
                %>
                <% user.inventory.forEach((item) => { 
                    let itemName = item.name || item;
                    let upperName = itemName.toUpperCase();
                    let engName = animalTranslate[upperName] || "Logo";
                    let isPremium = ['ASLAN','LION','GERGEDAN','RHINO','GORIL','GORILLA','KAPLAN','TIGER'].includes(upperName);
                    let sellPrice = isPremium ? 3500 : 700;
                %>
                    <div class="col-6 col-lg-3 mb-4">
                        <div class="asset-card h-100 text-center pb-3">
                            <img src="/caracter/profile/<%= engName %>.jpg" onerror="this.src='/caracter/page/logo.jpeg'" class="asset-img">
                            <div class="p-3">
                                <h6 class="text-white text-uppercase"><%= itemName %></h6>
                                <p class="text-warning fw-bold"><%= sellPrice %> BPL</p>
                                
                                <% if(user.inventory.length > 1) { %>
                                    <button onclick="sellAnimal('<%= itemName %>', <%= sellPrice %>)" class="btn btn-sm btn-outline-danger w-100">SAT</button>
                                <% } else { %>
                                    <span class="badge bg-secondary w-100">ANA VARLIK</span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Cüzdan Adresi Kaydetme (Modelinle tam uyumlu)
    async function saveAddress() {
        const address = document.getElementById('usdtAddress').value.trim();

        if (!address.startsWith('0x') || address.length < 40) {
            return Swal.fire('Hata', 'Lütfen geçerli bir BEP20 adresi girin.', 'warning');
        }

        try {
            const response = await fetch('/api/save-wallet-address', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Modelindeki bnb_address alanına gönderiyoruz
                body: JSON.stringify({ bnb_address: address })
            });
            
            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    title: 'Başarılı',
                    text: 'Cüzdan adresiniz kaydedildi.',
                    icon: 'success',
                    confirmButtonColor: '#39FF14'
                }).then(() => location.reload());
            } else {
                Swal.fire('Hata', data.msg || 'İşlem başarısız.', 'error');
            }
        } catch (err) {
            Swal.fire('Hata', 'Sunucu bağlantısı kurulamadı.', 'error');
        }
    }

    // Para Çekme Talebi
    async function handleWithdraw() {
        const amount = document.getElementById('withdrawInput').value;
        const btn = document.getElementById('withdrawBtn');

        if (!amount || amount <= 0) {
            return Swal.fire('Hata', 'Lütfen geçerli bir miktar girin.', 'warning');
        }

        btn.disabled = true;
        btn.innerText = "İŞLENİYOR...";

        try {
            const response = await fetch('/api/withdraw-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseInt(amount) })
            });
            
            const data = await response.json();

            if (data.success) {
                Swal.fire('BAŞARILI', data.msg, 'success').then(() => window.location.reload());
            } else {
                Swal.fire('Hata', data.error || data.msg, 'error');
                btn.disabled = false;
                btn.innerText = "TALEBİ İLET";
            }
        } catch (err) {
            Swal.fire('Hata', 'Sunucu bağlantısı kurulamadı.', 'error');
            btn.disabled = false;
        }
    }

    // Hayvan Satma
    async function sellAnimal(name, sellPrice) {
        const result = await Swal.fire({
            title: 'EMİN MİSİN?',
            text: `${name} karakterini ${sellPrice} BPL karşılığında satmak istiyor musun?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Evet, Sat!',
            cancelButtonText: 'Vazgeç',
            background: '#050505',
            color: '#fff'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetch('/api/sell-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemName: name })
                });
                const data = await res.json();
                if (data.success) {
                    Swal.fire('SATILDI!', 'BPL hesabına eklendi.', 'success').then(() => location.reload());
                } else {
                    Swal.fire('Hata', data.error, 'error');
                }
            } catch (err) {
                Swal.fire('Hata', 'Sunucu hatası!', 'error');
            }
        }
    }
</script>
</body>
</html>
