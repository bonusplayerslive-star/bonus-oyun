// --- NODEMAILER AYARI (En Ã¼ste require'larÄ±n yanÄ±na ekle) ---
const nodemailer = require('nodemailer');

const transporter = nodemailer.createTransport({
    service: 'gmail', // veya .env iÃ§indeki bilgiler
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
    }
});

// --- 1. COMMAND CENTER (CONTACT) ROTASI ---
app.post('/contact', async (req, res) => {
    try {
        const { email, note } = req.body;
        // 1. Mongo'ya Kaydet (Log modelini kullanabilirsin veya yeni Contact modeli)
        const newLog = new Log({
            userId: req.session.userId || null,
            action: 'CONTACT_FORM',
            details: `Email: ${email}, Message: ${note}`
        });
        await newLog.save();

        // 2. Mail GÃ¶nder (Opsiyonel)
        console.log(`ðŸ“© Yeni Destek MesajÄ±: ${email} -> ${note}`);
        
        res.send('<script>alert("Transmission Received! We will contact you."); window.location.href="/";</script>');
    } catch (e) {
        console.error("Contact Error:", e);
        res.status(500).send("Command Center Offline!");
    }
});

// --- 2. FORGOT PASSWORD ROTASI ---
app.post('/forgot-password', async (req, res) => {
    try {
        const { email } = req.body;
        const user = await User.findOne({ email });

        if (!user) {
            return res.send('<script>alert("User not found!"); window.location.href="/";</script>');
        }

        // Åžifreyi mail atÄ±yoruz (GÃ¼venlik iÃ§in normalde link gÃ¶nderilir ama senin isteÄŸin Ã¼zerine ÅŸifreyi atÄ±yoruz)
        const mailOptions = {
            from: process.env.EMAIL_USER,
            to: email,
            subject: 'BPL Ecosystem - Password Recovery',
            text: `Your current password is: ${user.password} \n\nPlease change it after login.`
        };

        await transporter.sendMail(mailOptions);
        res.send('<script>alert("Password sent to your email!"); window.location.href="/";</script>');
    } catch (e) {
        console.error("Forgot Pass Error:", e);
        res.send('<script>alert("Mail System Error!"); window.location.href="/";</script>');
    }
});
